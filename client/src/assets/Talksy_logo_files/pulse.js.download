(()=>{var e={682:e=>{var t=function(e){null==e&&(e=(new Date).getTime()),this.N=624,this.M=397,this.MATRIX_A=2567483615,this.UPPER_MASK=2147483648,this.LOWER_MASK=2147483647,this.mt=new Array(this.N),this.mti=this.N+1,e.constructor==Array?this.init_by_array(e,e.length):this.init_seed(e)};t.prototype.init_seed=function(e){for(this.mt[0]=e>>>0,this.mti=1;this.mti<this.N;this.mti++){e=this.mt[this.mti-1]^this.mt[this.mti-1]>>>30;this.mt[this.mti]=(1812433253*((4294901760&e)>>>16)<<16)+1812433253*(65535&e)+this.mti,this.mt[this.mti]>>>=0}},t.prototype.init_by_array=function(e,t){var i,r,s;for(this.init_seed(19650218),i=1,r=0,s=this.N>t?this.N:t;s;s--){var n=this.mt[i-1]^this.mt[i-1]>>>30;this.mt[i]=(this.mt[i]^(1664525*((4294901760&n)>>>16)<<16)+1664525*(65535&n))+e[r]+r,this.mt[i]>>>=0,r++,++i>=this.N&&(this.mt[0]=this.mt[this.N-1],i=1),r>=t&&(r=0)}for(s=this.N-1;s;s--){n=this.mt[i-1]^this.mt[i-1]>>>30;this.mt[i]=(this.mt[i]^(1566083941*((4294901760&n)>>>16)<<16)+1566083941*(65535&n))-i,this.mt[i]>>>=0,++i>=this.N&&(this.mt[0]=this.mt[this.N-1],i=1)}this.mt[0]=2147483648},t.prototype.random_int=function(){var e,t=new Array(0,this.MATRIX_A);if(this.mti>=this.N){var i;for(this.mti==this.N+1&&this.init_seed(5489),i=0;i<this.N-this.M;i++)e=this.mt[i]&this.UPPER_MASK|this.mt[i+1]&this.LOWER_MASK,this.mt[i]=this.mt[i+this.M]^e>>>1^t[1&e];for(;i<this.N-1;i++)e=this.mt[i]&this.UPPER_MASK|this.mt[i+1]&this.LOWER_MASK,this.mt[i]=this.mt[i+(this.M-this.N)]^e>>>1^t[1&e];e=this.mt[this.N-1]&this.UPPER_MASK|this.mt[0]&this.LOWER_MASK,this.mt[this.N-1]=this.mt[this.M-1]^e>>>1^t[1&e],this.mti=0}return e=this.mt[this.mti++],e^=e>>>11,e^=e<<7&2636928640,e^=e<<15&4022730752,(e^=e>>>18)>>>0},t.prototype.random_int31=function(){return this.random_int()>>>1},t.prototype.random_incl=function(){return this.random_int()*(1/4294967295)},t.prototype.random=function(){return this.random_int()*(1/4294967296)},t.prototype.random_excl=function(){return(this.random_int()+.5)*(1/4294967296)},t.prototype.random_long=function(){return(67108864*(this.random_int()>>>5)+(this.random_int()>>>6))*(1/9007199254740992)},e.exports=t}},t={};function i(r){var s=t[r];if(void 0!==s)return s.exports;var n=t[r]={exports:{}};return e[r](n,n.exports,i),n.exports}i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},i.d=(e,t)=>{for(var r in t)i.o(t,r)&&!i.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{"use strict";let e=null;const t=t=>{if(null!==e)return e;try{if(void 0===t||!("localStorage"in t)||!t.localStorage.getItem)return!1;const i="__test__";return t.localStorage.setItem(i,"1"),t.localStorage.removeItem(i),e=!0,!0}catch{return e=!1,!1}};let r=null;function s(e,t=!1){if(null!==r)return t?Promise.resolve(r):r;if(void 0===e||!e.indexedDB)return r=!1,!!t&&Promise.resolve(!1);try{const i=e?.indexedDB?.open("testDB");return t?new Promise(t=>{i.onsuccess=()=>{i.result.close(),e.indexedDB.deleteDatabase("testDB"),r=!0,t(!0)},i.onerror=()=>{r=!1,t(!1)}}):(i.onsuccess=()=>{i.result.close(),e.indexedDB.deleteDatabase("testDB"),r=!0},i.onerror=()=>{r=!1},!0)}catch{return r=!1,!!t&&Promise.resolve(!1)}}var n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])},n(e,t)};function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}function a(e,t,i,r){return new(i||(i=Promise))(function(s,n){function o(e){try{c(r.next(e))}catch(e){n(e)}}function a(e){try{c(r.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(o,a)}c((r=r.apply(e,t||[])).next())})}function c(e,t){var i,r,s,n={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=a(0),o.throw=a(1),o.return=a(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(a){return function(c){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;o&&(o=0,a[0]&&(n=0)),n;)try{if(i=1,r&&(s=2&a[0]?r.return:a[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,a[1])).done)return s;switch(r=0,s&&(a=[2&a[0],s.value]),a[0]){case 0:case 1:s=a;break;case 4:return n.label++,{value:a[1],done:!1};case 5:n.label++,r=a[1],a=[0];continue;case 7:a=n.ops.pop(),n.trys.pop();continue;default:if(!(s=n.trys,(s=s.length>0&&s[s.length-1])||6!==a[0]&&2!==a[0])){n=0;continue}if(3===a[0]&&(!s||a[1]>s[0]&&a[1]<s[3])){n.label=a[1];break}if(6===a[0]&&n.label<s[1]){n.label=s[1],s=a;break}if(s&&n.label<s[2]){n.label=s[2],n.ops.push(a);break}s[2]&&n.ops.pop(),n.trys.pop();continue}a=t.call(e,n)}catch(e){a=[6,e],r=0}finally{i=s=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}}Object.create;function u(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],r=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function h(e,t){var i="function"==typeof Symbol&&e[Symbol.iterator];if(!i)return e;var r,s,n=i.call(e),o=[];try{for(;(void 0===t||t-- >0)&&!(r=n.next()).done;)o.push(r.value)}catch(e){s={error:e}}finally{try{r&&!r.done&&(i=n.return)&&i.call(n)}finally{if(s)throw s.error}}return o}function l(e,t,i){if(i||2===arguments.length)for(var r,s=0,n=t.length;s<n;s++)!r&&s in t||(r||(r=Array.prototype.slice.call(t,0,s)),r[s]=t[s]);return e.concat(r||Array.prototype.slice.call(t))}function d(e){return this instanceof d?(this.v=e,this):new d(e)}function p(e,t,i){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,s=i.apply(e,t||[]),n=[];return r=Object.create(("function"==typeof AsyncIterator?AsyncIterator:Object).prototype),o("next"),o("throw"),o("return",function(e){return function(t){return Promise.resolve(t).then(e,u)}}),r[Symbol.asyncIterator]=function(){return this},r;function o(e,t){s[e]&&(r[e]=function(t){return new Promise(function(i,r){n.push([e,t,i,r])>1||a(e,t)})},t&&(r[e]=t(r[e])))}function a(e,t){try{(i=s[e](t)).value instanceof d?Promise.resolve(i.value.v).then(c,u):h(n[0][2],i)}catch(e){h(n[0][3],e)}var i}function c(e){a("next",e)}function u(e){a("throw",e)}function h(e,t){e(t),n.shift(),n.length&&a(n[0][0],n[0][1])}}function g(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,i=e[Symbol.asyncIterator];return i?i.call(e):(e=u(e),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(i){t[i]=e[i]&&function(t){return new Promise(function(r,s){(function(e,t,i,r){Promise.resolve(r).then(function(t){e({value:t,done:i})},t)})(r,s,(t=e[i](t)).done,t.value)})}}}Object.create;"function"==typeof SuppressedError&&SuppressedError;function f(e){return"function"==typeof e}function v(e){var t=e(function(e){Error.call(e),e.stack=(new Error).stack});return t.prototype=Object.create(Error.prototype),t.prototype.constructor=t,t}var b=v(function(e){return function(t){e(this),this.message=t?t.length+" errors occurred during unsubscription:\n"+t.map(function(e,t){return t+1+") "+e.toString()}).join("\n  "):"",this.name="UnsubscriptionError",this.errors=t}});function m(e,t){if(e){var i=e.indexOf(t);0<=i&&e.splice(i,1)}}var y=function(){function e(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}return e.prototype.unsubscribe=function(){var e,t,i,r,s;if(!this.closed){this.closed=!0;var n=this._parentage;if(n)if(this._parentage=null,Array.isArray(n))try{for(var o=u(n),a=o.next();!a.done;a=o.next()){a.value.remove(this)}}catch(t){e={error:t}}finally{try{a&&!a.done&&(t=o.return)&&t.call(o)}finally{if(e)throw e.error}}else n.remove(this);var c=this.initialTeardown;if(f(c))try{c()}catch(e){s=e instanceof b?e.errors:[e]}var d=this._finalizers;if(d){this._finalizers=null;try{for(var p=u(d),g=p.next();!g.done;g=p.next()){var v=g.value;try{_(v)}catch(e){s=null!=s?s:[],e instanceof b?s=l(l([],h(s)),h(e.errors)):s.push(e)}}}catch(e){i={error:e}}finally{try{g&&!g.done&&(r=p.return)&&r.call(p)}finally{if(i)throw i.error}}}if(s)throw new b(s)}},e.prototype.add=function(t){var i;if(t&&t!==this)if(this.closed)_(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=null!==(i=this._finalizers)&&void 0!==i?i:[]).push(t)}},e.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},e.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},e.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&m(t,e)},e.prototype.remove=function(t){var i=this._finalizers;i&&m(i,t),t instanceof e&&t._removeParent(this)},e.EMPTY=function(){var t=new e;return t.closed=!0,t}(),e}(),S=y.EMPTY;function w(e){return e instanceof y||e&&"closed"in e&&f(e.remove)&&f(e.add)&&f(e.unsubscribe)}function _(e){f(e)?e():e.unsubscribe()}var E={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},T={setTimeout:function(e,t){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];var s=T.delegate;return(null==s?void 0:s.setTimeout)?s.setTimeout.apply(s,l([e,t],h(i))):setTimeout.apply(void 0,l([e,t],h(i)))},clearTimeout:function(e){var t=T.delegate;return((null==t?void 0:t.clearTimeout)||clearTimeout)(e)},delegate:void 0};function k(e){T.setTimeout(function(){var t=E.onUnhandledError;if(!t)throw e;t(e)})}function I(){}var C=x("C",void 0,void 0);function x(e,t,i){return{kind:e,value:t,error:i}}var P=null;function A(e){if(E.useDeprecatedSynchronousErrorHandling){var t=!P;if(t&&(P={errorThrown:!1,error:null}),e(),t){var i=P,r=i.errorThrown,s=i.error;if(P=null,r)throw s}}else e()}var N=function(e){function t(t){var i=e.call(this)||this;return i.isStopped=!1,t?(i.destination=t,w(t)&&t.add(i)):i.destination=U,i}return o(t,e),t.create=function(e,t,i){return new D(e,t,i)},t.prototype.next=function(e){this.isStopped?$(function(e){return x("N",e,void 0)}(e),this):this._next(e)},t.prototype.error=function(e){this.isStopped?$(x("E",void 0,e),this):(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped?$(C,this):(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(y),O=Function.prototype.bind;function R(e,t){return O.call(e,t)}var L=function(){function e(e){this.partialObserver=e}return e.prototype.next=function(e){var t=this.partialObserver;if(t.next)try{t.next(e)}catch(e){M(e)}},e.prototype.error=function(e){var t=this.partialObserver;if(t.error)try{t.error(e)}catch(e){M(e)}else M(e)},e.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(e){M(e)}},e}(),D=function(e){function t(t,i,r){var s,n,o=e.call(this)||this;f(t)||!t?s={next:null!=t?t:void 0,error:null!=i?i:void 0,complete:null!=r?r:void 0}:o&&E.useDeprecatedNextContext?((n=Object.create(t)).unsubscribe=function(){return o.unsubscribe()},s={next:t.next&&R(t.next,n),error:t.error&&R(t.error,n),complete:t.complete&&R(t.complete,n)}):s=t;return o.destination=new L(s),o}return o(t,e),t}(N);function M(e){var t;E.useDeprecatedSynchronousErrorHandling?(t=e,E.useDeprecatedSynchronousErrorHandling&&P&&(P.errorThrown=!0,P.error=t)):k(e)}function $(e,t){var i=E.onStoppedNotification;i&&T.setTimeout(function(){return i(e,t)})}var U={closed:!0,next:I,error:function(e){throw e},complete:I},B="function"==typeof Symbol&&Symbol.observable||"@@observable";function j(e){return e}function F(e){return 0===e.length?j:1===e.length?e[0]:function(t){return e.reduce(function(e,t){return t(e)},t)}}var H=function(){function e(e){e&&(this._subscribe=e)}return e.prototype.lift=function(t){var i=new e;return i.source=this,i.operator=t,i},e.prototype.subscribe=function(e,t,i){var r,s=this,n=(r=e)&&r instanceof N||function(e){return e&&f(e.next)&&f(e.error)&&f(e.complete)}(r)&&w(r)?e:new D(e,t,i);return A(function(){var e=s,t=e.operator,i=e.source;n.add(t?t.call(n,i):i?s._subscribe(n):s._trySubscribe(n))}),n},e.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(t){e.error(t)}},e.prototype.forEach=function(e,t){var i=this;return new(t=V(t))(function(t,r){var s=new D({next:function(t){try{e(t)}catch(e){r(e),s.unsubscribe()}},error:r,complete:t});i.subscribe(s)})},e.prototype._subscribe=function(e){var t;return null===(t=this.source)||void 0===t?void 0:t.subscribe(e)},e.prototype[B]=function(){return this},e.prototype.pipe=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return F(e)(this)},e.prototype.toPromise=function(e){var t=this;return new(e=V(e))(function(e,i){var r;t.subscribe(function(e){return r=e},function(e){return i(e)},function(){return e(r)})})},e.create=function(t){return new e(t)},e}();function V(e){var t;return null!==(t=null!=e?e:E.Promise)&&void 0!==t?t:Promise}var q=v(function(e){return function(){e(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),K=function(e){function t(){var t=e.call(this)||this;return t.closed=!1,t.currentObservers=null,t.observers=[],t.isStopped=!1,t.hasError=!1,t.thrownError=null,t}return o(t,e),t.prototype.lift=function(e){var t=new z(this,this);return t.operator=e,t},t.prototype._throwIfClosed=function(){if(this.closed)throw new q},t.prototype.next=function(e){var t=this;A(function(){var i,r;if(t._throwIfClosed(),!t.isStopped){t.currentObservers||(t.currentObservers=Array.from(t.observers));try{for(var s=u(t.currentObservers),n=s.next();!n.done;n=s.next()){n.value.next(e)}}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}}})},t.prototype.error=function(e){var t=this;A(function(){if(t._throwIfClosed(),!t.isStopped){t.hasError=t.isStopped=!0,t.thrownError=e;for(var i=t.observers;i.length;)i.shift().error(e)}})},t.prototype.complete=function(){var e=this;A(function(){if(e._throwIfClosed(),!e.isStopped){e.isStopped=!0;for(var t=e.observers;t.length;)t.shift().complete()}})},t.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(t.prototype,"observed",{get:function(){var e;return(null===(e=this.observers)||void 0===e?void 0:e.length)>0},enumerable:!1,configurable:!0}),t.prototype._trySubscribe=function(t){return this._throwIfClosed(),e.prototype._trySubscribe.call(this,t)},t.prototype._subscribe=function(e){return this._throwIfClosed(),this._checkFinalizedStatuses(e),this._innerSubscribe(e)},t.prototype._innerSubscribe=function(e){var t=this,i=this,r=i.hasError,s=i.isStopped,n=i.observers;return r||s?S:(this.currentObservers=null,n.push(e),new y(function(){t.currentObservers=null,m(n,e)}))},t.prototype._checkFinalizedStatuses=function(e){var t=this,i=t.hasError,r=t.thrownError,s=t.isStopped;i?e.error(r):s&&e.complete()},t.prototype.asObservable=function(){var e=new H;return e.source=this,e},t.create=function(e,t){return new z(e,t)},t}(H),z=function(e){function t(t,i){var r=e.call(this)||this;return r.destination=t,r.source=i,r}return o(t,e),t.prototype.next=function(e){var t,i;null===(i=null===(t=this.destination)||void 0===t?void 0:t.next)||void 0===i||i.call(t,e)},t.prototype.error=function(e){var t,i;null===(i=null===(t=this.destination)||void 0===t?void 0:t.error)||void 0===i||i.call(t,e)},t.prototype.complete=function(){var e,t;null===(t=null===(e=this.destination)||void 0===e?void 0:e.complete)||void 0===t||t.call(e)},t.prototype._subscribe=function(e){var t,i;return null!==(i=null===(t=this.source)||void 0===t?void 0:t.subscribe(e))&&void 0!==i?i:S},t}(K),G=function(e){function t(t){var i=e.call(this)||this;return i._value=t,i}return o(t,e),Object.defineProperty(t.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),t.prototype._subscribe=function(t){var i=e.prototype._subscribe.call(this,t);return!i.closed&&t.next(this._value),i},t.prototype.getValue=function(){var e=this,t=e.hasError,i=e.thrownError,r=e._value;if(t)throw i;return this._throwIfClosed(),r},t.prototype.next=function(t){e.prototype.next.call(this,this._value=t)},t}(K),J=v(function(e){return function(){e(this),this.name="EmptyError",this.message="no elements in sequence"}});function W(e,t){var i="object"==typeof t;return new Promise(function(r,s){var n=new D({next:function(e){r(e),n.unsubscribe()},error:s,complete:function(){i?r(t.defaultValue):s(new J)}});e.subscribe(n)})}function Y(e){return function(t){if(function(e){return f(null==e?void 0:e.lift)}(t))return t.lift(function(t){try{return e(t,this)}catch(e){this.error(e)}});throw new TypeError("Unable to lift unknown Observable type")}}function Q(e,t,i,r,s){return new X(e,t,i,r,s)}var X=function(e){function t(t,i,r,s,n,o){var a=e.call(this,t)||this;return a.onFinalize=n,a.shouldUnsubscribe=o,a._next=i?function(e){try{i(e)}catch(e){t.error(e)}}:e.prototype._next,a._error=s?function(e){try{s(e)}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._error,a._complete=r?function(){try{r()}catch(e){t.error(e)}finally{this.unsubscribe()}}:e.prototype._complete,a}return o(t,e),t.prototype.unsubscribe=function(){var t;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var i=this.closed;e.prototype.unsubscribe.call(this),!i&&(null===(t=this.onFinalize)||void 0===t||t.call(this))}},t}(N);function Z(e,t){return Y(function(i,r){var s=0;i.subscribe(Q(r,function(i){return e.call(t,i,s++)&&r.next(i)}))})}var ee=function(e){return e&&"number"==typeof e.length&&"function"!=typeof e};function te(e){return f(null==e?void 0:e.then)}function ie(e){return f(e[B])}function re(e){return Symbol.asyncIterator&&f(null==e?void 0:e[Symbol.asyncIterator])}function se(e){return new TypeError("You provided "+(null!==e&&"object"==typeof e?"an invalid object":"'"+e+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}var ne,oe="function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator";function ae(e){return f(null==e?void 0:e[oe])}function ce(e){return p(this,arguments,function(){var t,i,r;return c(this,function(s){switch(s.label){case 0:t=e.getReader(),s.label=1;case 1:s.trys.push([1,,9,10]),s.label=2;case 2:return[4,d(t.read())];case 3:return i=s.sent(),r=i.value,i.done?[4,d(void 0)]:[3,5];case 4:return[2,s.sent()];case 5:return[4,d(r)];case 6:return[4,s.sent()];case 7:return s.sent(),[3,2];case 8:return[3,10];case 9:return t.releaseLock(),[7];case 10:return[2]}})})}function ue(e){return f(null==e?void 0:e.getReader)}function he(e){if(e instanceof H)return e;if(null!=e){if(ie(e))return s=e,new H(function(e){var t=s[B]();if(f(t.subscribe))return t.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")});if(ee(e))return r=e,new H(function(e){for(var t=0;t<r.length&&!e.closed;t++)e.next(r[t]);e.complete()});if(te(e))return i=e,new H(function(e){i.then(function(t){e.closed||(e.next(t),e.complete())},function(t){return e.error(t)}).then(null,k)});if(re(e))return le(e);if(ae(e))return t=e,new H(function(e){var i,r;try{for(var s=u(t),n=s.next();!n.done;n=s.next()){var o=n.value;if(e.next(o),e.closed)return}}catch(e){i={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(i)throw i.error}}e.complete()});if(ue(e))return le(ce(e))}var t,i,r,s;throw se(e)}function le(e){return new H(function(t){(function(e,t){var i,r,s,n;return a(this,void 0,void 0,function(){var o,a;return c(this,function(c){switch(c.label){case 0:c.trys.push([0,5,6,11]),i=g(e),c.label=1;case 1:return[4,i.next()];case 2:if((r=c.sent()).done)return[3,4];if(o=r.value,t.next(o),t.closed)return[2];c.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return a=c.sent(),s={error:a},[3,11];case 6:return c.trys.push([6,,9,10]),r&&!r.done&&(n=i.return)?[4,n.call(i)]:[3,8];case 7:c.sent(),c.label=8;case 8:return[3,10];case 9:if(s)throw s.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}})})})(e,t).catch(function(e){return t.error(e)})})}function de(e){return Y(function(t,i){var r,s=null,n=!1;s=t.subscribe(Q(i,void 0,void 0,function(o){r=he(e(o,de(e)(t))),s?(s.unsubscribe(),s=null,r.subscribe(i)):n=!0})),n&&(s.unsubscribe(),s=null,r.subscribe(i))})}function pe(e,t){return Y(function(i,r){var s=0;i.subscribe(Q(r,function(i){r.next(e.call(t,i,s++))}))})}!function(e){e[e.None=0]="None",e[e.Error=1]="Error",e[e.Warn=2]="Warn",e[e.Info=3]="Info",e[e.Verbose=4]="Verbose"}(ne||(ne={}));const ge={app:"",mode:"standard",app_version:"0",version:"1.97.2",logLevel:ne.Error,locksMaxAge:864e5,storagePrefix:"paa_",keyPulseSyncCookie:"pulse-state",hashStoreStorageType:"persistent",stateStorageKey:"ss",handledErrorPrefix:"HANDLED ERROR >>>"},fe={...ge,transportTimeout:6e4,transportRetries:Number.POSITIVE_INFINITY,transportRetryBackoffMS:100,transportRetryBackoffMaxMS:3e4,pulseClientType:"browser",tabManagerStorageType:"tab",sessionStorageType:"persistent",initialDocURL:"",experimentStorageKey:"experiments",keySessionID:"sid",keyDeviceId:"did",trafficSourceDetectorStorageType:"persistent",cacheStorageType:"persistent",eventEnrichment:!0};class ve{env;_db;connectionState$=new G("NOT_CONNECTED");storeList=["settingsStore","attributesStore"];pulseDB="pulseDB";get db(){if(!this._db)throw Error("IndexDB store not exist ");return this._db}constructor(e){this.env=e}async truncate(e){if(!s(this.env.win))return;const t=await this.getTransaction(e,"readwrite");return new Promise((i,r)=>{try{const s=t.objectStore(e).clear();s.onerror=e=>{this.logerr(e),r(e)},s.onsuccess=()=>{i(s.result)}}catch(e){r(e)}})}async getValue(e,t){if(!s(this.env.win))return;const i=await this.getTransaction(e,"readonly");return new Promise((r,s)=>{try{const s=i.objectStore(e).get(t);s.onerror=this.logerr,s.onsuccess=()=>{r(s.result)}}catch(e){s(e)}})}async getAllValue(e){if(!s(this.env.win))return Promise.resolve();const t=await this.getTransaction(e,"readonly");return new Promise((i,r)=>{try{const r=t.objectStore(e).getAll();r.onerror=this.logerr,r.onsuccess=()=>{i(r.result)}}catch(e){r(e)}})}async putValue(e,t){if(!s(this.env.win))return Promise.resolve(!1);const i=await this.getTransaction(e,"readwrite");return new Promise((r,s)=>{try{const s=i.objectStore(e).put(t);s.onsuccess=()=>{r(!0)},s.onerror=this.logerr}catch(e){s(e)}})}async putBulkValue(e,t){if(!s(this.env.win))return;const i=(await this.getTransaction(e,"readwrite")).objectStore(e);for(const e of t)i.put(e);return await this.getAllValue(e)}async deleteValue(e,t){if(!s(this.env.win))return;const i=await this.getTransaction(e,"readwrite");return new Promise((r,s)=>{try{const s=i.objectStore(e),n=s.get(t);n.onsuccess=()=>{n.result||r("-1"),s.delete(t).onsuccess=()=>r(t)},n.onerror=this.logerr}catch(e){s(e)}})}async connectDB(){if(!s(this.env.win))return;this.connectionState$.next("CONNECTING");const e=this.env.win.indexedDB.open(this.pulseDB,1);return new Promise((t,i)=>{try{e.onerror=e=>{this.connectionState$.next("NOT_CONNECTED"),this.logerr(e)},e.onsuccess=()=>{this.createObjectStore(e.result),t(e.result)},e.onupgradeneeded=e=>{e.target&&e.target?.result&&this.createObjectStore(e.target?.result)}}catch(e){this.connectionState$.next("NOT_CONNECTED"),i(e)}})}logerr(e){console.warn(e)}createObjectStore(e){this.storeList.forEach(t=>{if(!e.objectStoreNames.contains(t)){const i=e.createObjectStore(t,{autoIncrement:!1,keyPath:"id"});i.createIndex("id","id",{unique:!0}),i.createIndex("time","time",{unique:!1}),i.createIndex("id_time",["id","time"],{unique:!0})}}),this._db=e,this.connectionState$.next("CONNECTED"),this.db.onclose=this.reconnectDB.bind(this),this.db.onabort=this.reconnectDB.bind(this)}getTransaction(e,t,i){if("CONNECTED"===this.connectionState$.getValue())try{return Promise.resolve(this.db.transaction(e,t,i))}catch(e){console.warn(e),this.connectDB()}return W(this.connectionState$.pipe(Z(e=>"CONNECTED"===e),pe(()=>this.db.transaction(e,t,i)),de(e=>{return this.logerr(e),r=f(t=()=>e)?t:function(){return t},s=function(e){return e.error(r())},new H(i?function(e){return i.schedule(s,0,e)}:s);var t,i,r,s})))}reconnectDB(e){e&&this.logerr(`${fe.handledErrorPrefix} ${JSON.stringify(e)}`),this.connectDB()}}class be{win;doc;navigator;landingUrl;constructor(e){this.win=e,this.doc=this.win.document,this.navigator=this.win.navigator,this.landingUrl=this.getInitialDocumentURL()}getInitialDocumentURL(){if("function"==typeof this.win.performance?.getEntries){const e=this.win.performance.getEntries().find(e=>"navigation"===e.entryType);if(e&&this.isValidURL(e.name))return e.name}return this.isValidURL(this.win.pulse?.idu)?this.win.pulse.idu:this.win.document.location.href}isValidURL(e){if("string"!=typeof e)return!1;try{const t=new URL(e);return Boolean(t.hostname)}catch{return!1}}}class me{key;___;constructor(e){if(this.key=e,"string"!=typeof e||!e.trim())throw new Error("Invalid InjectionToken name!");this.___=e}}const ye=new me("PULSE_ROOT_CONFIGURATION");let Se;function we(){const e=function(){if(Se)return Se;try{if("object"==typeof navigator&&"Cloudflare-Workers"===navigator?.userAgent)return Se="cf-worker",Se;if("undefined"!=typeof window&&void 0!==window.document)return"object"==typeof navigator&&navigator?.userAgent?.includes("jsdom")?(Se="jsdom",Se):(Se="browser",Se);if("undefined"!=typeof process&&process.versions?.node)return Se="node",Se;if("undefined"!=typeof globalThis&&"function"==typeof globalThis.addEventListener&&"function"==typeof globalThis.Request){if("EdgeRuntime"in globalThis&&"edge"===globalThis.EdgeRuntime)return Se="vercel-edge",Se;if("undefined"!=typeof WebSocket)return Se="cf-worker",Se}}catch{console.warn("Failed to detect environment")}return Se="unknown",Se}();return"browser"===e||"jsdom"===e}class _e{task;resolveTask;rejectTask;completed=!1;constructor(e){if(this.task=new Promise((e,t)=>{this.resolveTask=e,this.rejectTask=t}),e){const t=setTimeout(()=>{this.reject(new Error(`AsyncTask timeout after ${e}ms!`))},e);this.waitUntilResolved().then(()=>clearTimeout(t)).catch(()=>clearTimeout(t))}}resolve(e){this.completed||(this.completed=!0,this.resolveTask(e))}reject(e){this.completed||(this.completed=!0,this.rejectTask(e))}waitUntilResolved(){return this.task}}class Ee{parent;providers=new Map;store=new Map;tasks=new Map;constructor(e){this.parent=e}register(...e){for(const t of e)this.providers.set(t.provide,t);return this}factory(e){return this.providers.set(e.provide,e),this}get(e){const t=this.getOrCreate(e);return this.isPromise(t)?t:Promise.resolve(t)}getSync(e){const t=this.getOrCreate(e);if(this.isPromise(t)){const t=this.typeName(e);throw new Error(["Cannot instantiate dependency synchronously!",`One of the providers of the dependencies of '${t}' is asynchronous!`].join("\n"))}return t}getOrCreate(e){if(e===Ee)return this;const t=this.store.get(e);if(t)return t;let i=this.tasks.get(e);if(i)return i.waitUntilResolved();i=new _e;const r=this.providers.get(e);if(!r){if(this.parent)return this.parent.getOrCreate(e);throw new Error(`No provider found for type '${this.typeName(e)}'!`)}const s=this.getDeps(r);if(this.isPromise(s))return this.tasks.set(e,i),s.then(e=>this.createValue(r,e)).then(t=>{this.store.set(e,t),i?.resolve(t),this.tasks.delete(e)}).catch(t=>{this.tasks.delete(e),i?.reject(t)}),i.waitUntilResolved();{const t=this.createValue(r,s);return this.store.set(e,t),t}}createValue(e,t){if(void 0!==e.useValue)return e.useValue;if(e.useClass)return new e.useClass(...t);if(e.useFactory)return e.useFactory(...t);if(this.isClass(e.provide))return new e.provide(...t);{const t=this.typeName(e.provide);throw new Error(`No useClass or useFactory is provided for type '${t}'`)}}getDeps(e){this.checkDeps(e);const t=(Array.isArray(e.deps)?e.deps:[]).map(e=>this.getOrCreate(e));return t.some(e=>this.isPromise(e))?Promise.all(t):t}checkDeps(e){const t=Array.isArray(e.deps)?e.deps:[],i=t.map(e=>this.findProvider(e)),r=t.filter((e,t)=>void 0===i[t]);if(!r.length)return;const s=this.typeName(e.provide),n=i.map(e=>e?this.typeName(e.provide):"?").join(", "),o=`No provider found for the following tokens: ${r.map(e=>this.typeName(e)).join(", ")}`;throw new Error(`Cannot instantiate dependency '${s}(${n})'!\n\n ${o}`)}findProvider(e){return this.providers.get(e)||this.parent?.findProvider(e)}typeName(e){return e instanceof me?`Token(${e.key})`:this.isClass(e)?e.name:String(e)}isClass(e){return e&&"function"==typeof e&&"string"==typeof e.name&&"function"==typeof e.constructor&&e.name}isPromise(e){return"object"==typeof e&&(e instanceof Promise||e.then&&e.catch)}}class Te{providers=[];useClass(e,t,i,r){return this.providers.push({provide:e,useClass:t,deps:i,provideInRoot:r}),this}useFactory(e,t,i,r){return this.providers.push({provide:e,useFactory:t,deps:i,provideInRoot:r}),this}useValue(e,t,i){return this.providers.push({provide:e,useValue:t,provideInRoot:i}),this}_getProviders(){return this.providers}}class ke{imports=[];builder=new Te;beforeInitHandler;initHandler;injector=new Ee;parent;bootstrapped=!1;import(e){if(e.bootstrapped)throw new Error("Cannot import already bootstrapped module! Only root module must be bootstrapped!");return e.parent=this,this.imports.push(e),this}provide(e){const t=e(this.builder);if(!(t&&t instanceof Te))throw new Error("Provide function must return the received ProviderBuilder instance!");return this.builder=t,this}beforeInit(e){if("function"!=typeof e)throw new Error("BeforeInit handler must be a function!");return this.beforeInitHandler=e,this}onInit(e,t){if("function"!=typeof e)throw new Error("OnInit handler must be a function!");if(t&&!Array.isArray(t))throw new Error("OnInit handler dependency list must be an array!");return this.initHandler={provide:"initializer",useFactory:e,deps:t||void 0},this}bootstrapStrict(e){return this.bootstrap(e)}async bootstrap(e){if(this.bootstrapped)throw new Error("PulseModule is already bootstrapped!");if(this.bootstrapped)throw new Error("Cannot bootstrap child module!");if(this.imports.some(e=>e.bootstrapped))throw new Error("Cannot import already bootstrapped module! Only root module must be bootstrapped!");const t=await this.runModulesBeforeInit(e),i=this.getConfigOverride(t),r={provide:ye,useValue:i};return this.injector.register(r),await this.initializeModules(e),this.injector}getConfigOverride(e){try{if(we()&&"undefined"!=typeof window&&t(window)){const t=window.localStorage.getItem(`${e.storagePrefix}config_override`);if(t){const i=JSON.parse(t);return i&&"object"==typeof i?{...e,...i}:(console.error("Configuration entry must be an object!"),e)}}}catch(e){console.error("Pulse configuration provided through localStorage is invalid!"),console.log(e)}return e}async initializeModules(e){const t=[...this.imports,this];for(const e of t)e.configureInjector();const i=t.map(t=>t.runOnInit(e));await Promise.all(i)}configureInjector(){if(this.parent&&this.imports.length)throw new Error("Deep module imports are not supported yet!");const e=this.parent?.injector,t=e?new Ee(e):this.injector,i=this.builder._getProviders(),r=i.filter(e=>!1!==e.provideInRoot),s=i.filter(e=>!e.provideInRoot);t.register(...s),e?e.register(...r):r.length&&t.register(...r),this.injector=t}async runModulesBeforeInit(e){const t=await this.runBeforeInit(e),i=this.imports.map(t=>t.runBeforeInit(e));return{...t,...(await Promise.all(i)).reduce((e,t)=>({...e,...t}))}}async runBeforeInit(e){try{const t=this.beforeInitHandler?this.beforeInitHandler(e):void 0;return(t instanceof Promise?await t:t)||{}}catch(e){throw console.error("Module beforeInit hook failed!"),e}}async runOnInit(e){try{if(!this.initHandler?.useFactory)return;const t=(this.initHandler.deps||[]).map(e=>this.injector.get(e)),i=await Promise.all(t),r=this.initHandler.useFactory(e,...i);r instanceof Promise&&await r}catch(e){throw console.error(e),console.error("Module onInit hook failed!"),e}}}const Ie={settingsBaseURL:"https://optifyr.com/web/v2",timeout:1500,cacheTimeout:6e5,defaults:{},attributes:{},storagePrefix:"paa_",remoteSettingEnabled:!0},Ce=new me("Window"),xe=new me("STORAGE_SELECTOR"),Pe=new me("COOKIE_BC"),Ae=new me("UN_PREFIXED_COOKIE_STORAGE"),Ne=new me("UN_PREFIXED_STORAGE"),Oe=new me("LOCK_MANAGER"),Re=new me("PREFIXED_COOKIE_STORAGE");class Le{}class De extends Le{env;hrtTimeOrigin;constructor(e){super(),this.env=e;const t=this.now(),i=this.hrt(),r=e.win.performance.timeOrigin;this.hrtTimeOrigin=r??t-i}now(){return this.env.win.Date.now()}hrtTime(){return this.hrtTimeOrigin+this.env.win.performance.now()}hrt(){return this.env.win.performance.now()}timezoneOffset(){const e=new this.env.win.Date;return e.getTimezoneOffset&&e.getTimezoneOffset()}}class Me{env;constructor(e){this.env=e}push(e){this.env.win?.dataLayer&&this.env.win.dataLayer.push(e)}}var $e,Ue;!function(e){e.All="all",e.External="external",e.Internal="internal"}($e||($e={})),function(e){e.Start="start",e.Full="full"}(Ue||(Ue={}));var Be={now:function(){return(Be.delegate||Date).now()},delegate:void 0},je=function(e){function t(t,i,r){void 0===t&&(t=1/0),void 0===i&&(i=1/0),void 0===r&&(r=Be);var s=e.call(this)||this;return s._bufferSize=t,s._windowTime=i,s._timestampProvider=r,s._buffer=[],s._infiniteTimeWindow=!0,s._infiniteTimeWindow=i===1/0,s._bufferSize=Math.max(1,t),s._windowTime=Math.max(1,i),s}return o(t,e),t.prototype.next=function(t){var i=this,r=i.isStopped,s=i._buffer,n=i._infiniteTimeWindow,o=i._timestampProvider,a=i._windowTime;r||(s.push(t),!n&&s.push(o.now()+a)),this._trimBuffer(),e.prototype.next.call(this,t)},t.prototype._subscribe=function(e){this._throwIfClosed(),this._trimBuffer();for(var t=this._innerSubscribe(e),i=this._infiniteTimeWindow,r=this._buffer.slice(),s=0;s<r.length&&!e.closed;s+=i?1:2)e.next(r[s]);return this._checkFinalizedStatuses(e),t},t.prototype._trimBuffer=function(){var e=this,t=e._bufferSize,i=e._timestampProvider,r=e._buffer,s=e._infiniteTimeWindow,n=(s?1:2)*t;if(t<1/0&&n<r.length&&r.splice(0,r.length-n),!s){for(var o=i.now(),a=0,c=1;c<r.length&&r[c]<=o;c+=2)a=c;a&&r.splice(0,a+1)}},t}(K);class Fe{uuid;storage;cookieStorage;config;webToMobileService;storageChange;deviceId="";deviceIdSubject$=new je(1);constructor(e,t,i,r,s,n){this.uuid=e,this.storage=t,this.cookieStorage=i,this.config=r,this.webToMobileService=s,this.storageChange=n,this.cookieStorage.remove(this.config.keyDeviceId),this.registerStorageChangeListeners(),this.setDeviceId(this.fetchDeviceId().trim())}getDeviceId(){return this.deviceId}getDeviceId$(){return this.deviceIdSubject$.asObservable()}setDeviceId(e){if(e===this.deviceId||"string"!=typeof e||!e.trim())return;let t;const i=e.trim(),r=this.webToMobileService.getWebToMobileMetaInfo();t=r?.device_id?String(r.device_id):i;this.storage.get(this.config.keyDeviceId)!==t&&this.storage.set(this.config.keyDeviceId,t),this.deviceId=t,this.deviceIdSubject$.next(t)}generateDeviceId(){return this.uuid.generate()}registerStorageChangeListeners(){this.storage.change(this.config.keyDeviceId,Ue.Full,this.storageChange).subscribe(({value:e})=>{this.setDeviceId(e||"")})}fetchDeviceId(){return this.storage.get(this.config.keyDeviceId)||this.generateDeviceId()}}function He(e){const t=e.toLowerCase(),i=t.indexOf("?");return t.substring(0,i+1)+t.substring(i+1).split(/[#?]/g).join("&")}function Ve(e,t){if(e===t)return!0;if("object"!=typeof e||"object"!=typeof t||!e||!t)return!1;const i=e,r=t;return Object.keys({...i,...r}).every(e=>Ve(i[e],r[e]))}class qe{utmService;storage;page;trafficSourceSubject$=new je(1);constructor(e,t,i){this.utmService=e,this.storage=t,this.page=i;const r=this.getStoredTrafficSource();r&&this.trafficSourceSubject$.next(r)}getTrafficSource(){const e=this.utmService.getUTMParams(),t=this.getReferrer(),i=this.getClickId(t?.url),r=this.page.landingPageUrl();return e||i||t?{utmParams:e,clickId:i,referrer:t,landingPageURL:r}:null}getLastTrafficSource(){const e=this.getStoredTrafficSource(),t=this.getTrafficSource(),i=t?.referrer?.internal??!1;return this.changed(t?.clickId,e?.clickId)||this.changed(t?.utmParams,e?.utmParams)||this.changed(t?.referrer,e?.referrer)&&!i?(this.storage.setJSON("traffic_source",t),this.trafficSourceSubject$.next(t),t):e}getLastTrafficSource$(){return this.trafficSourceSubject$.asObservable()}getReferrer(){const e=this.page.referrer()||"";if(e)return{url:e,internal:this.isInternalURL(e)}}getStoredTrafficSource(){return this.storage.getJSON("traffic_source")}getClickId(e){const{searchParams:t}=new URL(He(this.page.landingPageUrl())),i=t.get("gclid"),r=t.get("gclsrc")||t.get("wbraid")||t.get("gbraid"),s=t.get("msclkid"),n=t.get("fbclid"),o=t.get("yclid"),a=e?.includes("yahoo")?"yahoo":"yandex",c=t.get("dclid"),u=t.get("li_fat_id"),h=t.get("ttclid"),l=t.get("twclid");let d,p;return i?(d=i,p=r?`google.${r}`:"google"):n?(d=n,p="facebook"):s?(d=s,p="microsoft"):o?(d=o,p=a):c?(d=c,p="doubleclick"):u?(d=u,p="linkedin"):h?(d=h,p="tiktok"):l&&(d=l,p="twitter"),d&&p?{value:d,source:p}:void 0}isInternalURL(e){return new URL(e).host===this.page.url().host}changed(e,t){return e&&!Ve(e,t)}}function Ke(e,t){return new Promise(i=>{const r=setTimeout(i,e);t&&(t.onabort=()=>{clearTimeout(r)})})}class ze{documentVisibility;env;date;logger;config;deviceIdService;get async(){return this.documentVisibility.visible}timeoutLimit=2e4;constructor(e,t,i,r,s,n){this.documentVisibility=e,this.env=t,this.date=i,this.logger=r,this.config=s,this.deviceIdService=n}async get(e,t,i){return this.retry(()=>this.trySendGetRequest(e,t,i),this.config.transportRetries,this.config.transportTimeout)}async post(e,t,i,r=!1){return await this.retry(()=>this.trySendPostRequest(e,t,r,i),this.config.transportRetries,this.config.transportTimeout)}async put(e,t,i){return(await this.env.win.fetch(e,{method:"PUT",headers:t,body:JSON.stringify(i)})).json()}async delete(e,t){return(await this.env.win.fetch(e,{method:"DELETE",headers:t})).json()}async retry(e,t=Number.MAX_SAFE_INTEGER,i=6e4){const r=this.date.now();let s=0;for(;;){const n=s<t;if(this.date.now()-r>i)throw new Error("Timedout!");if(!n)throw new Error("Max retries exeeded!");this.env.navigator.onLine||void 0===this.env.win.navigator.onLine||await this.waitForNetwork();try{const t=await e();if(t)return t;throw new Error("Request Failed!")}catch(e){this.logger.warn(e);const t=this.backoffTime(++s);await Ke(t)}}}waitForNetwork(){return new Promise(e=>{if(this.env.win.navigator.onLine)return e();this.env.win.addEventListener("online",()=>{e()})})}succeeded(e){return"boolean"==typeof e?e:e>=200&&e<=400}backoffTime(e){if(!this.async&&e<10)return 0;const t=Math.floor(Math.pow(1e3,e/50)*this.config.transportRetryBackoffMS);return Math.min(this.config.transportRetryBackoffMaxMS,t)}fetchPossible(){const e=this.env.win,t="Request"in e&&"boolean"==typeof new Request("https://t.picsart.com").keepalive;return!("function"!=typeof e.fetch||!("AbortController"in e)||!this.async&&!t)}sendBeacon(e,t){return this.env.win.navigator.sendBeacon(`${t}/beacon`,e)}async trySendGetRequest(e,t,i){let r;if(this.env.win.navigator.onLine||void 0===this.env.win.navigator.onLine||await this.waitForNetwork(),this.fetchPossible()){const s=new AbortController,n=setTimeout(()=>s.abort(),this.timeoutLimit),o={method:"GET",headers:t,credentials:"include",signal:s.signal};"high"===i&&(o.priority=i);const a=await this.env.win.fetch(e,o);if(clearTimeout(n),!a)return{ok:!1,body:void 0,headers:new Map,status:400};const c=await(a?.json()),u=new Map(a.headers.entries());r={ok:a.ok,body:c,headers:u,status:a?.status},"object"==typeof r&&r?.headers.has("paa-did")&&this.replaceDeviceId(r.headers.get("paa-did"))}else r=await this.sendGetXHR(e,t,!0);return r}async trySendPostRequest(e,t,i,r){let s;if(this.env.win.navigator.onLine||void 0===this.env.win.navigator.onLine||await this.waitForNetwork(),this.fetchPossible()){let n,o,a;try{if(n=await this.env.win.fetch(`${e}/fetch`,{method:"POST",headers:t,body:JSON.stringify(r),credentials:"include",keepalive:i}),o=new Map(n.headers.entries()),a=await n.json(),n.status>=500)return!1;s={ok:4===n.status,body:a.body,headers:o,status:n.status}}catch{return!1}"object"==typeof s&&s?.headers.has("paa-did")&&this.replaceDeviceId(s.headers.get("paa-did"))}else if(i&&"function"==typeof this.env.win.navigator?.sendBeacon){if(this.sendBeacon(JSON.stringify(r),e))return!0;s=await this.sendPostXHR(JSON.stringify(r),!0,t,e)}else s=await this.sendPostXHR(JSON.stringify(r),!0,t,e);return s}async sendGetXHR(e,t,i){const r=this.env,s=this.config,n=new Promise((n,o)=>{try{const o=new r.win.XMLHttpRequest;i&&(o.timeout=s.transportTimeout,o.onreadystatechange=()=>{this.requestStateChange(o,n)}),o.open("GET",`${e}`,i),o.withCredentials=!0,o.timeout=this.timeoutLimit;for(const e in t)o.setRequestHeader(e,String(t[e]));o.send()}catch(e){o(e)}});return await n}sendPostXHR(e,t,i,r){return new Promise((s,n)=>{try{const n=new this.env.win.XMLHttpRequest;t&&(n.timeout=this.config.transportTimeout,n.onreadystatechange=()=>{this.requestStateChange(n,s)}),n.open("POST",`${r}/xhr`,t),n.withCredentials=!0;for(const e in i)n.setRequestHeader(e,String(i[e]));n.send(e),t||s(n.response)}catch(e){n(e)}})}requestStateChange(e,t){if(4===e.readyState){const i=this.succeeded(e.status),r=new Map;let s;e.getAllResponseHeaders().trim().split(/[\r\n]+/).forEach((e,t)=>{r.set(t.toString(),e)});try{s=JSON.parse(e.response)}catch{throw new Error(`${e.response} is not a JSON!`)}const n={ok:i,status:e.status,body:s,headers:r};"object"==typeof n&&n?.headers.has("paa-did")&&this.replaceDeviceId(r.get("paa-did")),t(n)}}replaceDeviceId(e){e&&this.deviceIdService.setDeviceId(e)}}function Ge(e){return"object"==typeof e&&e?Array.isArray(e)?e.map(e=>Ge(e)):Object.keys(e).sort().reduce((t,i)=>(t[i]=Ge(e[i]),t),{}):e}class Je{storage;crypto;date;KEY_ATTR_HASHES="hs";hashes=new Map;constructor(e,t,i){this.storage=e,this.crypto=t,this.date=i,this.refresh(),this.storage.change(this.KEY_ATTR_HASHES).subscribe(e=>this.refresh(e.value))}changed(e,t,i,r=!0){let s;s=null===t?"null":void 0===t?"undefined":"object"==typeof t?JSON.stringify(Ge(t)):"string"==typeof t?t:JSON.stringify(t);const n=this.date.now(),o=this.crypto.unsafeShortHash(e),a=this.crypto.unsafeShortHash(s),c=this.hashes.get(o),[u,h]=(c||"").split("."),l=parseInt(h||"0",36);return!(u===a&&(!i||l&&!(n-l>i)))&&(this.hashes.set(o,`${a}.${n.toString(36)}`),this.persist(),!(!r&&!c))}refresh(e){let t=e?JSON.parse(e):this.storage.getJSON(this.KEY_ATTR_HASHES);t&&Array.isArray(t.hs)||(t={hs:[]},this.storage.setJSON(this.KEY_ATTR_HASHES,t)),this.hashes=new Map(t.hs)}persist(){const e={hs:Array.from(this.hashes)};this.storage.setJSON(this.KEY_ATTR_HASHES,e)}}class We{storage;storageKey;webToMobileService;trafficSourceService;tabManagerService;storageChangeOrigin;state;stateSubject$=new je(1);constructor(e,t,i,r,s,n){this.storage=e,this.storageKey=t,this.webToMobileService=i,this.trafficSourceService=r,this.tabManagerService=s,this.storageChangeOrigin=n,this.registerStorageChangeListeners();const o=this.getStateInternal();this.stateSubject$.next(o)}setState(e){const t=this.getStateInternal(),i={...t,...e};Ve(t,i)||(this.state=i,this.storage.setJSON(this.storageKey,i),this.stateSubject$.next(i))}getState(){const e=Boolean(this.webToMobileService.getWebToMobileMetaInfo()),t=this.trafficSourceService.getReferrer()?this.trafficSourceService.getReferrer()?.url:void 0,i={...this.getStateInternal()},r=i.data?{...i.data}:{};return r.is_w2m=e,r.referrer=t,i.data=r,i.tab_id=this.tabManagerService.getTabId(),i}getStateInternal(){return this.state?this.state:this.refreshState()}getState$(){return this.stateSubject$.asObservable()}removePropertyFromState(e){const t=this.getStateInternal();if(e in t){const i={...t};delete i[e],Ve(t,i)||(this.state=i,this.storage.setJSON(this.storageKey,i),this.stateSubject$.next(i))}}refreshState(e){const t=e||this.storage.getJSON(this.storageKey)||this.state||{},i=Boolean(this.webToMobileService.getWebToMobileMetaInfo()),r=t.data||{};return r.is_w2m=i,t.data=r,this.state=t,t}registerStorageChangeListeners(){this.storage.change(this.storageKey,Ue.Full,this.storageChangeOrigin).subscribe(({value:e})=>{const t=JSON.parse(e||"{}"),i=this.getStateInternal(),r=this.refreshState(t);Ve(i,r)||this.stateSubject$.next(r)})}}class Ye{clientAttributes={};constructor(){try{const e=this.getPulseScript();this.clientAttributes=e?this.getClientAttributes(e):{}}catch{this.clientAttributes={}}}getAttributes(){return this.clientAttributes}getPulseScript(){try{if(document?.currentScript instanceof HTMLScriptElement)return new URL(document?.currentScript.src);{const e=document.getElementsByTagName("script");for(let t=0;t<e.length;t++){const i=e[t].getAttribute("src");if(i&&i.match(/^(https?|http):\/\/[^/]+\/pulse\/[^/]+\/(module\/|nomodule\/)?pulse\.js/i))return new URL(i)}}}catch{return null}return null}getAttributesFromQuery(e){const t={};return e.split(",").forEach(e=>{const[i,r]=e.split(".");t[i]=r}),t}getClientAttributes(e){try{const t=new URLSearchParams(e.search).get("attr");return t?this.getAttributesFromQuery(t):{}}catch{return{}}}}class Qe{env;constructor(e){this.env=e}async quoteSize(){return new Promise(e=>{try{"function"==typeof this.env.navigator?.storage?.estimate?navigator?.storage.estimate().then(t=>{e(t?.quota)}).catch(t=>{console.error(t),e(null)}):e(null)}catch(t){console.error(t),e(null)}})}}class Xe{env;constructor(e){this.env=e}pushData(e){this.env.win.dataLayer||(this.env.win.dataLayer=[]),this.env.win.dataLayer.push(e)}}class Ze{env;constructor(e){this.env=e}host(){return this.env.win.location.host}landingPageUrl(){return this.env.landingUrl.toLowerCase()}referrer(){return this.env.doc.referrer}href(){return this.env.win.location.href}url(){return new URL(this.env.win.location.href)}}class et{env;page;constructor(e,t){this.env=e,this.page=t}cleanupURL(e){const t=this.page.url();t.searchParams.has(e)&&(t.searchParams.delete(e),this.env.win.history.replaceState(this.env.win.history.state,this.env.doc.title,t.href))}}class tt{env;registeredConrols=new Map;debugCtrlIconKey="pulse-debug-ctrl-icon";experimentIcon=`<svg class="${this.debugCtrlIconKey}"  width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                                <path d="M9 2C9 1.44772 9.44772 1 10 1H14C14.5523 1 15 1.44772 15 2V3C15 3.55228 14.5523 4 14 4H10C9.44772 4 9 3.55228 9 3V2Z" fill="#ff6d91"/>\n                                <path d="M6 8V6C6 5.44772 6.44772 5 7 5H17C17.5523 5 18 5.44772 18 6V8C18 8.55228 17.5523 9 17 9H7C6.44772 9 6 8.55228 6 8Z" fill="#ff6d91"/>\n                                <path d="M8 9H16L20 17C21 19 19.5 21 17 21H7C4.5 21 3 19 4 17L8 9Z" stroke="#ff6d91" stroke-width="2"/>\n                                <path d="M19 3H21M20 2V4M4 3H6M5 2V4M16 5H18M17 4V6" stroke="#ff6d91" stroke-width="2" stroke-linecap="round"/>\n                            </svg>`;debugIcon=`<svg class="${this.debugCtrlIconKey}" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                            <path d="M10 2C9.44772 2 9 2.44772 9 3V4.07071C7.2845 4.55606 6 6.13616 6 8V10H4C3.44772 10 3 10.4477 3 11C3 11.5523 3.44772 12 4 12H6V14H4C3.44772 14 3 14.4477 3 15C3 15.5523 3.44772 16 4 16H6V18C6 19.8638 7.2845 21.4439 9 21.9293V23C9 23.5523 9.44772 24 10 24C10.5523 24 11 23.5523 11 23V22H13V23C13 23.5523 13.4477 24 14 24C14.5523 24 15 23.5523 15 23V21.9293C16.7155 21.4439 18 19.8638 18 18V16H20C20.5523 16 21 15.5523 21 15C21 14.4477 20.5523 14 20 14H18V12H20C20.5523 12 21 11.5523 21 11C21 10.4477 20.5523 10 20 10H18V8C18 6.13616 16.7155 4.55606 15 4.07071V3C15 2.44772 14.5523 2 14 2C13.4477 2 13 2.44772 13 3V4H11V3C11 2.44772 10.5523 2 10 2Z" fill="#ff6d91"/>\n                            <circle cx="17" cy="17" r="5" stroke="#ff6d91" stroke-width="2"/>\n                            <line x1="20.5" y1="20.5" x2="23" y2="23" stroke="#ff6d91" stroke-width="2"/>\n                        </svg>`;copyIcon=function(e){return`<svg \n            class="pulse-debug-ctrl-copy-icon"\n            onclick="(()=>{\n                try {\n                    navigator.clipboard.writeText('${e}');\n                } catch (err) {\n                    console.log('Failed to copy:', err);\n                }\n            })()" \n            width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n            <rect x="8" y="4" width="12" height="14" rx="2" stroke="#ff6d91" stroke-width="2"/>\n            <path d="M6 8H5C3.89543 8 3 8.89543 3 10V18C3 19.1046 3.89543 20 5 20H13C14.1046 20 15 19.1046 15 18V17" stroke="#ff6d91" stroke-width="2"/>\n        </svg>`};constructor(e){this.env=e}registerControl({control:e,content:t,url:i,title:r="",deviceId:s="",callbackFn:n}){this.registeredConrols.has(e)||this.registeredConrols.set(e,this.displayControls({controlName:e,content:t,url:i,title:r,deviceId:s,callbackFn:n}))}unregisterControl(e){const t=this.registeredConrols.get(e);t&&(this.animateOut(t),this.registeredConrols.delete(e))}displayControls({controlName:e,content:t,url:i,title:r,deviceId:s,callbackFn:n}){const o=this.createElements({controlName:e,content:t,url:i,title:r,deviceId:s});return o.button.addEventListener("click",()=>{n()}),this.addStyles(e),this.animateIn(o),o}async animateIn(e){window.document.body.appendChild(e.fragment),await Ke(10),e.container.classList.add("active"),await Ke(500),e.container.classList.add("animate"),await Ke(1500),e.container.classList.remove("animate")}async animateOut(e){e.container.classList.remove("active"),await Ke(1e3),this.env.win.location.reload()}createElements({controlName:e,content:t,url:i,title:r,deviceId:s}){const n=window.document;let o,a;switch(e){case"experiment":o=this.experimentIcon,a="Exit preview";break;case"debug":o=this.debugIcon,a="Exit from debug mode"}const c=`${o}<div class="pulse-debug-ctrl-${e}-details">\n                                <div class="pulse-debug-ctrl-${e}-title">\n                                    <a href="${i}" title="${r}" target="_blank">${t}</a>\n                                </div>\n                            <div>\n                            ${s?`<p class="pulse-debug-ctrl-${e}-device-id">${s} ${this.copyIcon(s)}</p>`:""}\n                            <button>${a}</button>\n                            </div>\n                            </div>`,u=n.createElement("div");u.classList.add(`pulse-debug-ctrl-${e}-badge`),u.innerHTML=c;const h=n.createDocumentFragment();h.appendChild(u);const l=h.querySelector(`.pulse-debug-ctrl-${e}-details button`);return{container:u,fragment:h,button:l}}addStyles(e){const t=`\n        .pulse-debug-ctrl-${e}-badge {\n            display: flex;\n            position: fixed;\n            z-index: 9999999999;\n            box-sizing: border-box;\n            align-items: center;\n            width: 310px;\n            height: 60px;\n            bottom: ${"debug"===e?"55vh":"48vh"};\n            right: 0;\n            border: solid 1px #ff6d91;\n            border-right: none;\n            border-radius: 1000px;\n            border-top-right-radius: 0;\n            border-bottom-right-radius: 0;\n            box-shadow: 0 2px 25px rgba(255, 0, 130, 0.1);\n            color: #fff;\n            text-align: center;\n            font-family: sans-serif;\n            font-size: 10px;\n            background-color: #1b1b1b;\n            -webkit-user-select: none;\n            -ms-user-select: none;\n            user-select: none;\n            transition: transform 0.2s;\n            transform: translateX(345px);\n        }\n\n        .pulse-debug-ctrl-${e}-badge .pulse-debug-ctrl-copy-icon{\n            cursor: pointer;\n        }\n\n        .pulse-debug-ctrl-${e}-badge .${this.debugCtrlIconKey} {\n            margin: 0 10px 0 10px;\n        }\n\n        .pulse-debug-ctrl-${e}-badge.active {\n            transition-delay: 0.5s;\n            transform: translateX(275px);\n        }\n\n        .pulse-debug-ctrl-${e}-badge.active:hover {\n            transform: translateX(0);\n        }\n\n        .pulse-debug-ctrl-${e}-badge .pulse-debug-ctrl-${e}-details {\n            width: 10px;\n            flex-grow: 1111;\n        }\n        \n        .pulse-debug-ctrl-${e}-badge .pulse-debug-ctrl-${e}-device-id {\n            margin: 0px 0px 3px 0px;\n        }\n\n        .pulse-debug-ctrl-${e}-device-id {\n            cursor: pointer;\n        }\n\n        .pulse-debug-ctrl-${e}-badge .pulse-debug-ctrl-${e}-title {\n            white-space: nowrap;\n            overflow: hidden;\n            text-overflow: ellipsis;\n            width: 100%;\n            text-align: center;\n            padding: 0;\n            margin: 0 0 3px 0;\n            display: block;\n        }\n\n        .pulse-debug-ctrl-${e}-badge .pulse-debug-ctrl-${e}-title a {\n            color: #fff;\n            text-decoration: none;\n            padding: 0;\n            margin: 0;\n        }\n\n        .pulse-debug-ctrl-${e}-badge .pulse-debug-ctrl-${e}-title a:hover {\n            text-decoration: underline;\n        }\n\n        .pulse-debug-ctrl-${e}-badge button {\n            padding: 1px 5px;\n            border: solid 1px #ff6d91;\n            border-radius: 3px;\n            cursor: pointer;\n            background: none;\n            color: #ff6d91;\n            font-size: 10px;\n            transition: all 0.15s;\n        }\n\n        .pulse-debug-ctrl-${e}-badge button:hover {\n            color: #fff;\n            background-color: #bb1367;\n            border: solid 1px #bb1367;\n        }\n\n        .pulse-debug-ctrl-${e}-badge:before,\n        .pulse-debug-ctrl-${e}-badge:after {\n            position: absolute;\n            content: "";\n            display: block;\n            width: 140%;\n            height: 100%;\n            left: -20%;\n            z-index: -1000;\n            transition: all ease-in-out 0.5s;\n            background-repeat: no-repeat;\n        }\n\n        .pulse-debug-ctrl-${e}-badge:before {\n            display: none;\n            top: -75%;\n            background-image: radial-gradient(circle, #ff0081 20%, transparent 20%),\n                            radial-gradient(circle, transparent 20%, #ff0081 20%, transparent 30%),\n                            radial-gradient(circle, #ff0081 20%, transparent 20%),\n                            radial-gradient(circle, #ff0081 20%, transparent 20%),\n                            radial-gradient(circle, transparent 10%, #ff0081 15%, transparent 20%),\n                            radial-gradient(circle, #ff0081 20%, transparent 20%),\n                            radial-gradient(circle, #ff0081 20%, transparent 20%),\n                            radial-gradient(circle, #ff0081 20%, transparent 20%),\n                            radial-gradient(circle, #ff0081 20%, transparent 20%);\n            background-size: 10% 10%, 20% 20%, 15% 15%, 20% 20%, 18% 18%, 10% 10%, 15% 15%, 10% 10%, 18% 18%;\n        }\n\n        .pulse-debug-ctrl-${e}-badge:after {\n            display: none;\n            bottom: -75%;\n            background-image: radial-gradient(circle, #ff0081 20%, transparent 20%),\n                            radial-gradient(circle, #ff0081 20%, transparent 20%),\n                            radial-gradient(circle, transparent 10%, #ff0081 15%, transparent 20%),\n                            radial-gradient(circle, #ff0081 20%, transparent 20%),\n                            radial-gradient(circle, #ff0081 20%, transparent 20%),\n                            radial-gradient(circle, #ff0081 20%, transparent 20%),\n                            radial-gradient(circle, #ff0081 20%, transparent 20%);\n            background-size: 15% 15%, 20% 20%, 18% 18%, 20% 20%, 15% 15%, 10% 10%, 20% 20%;\n        }\n\n        .pulse-debug-ctrl-${e}-badge.animate:before {\n            display: block;\n            animation: topBubbles ease-in-out 0.75s forwards;\n        }\n\n        .pulse-debug-ctrl-${e}-badge.animate:after {\n            display: block;\n            animation: bottomBubbles ease-in-out 0.75s forwards;\n        }\n\n        @keyframes topBubbles {\n            0% {\n                background-position: 5% 90%, 10% 90%, 10% 90%, 15% 90%, 25% 90%, 25% 90%, 40% 90%, 55% 90%, 70% 90%;\n            }\n            50% {\n                background-position: 0 80%, 0% 20%, 10% 40%, 20% 0%, 30% 30%, 22% 50%, 50% 50%, 65% 20%, 90% 30%;\n            }\n            100% {\n                background-position: 0 70%, 0% 10%, 10% 30%, 20% -10%, 30% 20%, 22% 40%, 50% 40%, 65% 10%, 90% 20%;\n                background-size: 0 0%, 0% 0%, 0% 0%, 0% 0%, 0% 0%, 0% 0%;\n            }\n        }\n\n        @keyframes bottomBubbles {\n            0% {\n                background-position: 10% -10%, 30% 10%, 55% -10%, 70% -10%, 85% -10%, 70% -10%, 70% 0%;\n            }\n            50% {\n                background-position: 0 80%, 20% 80%, 45% 60%, 60% 100%, 75% 70%, 95% 60%, 105% 0%;\n            }\n            100% {\n                background-position: 0 90%, 20% 90%, 45% 70%, 60% 110%, 75% 80%, 95% 70%, 110% 10%;\n                background-size: 0 0%, 0% 0%, 0% 0%, 0% 0%, 0% 0%, 0% 0%;\n            }\n        }\n        `,i=document.head||document.getElementsByTagName("head")[0],r=document.createElement("style");r.appendChild(document.createTextNode(t)),i.appendChild(r)}}class it{page;constructor(e){this.page=e}getUTMParams(){const e=new URL(He(this.page.landingPageUrl())),t=e.searchParams.get("utm_source"),i=e.searchParams.get("utm_medium"),r=e.searchParams.get("utm_campaign"),s=e.searchParams.get("utm_term")||"",n=e.searchParams.get("utm_content")||"";if(t||r)return{utm_source:t||void 0,utm_medium:i||void 0,utm_campaign:r||void 0,utm_term:s||void 0,utm_content:n||void 0}}}class rt{}class st extends rt{}class nt extends st{}class ot extends st{}class at extends ot{}class ct{unsafeShortHash(e){let t=5381,i=e.length;for(;i;)t=33*t^e.charCodeAt(--i);return t>>>=0,t.toString(36)}}class ut{pulseStorage;cookieStorage;dateService;responseTrackerService;cacheService;usageTrackerService;eventAdapterService;config;experiments=[];experimentsSubject$=new je(1);constructor(e,t,i,r,s,n,o,a){this.pulseStorage=e,this.cookieStorage=t,this.dateService=i,this.responseTrackerService=r,this.cacheService=s,this.usageTrackerService=n,this.eventAdapterService=o,this.config=a,this.cookieStorage.remove(this.config.experimentStorageKey),this.experiments=this.pulseStorage.getJSON(this.config.experimentStorageKey),this.experiments&&this.experiments.length>0&&this.experimentsSubject$.next(this.experiments),this.responseTrackerService.responses().subscribe(e=>{this.cacheResponse(e)}),this.usageTrackerService.usages().subscribe(e=>{const t=this.findUnparticipatedExperiment(e.key);t&&this.experiments&&(this.eventAdapterService.push({pulse:"event",event_type:"experiment_participate",data:{experiment_id:t.name,variant:t.variant}}),this.experiments=this.experiments.map(e=>{const t=void 0===e?.actual||e?.actual;return{...e,actual:t}}),this.cacheExperiments(this.experiments))}),this.pulseStorage.change(this.config.experimentStorageKey).subscribe(e=>{e.value?this.experiments=JSON.parse(e.value):this.experiments=[],this.experimentsSubject$.next(this.experiments||[])})}getExperiments(){return this.pulseStorage.getJSON(this.config.experimentStorageKey)||[]}getExperiments$(){return this.experimentsSubject$.asObservable()}getExperimentsString(){return this.getExperiments().map(e=>`${e.name}:${e.variant}`).join(",")}getExperimentsString$(){return this.experimentsSubject$.asObservable().pipe(pe(e=>e.map(e=>`${e.name}:${e.variant}`).join(",")))}fireExperimentPopulation(e){e&&e.length&&e.forEach(e=>{e.trackable&&this.eventAdapterService.push({pulse:"event",event_type:"experiment_populate",data:{experiment_id:e.name,variant:e.variant}})})}cacheResponse(e){if(!e.experiments)return;e.experiments=e.experiments.map(e=>({...e,actual:!0}));const t=this.findNewExperiments(e.experiments),i=this.experimentDifferent(e.experiments);t&&t.length&&(this.cacheService.removeCachedSettings(t),this.cacheExperiments(e.experiments)),t&&t.length||!i||this.cacheExperiments(e.experiments),this.fireExperimentPopulation(t)}cacheExperiments(e){const t=this.dateService.now(),i=this.getExperiments(),r=[...e.map(e=>{const r=i.find(t=>t.name===e.name),s=r?.participation_date||e?.participation_date||null,n=r?.participation_session||e?.participation_session||null;return{...e,participation_date:s,participation_session:n,time:t}}),...i.filter(t=>!e.some(e=>e.name===t.name)).map(e=>({...e,actual:!1}))];this.experiments=r,this.pulseStorage.remove(this.config.experimentStorageKey),this.pulseStorage.set(this.config.experimentStorageKey,JSON.stringify(r)),this.experimentsSubject$.next(r)}findNewExperiments(e){const t=this.getExperiments();if(!t)return e;return e.filter(e=>-1===t.findIndex(t=>t.name===e.name))}experimentDifferent(e){if(!this.experiments||!this.experiments.length)return!1;for(const t of this.experiments)if(-1===e.findIndex(e=>e.name===t.name))return!0;return!1}findUnparticipatedExperiment(e){if(!this.experiments||!this.experiments.length)return null;for(const t of this.experiments)if(t.settings?.includes(e)&&!t.participation_date)return t.participation_date=this.dateService.now(),t.participation_session=this.pulseStorage.get(this.config.keySessionID),t;return null}}class ht{responseTracker;storage;deviceId;date;storageKey;constructor(e,t,i,r){this.responseTracker=e,this.storage=t,this.deviceId=i,this.date=r,this.storageKey=`segments-${this.deviceId.getDeviceId().substring(0,5)}`,this.responseTracker.responses().subscribe(e=>{Array.isArray(e.segments)&&this.persist(e.segments)})}async getSegments(){const e=this.read();return e?.segments||[]}persist(e){this.storage.setJSON(this.storageKey,{segments:e,ts:this.date.now()})}read(){return this.storage.getJSON(this.storageKey)}}class lt{crypto;constructor(e){this.crypto=e}shouldReturnDefaultValue(e,t,i,r,s){if(!e)return!0;if(t.firstCallDone&&t.defaultReturned)return!0;const n="string"==typeof s?.cachedSetting.emptyForTags?s.cachedSetting.emptyForTags.split(","):[];return!(s?.timedOut||void 0!==s?.cachedSetting[i]||!n.includes(r))}getAttributesHash({tag:e,attributes:t,userRole:i,isTest:r,userId:s,tierId:n,deviceLastTierId:o,debugExperiment:a,appVersion:c}){return this.crypto.unsafeShortHash(`${e}-${i}-${r}-${s}-${n}-${o}-${a}-${JSON.stringify(t)}-${c}`)}}const dt={id:"",variant:"",app:"",name:"",url:""},pt={referrer:{url:"",internal:!1},landingPageURL:"",clickId:{source:"",value:""},utmParams:{utm_source:"",utm_medium:"",utm_campaign:"",utm_content:""}};class gt{responseTrackerService;deviceIdService;experimentsService;experimentDebugService;trafficSourceService;config;httpService;constructor(e,t,i,r,s,n,o){this.responseTrackerService=e,this.deviceIdService=t,this.experimentsService=i,this.experimentDebugService=r,this.trafficSourceService=s,this.config=n,this.httpService=o}composeRequestURL({app:e,app_version:t,tag:i,settingsBaseURL:r,deviceId:s,userId:n,tierId:o,deviceLastTierId:a,userRole:c,isTest:u,experiments:h,debugExperiment:l,trafficSource:d,attributes:p}){const g=new URL(`${r}/${e}/${i}`);if(g.searchParams.set("did",s),n&&g.searchParams.set("uid",n),o&&g.searchParams.set("tid",o),a&&g.searchParams.set("dltid",a),c&&g.searchParams.set("ur",c),u&&g.searchParams.set("is-test",u),t&&"0"!==t&&g.searchParams.set("versioncode",t),h&&g.searchParams.set("exp",h),l&&l!==dt&&g.searchParams.set("debug-exp",`${l.id}:${l.variant}`),d?.referrer&&d!==pt&&g.searchParams.set("ref",d.referrer.url),d?.clickId&&d!==pt&&g.searchParams.set("cidp",d.clickId.source),d?.utmParams&&d!==pt){const{utm_source:e,utm_medium:t,utm_campaign:i,utm_content:r}=d.utmParams;e&&g.searchParams.set("usrc",e),t&&g.searchParams.set("umed",t),i&&g.searchParams.set("ucmp",i),r&&g.searchParams.set("ucnt",r)}const f=Object.entries(p);if(f.length>0&&f.length<=10)for(const[e,t]of f)g.searchParams.set(`attr-${e}`,t);return g}handleResponse(e,t,i,r,s,n,o,a){i(t),this.cacheResponse(t,e,r,s,n,o,a)}async cacheResponse(e,t,i,r,s,n,o){let a;a=e.body instanceof ReadableStream&&e instanceof Response?await e.clone().json():e.body;const c={settings:a.settings,experiments:a.experiments,segments:a.segments,tag:t,emptyForTags:r,attributesHash:o};e&&"object"==typeof e&&200===e?.status&&a?.settings&&(n.firstCallDone||(s("firstCallDone",!0,n),s("defaultReturned",!1,n)),"object"!=typeof c.settings||null===c.settings||i in c.settings||(r.push(t),c.settings[i]=void 0),this.responseTrackerService.trackResponse(c))}createFakeResponse(e,t,i,r){return t.firstCallDone||(i("firstCallDone",!0,t),i("defaultReturned",!0,t)),{ok:!1,body:{settings:{},experiments:[],segments:[],tag:e,emptyForTags:[],attributesHash:r},headers:new Map([]),status:null}}async fetchSettings(e,t,i,r,s,n,o,a,c,u,h,l,d){if(!o.app)throw new Error("Application name has not been provided to settings SDK!");const p=this.composeRequestURL({tag:e,userRole:t,isTest:i,attributes:n,app:o.app,app_version:o.app_version||"0",deviceId:this.deviceIdService.getDeviceId(),userId:a?.toString()||null,tierId:c?.toString()||null,deviceLastTierId:u?.toString()||null,experiments:this.experimentsService.getExperimentsString(),debugExperiment:this.experimentDebugService.getDebugExperiment()||dt,trafficSource:this.trafficSourceService.getLastTrafficSource()||pt,settingsBaseURL:this.config.settingsBaseURL});return new Promise(t=>{const i=setTimeout(()=>t(this.createFakeResponse(e,h,l,d)),this.config.timeout);this.httpService.get(p.href,{},"high").then(n=>{clearTimeout(i),this.handleResponse(e,n,t,r,s,l,h,d)}).catch(()=>{clearTimeout(i),t(this.createFakeResponse(e,h,l,d))})})}}class ft{storage;cookieStorage;page;config;routeHelper;debugControlService;experiment=null;experimentSubject$=new je(1);constructor(e,t,i,r,s,n){this.storage=e,this.cookieStorage=t,this.page=i,this.config=r,this.routeHelper=s,this.debugControlService=n;const o=new URL(this.page.landingPageUrl()).searchParams.get("pulse-debug-exp")||this.storage.get("debug-exp"),a=this.parseExperimentInfo(o);this.cookieStorage.remove("debug-exp"),this.routeHelper.cleanupURL("pulse-debug-exp"),o&&a?(o&&this.storage.set("debug-exp",o),this.setExperiment(a),this.debugControlService.registerControl({control:"experiment",url:a.url,title:`Debugging Experiment [${a.id}]: ${a.name}\n\nVariant: ${a.variant}`,callbackFn:this.stopDebugging.bind(this),content:`${a.variant} ${a.name}`})):this.experimentSubject$.next(null)}getDebugExperiment(){return this.experiment}getDebugExperiment$(){return this.experimentSubject$.asObservable()}setExperiment(e){this.experiment=e,this.experimentSubject$.next(e)}stopDebugging(){this.setExperiment(null),this.storage.remove("debug-exp"),this.debugControlService.unregisterControl("experiment")}parseExperimentInfo(e){if("string"!=typeof e||!e.length)return null;try{const[t,i,r,s,n]=JSON.parse(e);return t!==this.config.app?null:{app:t,id:i,name:r,variant:s,url:n}}catch(e){return console.error("Failed to parse debug experiment info!"),console.error(e),null}}}var vt=Array.isArray,bt=Object.getPrototypeOf,mt=Object.prototype,yt=Object.keys;function St(e){if(1===e.length){var t=e[0];if(vt(t))return{args:t,keys:null};if((r=t)&&"object"==typeof r&&bt(r)===mt){var i=yt(t);return{args:i.map(function(e){return t[e]}),keys:i}}}var r;return{args:e,keys:null}}function wt(e,t,i,r,s){void 0===r&&(r=0),void 0===s&&(s=!1);var n=t.schedule(function(){i(),s?e.add(this.schedule(null,r)):this.unsubscribe()},r);if(e.add(n),!s)return n}function _t(e,t){return void 0===t&&(t=0),Y(function(i,r){i.subscribe(Q(r,function(i){return wt(r,e,function(){return r.next(i)},t)},function(){return wt(r,e,function(){return r.complete()},t)},function(i){return wt(r,e,function(){return r.error(i)},t)}))})}function Et(e,t){return void 0===t&&(t=0),Y(function(i,r){r.add(e.schedule(function(){return i.subscribe(r)},t))})}function Tt(e,t){if(!e)throw new Error("Iterable cannot be null");return new H(function(i){wt(i,t,function(){var r=e[Symbol.asyncIterator]();wt(i,t,function(){r.next().then(function(e){e.done?i.complete():i.next(e.value)})},0,!0)})})}function kt(e,t){if(null!=e){if(ie(e))return function(e,t){return he(e).pipe(Et(t),_t(t))}(e,t);if(ee(e))return function(e,t){return new H(function(i){var r=0;return t.schedule(function(){r===e.length?i.complete():(i.next(e[r++]),i.closed||this.schedule())})})}(e,t);if(te(e))return function(e,t){return he(e).pipe(Et(t),_t(t))}(e,t);if(re(e))return Tt(e,t);if(ae(e))return function(e,t){return new H(function(i){var r;return wt(i,t,function(){r=e[oe](),wt(i,t,function(){var e,t,s;try{t=(e=r.next()).value,s=e.done}catch(e){return void i.error(e)}s?i.complete():i.next(t)},0,!0)}),function(){return f(null==r?void 0:r.return)&&r.return()}})}(e,t);if(ue(e))return function(e,t){return Tt(ce(e),t)}(e,t)}throw se(e)}function It(e,t){return t?kt(e,t):he(e)}var Ct=Array.isArray;function xt(e){return pe(function(t){return function(e,t){return Ct(t)?e.apply(void 0,l([],h(t))):e(t)}(e,t)})}function Pt(e){return e&&f(e.schedule)}function At(e){return e[e.length-1]}function Nt(e){return Pt(At(e))?e.pop():void 0}function Ot(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=Nt(e),r=function(e){return f(At(e))?e.pop():void 0}(e),s=St(e),n=s.args,o=s.keys;if(0===n.length)return It([],i);var a=new H(function(e,t,i){void 0===i&&(i=j);return function(r){Rt(t,function(){for(var s=e.length,n=new Array(s),o=s,a=s,c=function(s){Rt(t,function(){var c=It(e[s],t),u=!1;c.subscribe(Q(r,function(e){n[s]=e,u||(u=!0,a--),a||r.next(i(n.slice()))},function(){--o||r.complete()}))},r)},u=0;u<s;u++)c(u)},r)}}(n,i,o?function(e){return function(e,t){return e.reduce(function(e,i,r){return e[i]=t[r],e},{})}(o,e)}:j));return r?a.pipe(xt(r)):a}function Rt(e,t,i){e?wt(i,e,t):t()}function Lt(e,t,i){return void 0===i&&(i=1/0),f(t)?Lt(function(i,r){return pe(function(e,s){return t(i,e,r,s)})(he(e(i,r)))},i):("number"==typeof t&&(i=t),Y(function(t,r){return function(e,t,i,r,s,n,o,a){var c=[],u=0,h=0,l=!1,d=function(){!l||c.length||u||t.complete()},p=function(e){return u<r?g(e):c.push(e)},g=function(e){n&&t.next(e),u++;var a=!1;he(i(e,h++)).subscribe(Q(t,function(e){null==s||s(e),n?p(e):t.next(e)},function(){a=!0},void 0,function(){if(a)try{u--;for(var e=function(){var e=c.shift();o?wt(t,o,function(){return g(e)}):g(e)};c.length&&u<r;)e();d()}catch(e){t.error(e)}}))};return e.subscribe(Q(t,p,function(){l=!0,d()})),function(){null==a||a()}}(t,r,e,i)}))}function Dt(e){return void 0===e&&(e=1/0),Lt(j,e)}function Mt(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Dt(1)(It(e,Nt(e)))}function $t(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=Nt(e);return Y(function(t,r){(i?Mt(e,t,i):Mt(e,t)).subscribe(r)})}class Ut{settingsHelper;settingsFetchHelper;cacheService;config;usageTrackerService;experimentDebugService;hashStore;lockManager;queueService;userRoleService;isTestService;stateService;clientAttributesService;observers=new Map;subjects=new Map;revalidate=new K;firstCallState={firstCallDone:!1,defaultReturned:!1};lock=[];syncIndexedDB;constructor(e,t,i,r,s,n,o,a,c,u,h,l,d){this.settingsHelper=e,this.settingsFetchHelper=t,this.cacheService=i,this.config=r,this.usageTrackerService=s,this.experimentDebugService=n,this.hashStore=o,this.lockManager=a,this.queueService=c,this.userRoleService=u,this.isTestService=h,this.stateService=l,this.clientAttributesService=d,this.userRoleService.setFromQueryParams(),this.isTestService.setFromQueryParams(),this.getPrefetchSettings(),Ot({state:this.stateService.getState$().pipe($t(this.stateService.getStateInternal())),userRole:this.userRoleService.getValue$().pipe($t(this.userRoleService.getValue())),isTest:this.isTestService.getValue$().pipe($t(this.isTestService.getValue()))}).subscribe({next:({state:e,userRole:t,isTest:i})=>{this.refreshStateProps({state:e,userRole:t||"",isTest:i||""})}}),this.syncIndexedDB=this.cacheService.updateInMemorySettings()}observe(e,t,i,r,s){return new H(n=>{this.observers.set(t,[...this.observers.get(t)||[],n]);const o=this.subjects.get(t),a=(o||this.getSettings(e,t,i,r,s)).subscribe(n);return()=>{const e=this.observers.get(t)?.filter(e=>e!==n)||[];0===e.length?this.observers.delete(t):this.observers.set(t,e),a.unsubscribe()}})}getSettings(e,t,i,r,s){return new H(n=>{this.get(e,t,i,r,s).then(e=>{n.next(e)});const o=this.revalidate.subscribe(()=>{this.get(e,t,i,r,s).then(e=>{n.next(e)})});return()=>{o.unsubscribe()}})}async get(e,t,i,r=!0,s){const n=void 0!==i?i:this.config.defaults[t];if(this.settingsHelper.shouldReturnDefaultValue(r,this.firstCallState,t,e,this.cacheService.getCachedSettings(t)))return this.usageTrackerService.trackUsage(e,t,n);const o=this.experimentDebugService.getDebugExperiment(),a=o?`${this.config.app}:${o.id}:${o.variant}`:null;let c;this.hashStore.changed("debug-experiment",a)&&this.cacheService.clearCache(),await this.syncIndexedDB;const u=this.cacheService.getCachedSettings(t),h="string"==typeof u?.cachedSetting.emptyForTags?u.cachedSetting.emptyForTags.split(","):[],l=u?.cachedSetting?.attributesHash,d=this.userRoleService.getValue()||"",p=this.isTestService.getValue(),g=this.settingsHelper.getAttributesHash({tag:e,userRole:String(d??""),isTest:String(p??""),userId:String(this.stateService.getStateInternal().user_id??""),tierId:String(this.stateService.getStateInternal().tier_id??""),deviceLastTierId:String(this.stateService.getStateInternal().device_last_tier_id??""),debugExperiment:o?`${o.id}:${o.variant}`:"",attributes:s||{},appVersion:this.config.app_version||"0"});if(u?.cachedSetting&&l!==g&&(u.timedOut=!0),!u?.timedOut&&void 0===u?.cachedSetting[t]&&h.includes(e))return this.usageTrackerService.trackUsage(e,t,n);if(void 0!==u&&u.cachedSetting&&!u.timedOut&&void 0!==u.cachedSetting[t])return this.usageTrackerService.trackUsage(e,t,u.cachedSetting[t]);if(this.lock.includes(g))return await this.queueService.waitQueueOpen(g,this.config.timeout,this.lock),this.getFromCacheAndReturn({settingName:t,settingDefaultValue:n,tag:e,userRole:d,isTest:p,debugExperiment:o,attributes:s});this.lock.push(g);if(await this.lockManager.locked(g))return await this.queueService.waitQueueOpen(g,this.config.timeout,this.lock),await this.getFromCacheAndReturn({settingName:t,settingDefaultValue:n,tag:e,userRole:d,isTest:p,debugExperiment:o,attributes:s});{this.lock.includes(g)||this.lock.push(g);const i=await this.lockManager.request(g,this.config.timeout);c=await this.settingsFetchHelper.fetchSettings(e,d,p,t,h,s||{},this.config,String(this.stateService.getStateInternal().user_id??""),String(this.stateService.getStateInternal().tier_id??""),String(this.stateService.getStateInternal().device_last_tier_id??""),this.firstCallState,this.mutateFirstCallState,g);const r=c?.body?.settings;let o=r&&r[t];return void 0===o&&(o=u?.cachedSetting[t]||n),this.lock.includes(g)&&this.lock.splice(this.lock.indexOf(g),1),i&&this.lockManager.release(i),this.usageTrackerService.trackUsage(e,t,o)}}getFromCacheAndReturn({settingName:e,settingDefaultValue:t,tag:i,userRole:r,isTest:s,debugExperiment:n,attributes:o}){const a=this.settingsHelper.getAttributesHash({tag:i,userRole:String(r??""),isTest:String(s??""),userId:String(this.stateService.getStateInternal().user_id??""),tierId:String(this.stateService.getStateInternal().tier_id??""),deviceLastTierId:String(this.stateService.getStateInternal().device_last_tier_id??""),debugExperiment:n?`${n.id}:${n.variant}`:"",attributes:o||{},appVersion:this.config.app_version||"0"});this.lock.includes(a)&&this.lock.splice(this.lock.indexOf(a),1);const c=this.cacheService.getCachedSettings(e);let u;if(c?.cachedSetting&&void 0!==c?.cachedSetting[e])u=c?.cachedSetting[e];else{const t="string"==typeof c?.cachedSetting.emptyForTags?c.cachedSetting.emptyForTags.split(","):[];t.includes(i)||t.push(i),this.cacheService.cacheSettings({[e]:void 0},i,t,a)}return u=void 0!==u?u:t,this.usageTrackerService.trackUsage(i,e,u)}refreshStateProps({state:e,userRole:t,isTest:i}){const r=e.user_id,s=e.tier_id,n=e.device_last_tier_id;(this.hashStore.changed("user_id",r)||this.hashStore.changed("tier_id",s)||this.hashStore.changed("device_last_tier_id",n)||this.hashStore.changed("user_role",t)||this.hashStore.changed("is_test",i))&&this.revalidate.next(!0)}getPrefetchSettings(){let e="";const t=this.clientAttributesService.getPulseScript();if(t){e=new URLSearchParams(t.search).get("prefetch")}if(e&&t){const t=this.clientAttributesService.getAttributes();e.split(",").forEach(e=>{this.get(e,`${this.config.storagePrefix}${e}_prefetched`,{},!0,t)})}}mutateFirstCallState(e,t,i){i?i[e]=t:this.firstCallState[e]=t}}class Bt{pulseStorage;cookieStorage;STORAGE_KEY;value=null;valueSubject$=new je(1);constructor(e,t,i){this.pulseStorage=e,this.cookieStorage=t,this.STORAGE_KEY=i,this.subscribeToChanges(),this.cookieStorage.remove(this.STORAGE_KEY)}subscribeToChanges(){this.pulseStorage.change(this.STORAGE_KEY).subscribe(e=>{this.setValue(e.value)})}setValue(e){e!==this.value&&(this.value=e,this.valueSubject$.next(e))}getValue(){return this.value}getValue$(){return this.valueSubject$.asObservable()}setFromQueryParams(){let e=this.pulseStorage.get(this.STORAGE_KEY);if(null===e&&document?.currentScript instanceof HTMLScriptElement){e=new URLSearchParams(document?.currentScript.src).get(this.STORAGE_KEY)}this.setValue(e)}}class jt extends Bt{pulseStorage;cookieStorage;STORAGE_KEY;constructor(e,t,i="ur"){super(e,t,i),this.pulseStorage=e,this.cookieStorage=t,this.STORAGE_KEY=i}}class Ft extends Bt{pulseStorage;cookieStorage;STORAGE_KEY;constructor(e,t,i="is-test"){super(e,t,i),this.pulseStorage=e,this.cookieStorage=t,this.STORAGE_KEY=i}}function Ht(e,t){return void 0===t&&(t=j),e=null!=e?e:Vt,Y(function(i,r){var s,n=!0;i.subscribe(Q(r,function(i){var o=t(i);!n&&e(s,o)||(n=!1,s=o,r.next(i))}))})}function Vt(e,t){return e===t}var qt=new H(function(e){return e.complete()});function Kt(e){return e<=0?function(){return qt}:Y(function(t,i){var r=0;t.subscribe(Q(i,function(t){++r<=e&&(i.next(t),e<=r&&i.complete())}))})}var zt=function(e){function t(t,i){return e.call(this)||this}return o(t,e),t.prototype.schedule=function(e,t){return void 0===t&&(t=0),this},t}(y),Gt={setInterval:function(e,t){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];var s=Gt.delegate;return(null==s?void 0:s.setInterval)?s.setInterval.apply(s,l([e,t],h(i))):setInterval.apply(void 0,l([e,t],h(i)))},clearInterval:function(e){var t=Gt.delegate;return((null==t?void 0:t.clearInterval)||clearInterval)(e)},delegate:void 0},Jt=function(e){function t(t,i){var r=e.call(this,t,i)||this;return r.scheduler=t,r.work=i,r.pending=!1,r}return o(t,e),t.prototype.schedule=function(e,t){var i;if(void 0===t&&(t=0),this.closed)return this;this.state=e;var r=this.id,s=this.scheduler;return null!=r&&(this.id=this.recycleAsyncId(s,r,t)),this.pending=!0,this.delay=t,this.id=null!==(i=this.id)&&void 0!==i?i:this.requestAsyncId(s,this.id,t),this},t.prototype.requestAsyncId=function(e,t,i){return void 0===i&&(i=0),Gt.setInterval(e.flush.bind(e,this),i)},t.prototype.recycleAsyncId=function(e,t,i){if(void 0===i&&(i=0),null!=i&&this.delay===i&&!1===this.pending)return t;null!=t&&Gt.clearInterval(t)},t.prototype.execute=function(e,t){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var i=this._execute(e,t);if(i)return i;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},t.prototype._execute=function(e,t){var i,r=!1;try{this.work(e)}catch(e){r=!0,i=e||new Error("Scheduled action threw falsy error")}if(r)return this.unsubscribe(),i},t.prototype.unsubscribe=function(){if(!this.closed){var t=this.id,i=this.scheduler,r=i.actions;this.work=this.state=this.scheduler=null,this.pending=!1,m(r,this),null!=t&&(this.id=this.recycleAsyncId(i,t,null)),this.delay=null,e.prototype.unsubscribe.call(this)}},t}(zt),Wt=function(){function e(t,i){void 0===i&&(i=e.now),this.schedulerActionCtor=t,this.now=i}return e.prototype.schedule=function(e,t,i){return void 0===t&&(t=0),new this.schedulerActionCtor(this,e).schedule(i,t)},e.now=Be.now,e}(),Yt=new(function(e){function t(t,i){void 0===i&&(i=Wt.now);var r=e.call(this,t,i)||this;return r.actions=[],r._active=!1,r}return o(t,e),t.prototype.flush=function(e){var t=this.actions;if(this._active)t.push(e);else{var i;this._active=!0;do{if(i=e.execute(e.state,e.delay))break}while(e=t.shift());if(this._active=!1,i){for(;e=t.shift();)e.unsubscribe();throw i}}},t}(Wt))(Jt),Qt=Yt;function Xt(e){return e instanceof Date&&!isNaN(e)}var Zt,ei=v(function(e){return function(t){void 0===t&&(t=null),e(this),this.message="Timeout has occurred",this.name="TimeoutError",this.info=t}});function ti(e,t){var i=Xt(e)?{first:e}:"number"==typeof e?{each:e}:e,r=i.first,s=i.each,n=i.with,o=void 0===n?ii:n,a=i.scheduler,c=void 0===a?null!=t?t:Yt:a,u=i.meta,h=void 0===u?null:u;if(null==r&&null==s)throw new TypeError("No timeout provided.");return Y(function(e,t){var i,n,a=null,u=0,l=function(e){n=wt(t,c,function(){try{i.unsubscribe(),he(o({meta:h,lastValue:a,seen:u})).subscribe(t)}catch(e){t.error(e)}},e)};i=e.subscribe(Q(t,function(e){null==n||n.unsubscribe(),u++,t.next(a=e),s>0&&l(s)},void 0,void 0,function(){(null==n?void 0:n.closed)||null==n||n.unsubscribe(),a=null})),!u&&l(null!=r?"number"==typeof r?r:+r-c.now():s)})}function ii(e){throw new ei(e)}function ri(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return It(e,Nt(e))}function si(e){return Z(function(t,i){return e<=i})}function ni(e,t){return f(t)?Lt(e,t,1):Lt(e,1)}class oi{settingsObserver;config;experimentsService;segmentsResolver;firstCallState={firstCallDone:!1,defaultReturned:!1};constructor(e,t,i,r){this.settingsObserver=e,this.config=t,this.experimentsService=i,this.segmentsResolver=r}observe(e,t,i,r,s=!0){return new H(n=>{const o=this.settingsObserver.observe(e,t,i,s,r).pipe(Ht()),a=o.pipe(Kt(1),ti(this.config.timeout),de(()=>ri(i))),c=o.pipe(si(1)),u=a.pipe(ni(e=>c.pipe($t(e)))).subscribe(n);return()=>{u.unsubscribe()}})}async get(e,t,i,r,s=!0){return W(this.observe(e,t,i,r,s))}async segments(e={}){let t=await this.segmentsResolver.getSegments();return t&&!(t?.length<1)||this.firstCallState.firstCallDone||(await this.get("dummy_tag",`${this.config.storagePrefix}_dummy_tag`,{},e,!0),t=await this.segmentsResolver.getSegments()),Promise.resolve(this.segmentsResolver.getSegments())}async experiments(e={}){let t=this.experimentsService.getExperiments();return t&&!(t?.length<1)||this.firstCallState.firstCallDone||(await this.get("dummy_tag",`${this.config.storagePrefix}_dummy_tag`,{},e,!0),t=this.experimentsService.getExperiments()),Promise.resolve(t)}}class ai{settingsService;stateService;constructor(e,t){this.settingsService=e,this.stateService=t}createPulseSettings(e={},t=!0,i={}){const r=this.settingsService;if(Object.keys(i).length){const e=Object.fromEntries(Object.entries(i).map(([e,t])=>[`attr_${e}`,t])),t=this.stateService.getStateInternal().data??{};this.stateService.setState({data:{...t,...e}})}return{async get(s,n,o){const a=e?.[n];if(!0===o){const e=r.observe(s,n,a,i,t);return{value:await W(e),subscribe:e.subscribe.bind(e)}}return r.get(s,n,a,i,t)},getValue(s,n,o){const a=o??e?.[n];return r.get(s,n,a,i,t)},observe:(e,s,n)=>r.observe(e,s,n,i,t),getSegmentsIds:()=>r.segments(i),getExperiments:()=>r.experiments(i)}}}function ci(e,t){return void 0===t&&(t=Yt),Y(function(i,r){var s=null,n=null,o=null,a=function(){if(s){s.unsubscribe(),s=null;var e=n;n=null,r.next(e)}};function c(){var i=o+e,n=t.now();if(n<i)return s=this.schedule(void 0,i-n),void r.add(s);a()}i.subscribe(Q(r,function(i){n=i,o=t.now(),s||(s=t.schedule(c,e),r.add(s))},function(){a(),r.complete()},void 0,function(){n=s=null}))})}!function(e){e[e.DEVICE_ID=0]="DEVICE_ID",e[e.USER_ID=1]="USER_ID",e[e.IS_TEST=2]="IS_TEST",e[e.EXPERIMENTS=3]="EXPERIMENTS",e[e.DEBUG_EXPERIMENTS=4]="DEBUG_EXPERIMENTS",e[e.REFERRER=5]="REFERRER",e[e.INTERNAL_REFERRER=6]="INTERNAL_REFERRER",e[e.UTM_CAMPAIGN=7]="UTM_CAMPAIGN",e[e.UTM_SOURCE=8]="UTM_SOURCE",e[e.UTM_MEDIUM=9]="UTM_MEDIUM",e[e.CLICK_ID=10]="CLICK_ID",e[e.CLICK_ID_SRC=11]="CLICK_ID_SRC",e[e.TIER_ID=12]="TIER_ID",e[e.DEVICE_LAST_TIER_ID=13]="DEVICE_LAST_TIER_ID",e[e.USER_ROLE=14]="USER_ROLE",e[e.ATTRIBUTES=15]="ATTRIBUTES"}(Zt||(Zt={}));class ui{storage;cookieStorage;config;deviceIdService;experimentsService;utmService;trafficSourceService;userRoleService;settingsHelper;stateService;isTestService;experimentDebugService;syncCookieSubject=new K;pendingUpdates={};constructor(e,t,i,r,s,n,o,a,c,u,h,l){this.storage=e,this.cookieStorage=t,this.config=i,this.deviceIdService=r,this.experimentsService=s,this.utmService=n,this.trafficSourceService=o,this.userRoleService=a,this.settingsHelper=c,this.stateService=u,this.isTestService=h,this.experimentDebugService=l,this.syncCookieSubject.pipe(ci(50)).subscribe(()=>{this.executeSyncCookie(),this.pendingUpdates={}});const d=this.parseCookie(this.cookieStorage.get(this.config.keyPulseSyncCookie)||"");d&&this.updatePulseStateFromCookie(d)}startService(){this.registerStateChangeListeners()}updatePulseStateFromCookie(e){if(e[Zt.DEVICE_ID]&&this.deviceIdService.setDeviceId(e[Zt.DEVICE_ID]),e[Zt.EXPERIMENTS]){const t=this.parseExperimentsFromCookie(e[Zt.EXPERIMENTS]);t.length>0&&this.experimentsService.cacheResponse({experiments:t,emptyForTags:[],attributesHash:""})}}parseExperimentsFromCookie(e){if(!e||!e.trim())return[];try{const t=decodeURIComponent(e);return t.split(",").map(e=>{const[t,i]=e.split(":");return{name:t.trim(),variant:i.trim(),trackable:1,settings:[],participation_session:null,participation_date:null}})}catch(e){return console.error("Failed to parse experiments from cookie:",e),[]}}serializeAttributesForCookie(e){if(!e||0===Object.keys(e).length)return"";const t=new URLSearchParams;return Object.entries(e).forEach(([e,i])=>{i&&t.set(e,i)}),t.toString()}setSyncCookie(e){Object.assign(this.pendingUpdates,e),this.syncCookieSubject.next(e)}executeSyncCookie(){const e=this.deviceIdService.getDeviceId(),t=this.experimentsService.getExperimentsString(),i=this.trafficSourceService.getLastTrafficSource(),r=this.utmService.getUTMParams(),s=this.userRoleService.getValue(),n=this.isTestService.getValue(),o=this.config.attributes;let a="";if(o){const e=this.serializeAttributesForCookie(o);a=e?encodeURIComponent(e):""}const c=this.experimentDebugService.getDebugExperiment(),u=c?`${c.id}:${c.variant}`:"",h=[e,this.storage.get("userId")||"",n||"",t||"",u,i?.referrer?.url||"",i?.referrer?.internal?"true":"",r?.utm_campaign||"",r?.utm_source||"",r?.utm_medium||"",i?.clickId?.value||"",i?.clickId?.source||"",this.storage.get("tierId")||"",this.storage.get("deviceLastTierId")||"",s||"",a];Object.entries(this.pendingUpdates).forEach(([e,t])=>{const i=Zt[e];"number"==typeof i&&void 0!==t&&(h[i]=t)}),this.cookieStorage.set(this.config.keyPulseSyncCookie,h.join("|"))}registerStateChangeListeners(){this.deviceIdService.getDeviceId$().subscribe(e=>{this.setSyncCookie({DEVICE_ID:e})}),this.stateService.getState$().pipe(pe(e=>({user_id:String(e?.user_id||""),tier_id:String(e?.tier_id||""),device_last_tier_id:String(e?.device_last_tier_id||"")})),Ht((e,t)=>e.user_id===t.user_id&&e.tier_id===t.tier_id&&e.device_last_tier_id===t.device_last_tier_id)).subscribe(({user_id:e,tier_id:t,device_last_tier_id:i})=>{this.setSyncCookie({USER_ID:e,TIER_ID:t,DEVICE_LAST_TIER_ID:i})}),this.isTestService.getValue$().subscribe(e=>{this.setSyncCookie({IS_TEST:e||""})}),this.experimentsService.getExperimentsString$().subscribe(e=>{this.setSyncCookie({EXPERIMENTS:e||""})}),this.experimentDebugService.getDebugExperiment$().subscribe(e=>{const t=e?`${e.id}:${e.variant}`:"";this.setSyncCookie({DEBUG_EXPERIMENTS:t})}),this.trafficSourceService.getLastTrafficSource$().subscribe(e=>{this.setSyncCookie({REFERRER:e?.referrer?.url||"",INTERNAL_REFERRER:e?.referrer?.internal?"true":"",CLICK_ID:e?.clickId?.value||"",CLICK_ID_SRC:e?.clickId?.source||"",UTM_CAMPAIGN:e?.utmParams?.utm_campaign||"",UTM_SOURCE:e?.utmParams?.utm_source||"",UTM_MEDIUM:e?.utmParams?.utm_medium||""})}),this.userRoleService.getValue$().subscribe(e=>{this.setSyncCookie({USER_ROLE:e||""})})}parseCookie(e){if(!e)return null;const t=e.split("|");return 16===t.length?t.slice(0,16):null}}function hi(e){if(null===e||"object"!=typeof e)return e;if("function"==typeof globalThis.structuredClone)try{return globalThis.structuredClone(e)}catch{console.warn("structuredClone failed, falling back to deepClonePruningNonStructured",e)}else try{return JSON.parse(JSON.stringify(e))}catch(e){console.warn("Deep clone failed using JSON fallback.",e)}return li(e)}function li(e,t=new WeakMap){if(null===e)return null;const i=typeof e;if("object"!==i){if("function"===i||"symbol"===i||"bigint"===i)return;return"number"!==i||Number.isFinite(e)?e:null}const r=e,s=t.get(r);if(s)return s;if(Array.isArray(r)){const e=new Array(r.length);t.set(r,e);for(let i=0;i<e.length;i+=1){const s=li(r[i],t);e[i]=void 0===s?null:s}return e}const n=Object.getPrototypeOf(r);if(n!==Object.prototype&&null!==n)return;const o={};t.set(r,o);for(const[e,i]of Object.entries(r)){const r=li(i,t);void 0!==r&&(o[e]=r)}return o}class di{indexedDBService;dateService;responseTrackerService;quote;config;settingStorageKey="settingsStore";storedSettings={};constructor(e,t,i,r,s){this.indexedDBService=e,this.dateService=t,this.responseTrackerService=i,this.quote=r,this.config=s,this.responseTrackerService.responses().subscribe(e=>{e.settings&&e.tag&&this.cacheSettings(e.settings,e.tag,e.emptyForTags,e.attributesHash)})}clearCache(){this.storedSettings={},this.indexedDBService.truncate(this.settingStorageKey)}updateInMemorySettings(){return new Promise((e,t)=>{this.indexedDBService.getAllValue(this.settingStorageKey).then(t=>{t&&t.forEach(e=>{e.time<this.dateService.now()-this.config.cacheTimeout?this.indexedDBService.deleteValue(this.settingStorageKey,e.id):this.storedSettings[e.id]=e}),e(!0)}).catch(e=>{t(e)})})}getCachedSettings(e){const t=this.storedSettings[e];if(t){const e=t.time+this.config.cacheTimeout<this.dateService.now();return{cachedSetting:hi(t),timedOut:e}}}cacheSettings(e,t,i,r){const s=this.dateService.now();this.quote.quoteSize().then(n=>{const o=(new TextEncoder).encode(JSON.stringify(e)).length,a=n&&n-o>1e6;for(const[o,c]of Object.entries(e)){const e=i.join();(a||null===n)&&this.indexedDBService.putValue(this.settingStorageKey,{id:o,[o]:c,time:s,tag:t,attributesHash:r,emptyForTags:e})}}).catch(e=>console.log(e));for(const[n,o]of Object.entries(e)){const e=i.join();this.storedSettings[n]={[n]:o,time:s,tag:t,attributesHash:r,emptyForTags:e,version:this.config.app_version}}this.clearTimedOutSettings(t)}removeCachedSettings(e){e.forEach(e=>{e?.settings?.length&&e.settings.forEach(e=>{this.indexedDBService.deleteValue(this.settingStorageKey,e),delete this.storedSettings[e]})})}clearTimedOutSettings(e){for(const[t,i]of Object.entries(this.storedSettings))i.tag===e&&i.time<this.dateService.now()-this.config.cacheTimeout&&delete this.storedSettings[t];this.indexedDBService.getAllValue(this.settingStorageKey).then(t=>{t&&t.forEach(t=>{t.tag===e&&t.time<this.dateService.now()-this.config.cacheTimeout&&this.indexedDBService.deleteValue(this.settingStorageKey,t.id)})}).catch(e=>{console.log(e)})}getAllTags({ur:e,all:t=!1}){const i=this.storedSettings,r=new Set;if(i)for(const[s]of Object.entries(i))(i[s].ur!==e||t)&&r.add(i[s].tag);return r}}class pi{lockManager;constructor(e){this.lockManager=e}async waitQueueOpen(e,t,i=[]){let r=0;do{if(await this.lockManager.locked(e))await Ke(50),r+=50;else{if(!i.includes(e))return e;await Ke(50),r+=50}}while(r<t);return console.error("Request Timed Out For Setting"),null}}class gi{dataLayerService;responses$=new K;constructor(e){this.dataLayerService=e}responses(){return this.responses$.asObservable()}trackResponse(e){this.responses$.next(e);const t=e.experiments?.filter(e=>e?.trackable),i={pulse:"state",segments:e.segments};return t&&(i.experiments=t),this.dataLayerService.pushData(i),e}}class fi{usage$=new K;usages(){return this.usage$.asObservable()}trackUsage(e,t,i){if(function(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}(i)){const r=this.usage$;return new Proxy(i,{get:(s,n)=>(Object.prototype.hasOwnProperty.call(s,n)&&r.next({tag:e,key:t,value:i}),s[n])})}return this.usage$.next({tag:e,key:t,value:i}),i}}const vi=(new ke).provide(function(e){return e.useFactory(nt,e=>e,[ye]).useFactory(ut,(e,t,i,r,s,n,o,a)=>new ut(e(i.cacheStorageType),t,r,s,n,o,a,i),[xe,Re,nt,De,gi,di,fi,Me]).useFactory(ht,(e,t,i,r,s)=>new ht(i,e(t.cacheStorageType),r,s),[xe,nt,gi,Fe,De]).useClass(lt,lt,[ct]).useClass(gt,gt,[gi,Fe,ut,ft,qe,nt,ze]).useFactory(Ut,(e,t,i,r,s,n,o,a,c,u,h,l,d)=>new Ut(t,i,r,e,s,n,o,a,c,u,h,l,d),[nt,lt,gt,di,fi,ft,Je,Oe,pi,jt,Ft,We,Ye]).useFactory(oi,(e,t,i,r)=>new oi(e,t,i,r),[Ut,nt,ut,ht]).useClass(pi,pi,[Oe]).useFactory(di,(e,t,i,r,s)=>new di(t,i,r,s,e),[nt,ve,De,gi,Qe]).useClass(fi,fi,[]).useClass(gi,gi,[Xe]).useClass(ai,ai,[oi,We]).useFactory(ft,(e,t,i,r,s,n)=>new ft(e(t.cacheStorageType),i,r,t,s,n),[xe,nt,Re,Ze,et,tt]).useFactory(jt,(e,t,i)=>new jt(t(e.cacheStorageType),i),[nt,xe,Re]).useFactory(Ft,(e,t,i)=>new Ft(t(e.cacheStorageType),i),[nt,xe,Re]).useFactory(ui,(e,t,i,r,s,n,o,a,c,u,h,l)=>new ui(e(i.cacheStorageType),t,i,r,s,n,o,a,c,u,h,l),[xe,Ae,nt,Fe,ut,it,qe,jt,lt,We,Ft,ft])}).beforeInit(function(e){return{...Ie,...e}}).onInit(async(e,t,i,r)=>{await s(i.win,!0)&&await t.connectDB(),r.startService()},[ve,be,ui]);class bi{env;uuid;lockManager;locks=new Map;constructor(e,t){this.env=e,this.uuid=t,this.lockManager=e.win.navigator.locks}async supported(){let e=!1;try{this.lockManager?.query&&(await(this.lockManager?.query()),e=!0)}catch{e=!1}return"function"==typeof this.lockManager?.request&&"function"==typeof this.lockManager?.query&&"function"==typeof this.env.win.AbortController&&e}async locked(e){if(!this.lockManager)throw new Error("Native LockManager not supported!");return(await this.lockManager.query()).held.some(t=>t.name===e)}request(e,t=1e3){if(!this.lockManager)throw new Error("Native LockManager not supported!");const i=new _e,r=new _e,s=new AbortController,n={signal:s.signal};let o=!1;return this.lockManager.request(e,n,()=>{o=!0;const t={name:e,id:this.uuid.generate(),clientId:"",createdDate:0,task:r};return this.locks.set(e,t),i.resolve(t),r.waitUntilResolved()}).catch(()=>i.resolve(null)),Ke(t).then(()=>{o||(s.abort(),i.resolve(null))}).catch(e=>{console.error(e)}),i.waitUntilResolved()}async release(e){if(!this.lockManager)throw new Error("Native LockManager not supported!");const t=this.locks.get(e.name);t&&t.id===e.id&&(t.task.resolve(),this.locks.delete(t.name))}}var mi=i(682),yi=i.n(mi);const Si=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;const wi=function(e){return"string"==typeof e&&Si.test(e)},_i=[];for(let e=0;e<256;++e)_i.push((e+256).toString(16).slice(1));const Ei=function(e,t=0){const i=function(e,t=0){return(_i[e[t+0]]+_i[e[t+1]]+_i[e[t+2]]+_i[e[t+3]]+"-"+_i[e[t+4]]+_i[e[t+5]]+"-"+_i[e[t+6]]+_i[e[t+7]]+"-"+_i[e[t+8]]+_i[e[t+9]]+"-"+_i[e[t+10]]+_i[e[t+11]]+_i[e[t+12]]+_i[e[t+13]]+_i[e[t+14]]+_i[e[t+15]]).toLowerCase()}(e,t);if(!wi(i))throw TypeError("Stringified UUID is invalid");return i};class Ti{date;env;mersenne;nativePRNG;constructor(e,t){this.date=e,this.env=t,this.nativePRNG=this.getNativePRNG()}generate(){const e=this.date.now();return`a.${this.nativePRNG?"c":"m"}.${e.toString(36)}.${this.generateV4()}`}generateV4(){const e=this.randomValues(new Uint8Array(16));return e[6]=15&e[6]|64,e[8]=63&e[8]|128,Ei(e)}randomValues(e){if(this.nativePRNG)return this.nativePRNG(e);this.mersenne||(this.mersenne=new(yi())(this.weakSeed()));let t=e.length;for(;t--;)e[t]=Math.floor(256*this.mersenne.random());return e}weakSeed(){const e=Array(127).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER));return[this.date.now(),...e]}getNativePRNG(){const e=this.env.win;return e.crypto?.getRandomValues?.bind(e.crypto)||e.msCrypto?.getRandomValues?.bind(e.msCrypto)||void 0}}class ki{storage;date;config;uuid;id;locks;constructor(e,t,i,r,s){this.storage=e,this.date=t,this.config=i,this.uuid=r,this.id=r.generate(),this.locks=this.syncLocks(),this.storage.change("locks",Ue.Full,$e.External).subscribe(e=>{this.syncLocks(e.value)}),s.legacyOnUnload().subscribe(()=>this.releaseAll())}async release(e,t=!0){const i=this.locks.get(e.name);i&&i.clientId===this.id&&i.id===e.id&&(this.locks.delete(i.name),t&&this.syncLocks())}async locked(e){return this.locks.has(e)}async request(e,t=100,i=10){const r=this.date.now();for(;;){const s=await this.lock(e),n=this.date.now()-r>t;if(s||n)return s;await Ke(i)}}async lock(e){if(this.locks.has(e))return null;{const t={name:e,clientId:this.id,id:this.uuid.generate(),createdDate:this.date.now()};return this.locks.set(e,t),this.syncLocks(),t}}syncLocks(e){if(!this.locks||e){const t=e||this.storage.get("locks"),i=JSON.parse(t||"null"),r=new Map(i||[]),s=this.releaseExpiredLocks(r);this.locks=s,r.size!==s.size&&this.writeLocks(s)}else this.writeLocks(this.locks);return this.locks}writeLocks(e){0===e.size?this.storage.remove("locks"):this.storage.setJSON("locks",Array.from(e))}releaseAll(){for(const[e,t]of this.locks)t.clientId===this.id&&this.release(t,!1);this.syncLocks()}releaseExpiredLocks(e){const t=this.date.now(),i=Array.from(e).filter(([e,i])=>t-i.createdDate<this.config.locksMaxAge);return new Map(i)}}class Ii{parseCookies(e){const t=[],i=e.split(";");for(const e of i){const i={},r=e.indexOf("=");r>-1?(i.name=e.slice(0,r).trim()||"",i.value=e.slice(r+1).trim()):(i.name="",i.value=e.trim()),i.name&&(i.name=(i.name||"").replace(/(%[\dA-F]{2})+/gi,decodeURIComponent),i.value=(i.value||"").replace(/(%[\dA-F]{2})+/gi,decodeURIComponent),t.push(i))}return t}serializeSetCookie(e){if(!e.name||"string"!=typeof e.name)throw new Error("Invalid cookie name!");const t={...e},i=encodeURIComponent(t.name).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),r=encodeURIComponent(t.value||"").replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent),s=this.serializeExpires(t.expires),n=[`${i}=${r}`];if("string"==typeof s&&n.push(`Expires=${s}`),"string"==typeof t.domain&&n.push(`Domain=${t.domain}`),n.push(`Path=${t.path||"/"}`),"string"==typeof e.sameSite){const i=e.sameSite.toUpperCase();"LAX"===i?n.push("SameSite=Lax"):"STRICT"===i?n.push("SameSite=Strict"):"NONE"===i&&(n.push("SameSite=None"),t.secure=!0)}return!0===t.secure&&n.push("Secure"),n.join("; ")}serializeExpires(e){if(Number.isSafeInteger(e)){const t=new Date(e);if(!isNaN(Number(t)))return t.toUTCString()}}parseExpires(e){if("string"==typeof e){const t=Date.parse(e);if(Number.isSafeInteger(t))return t}}}class Ci{storage;config;logLevel=ne.Warn;KEY_LOG_LEVEL="log_level";constructor(e,t){this.storage=e,this.config=t}level(){return"number"!=typeof this.logLevel&&(this.logLevel=Number(this.storage.get(this.KEY_LOG_LEVEL)||0)||this.config.logLevel||0),this.logLevel}setLevel(e){this.logLevel=e,this.storage.set(this.KEY_LOG_LEVEL,String(e))}enabled(e){return e<=this.level()}error(e,...t){this.print(e,ne.Error,t)}warn(e,...t){this.print(e,ne.Warn,t)}info(e,...t){this.print(e,ne.Info,t)}verbose(e,...t){this.print(e,ne.Verbose,t)}print(e,t,i){if(this.enabled(t))switch(t){case ne.Error:console.log(`${e}:`),console.error(...i);break;case ne.Warn:console.warn(`${e}: `,...i);break;case ne.Info:console.info(`${e}: `,...i);break;case ne.Verbose:console.log(`${e}: `,...i)}}}class xi{options;changes=new K;constructor(e){this.options=e}change(e,t=Ue.Full,i=$e.External){let r=this.changes.asObservable().pipe(Z(({external:e})=>i===$e.All||(i===$e.External?e:!e)));if(e)if(t&&t!==Ue.Full){if(t!==Ue.Start)throw new Error("Invalid keyMatch value!");r=r.pipe(Z(t=>t.key.startsWith(e)))}else r=r.pipe(Z(t=>t.key===e));return r}getJSON(e){const t=this.get(e);return"string"==typeof t?JSON.parse(t):null}setJSON(e,t){const i=JSON.stringify(t);this.set(e,i)}getStorageKey(e){const t=this.options.storagePrefix;return t?`${t}${e}`:e}revertStorageKey(e){const t=this.options.storagePrefix;return t?.length?e.slice(this.options.storagePrefix.length):e}isStorageKey(e){return!this.options.storagePrefix||!e||e.startsWith(this.options.storagePrefix)}emitChange(e){this.changes.next(e)}}class Pi extends xi{db=new Map;freeSpace$=new K;constructor(){super({storagePrefix:""})}get(e){return this.db.get(e)??null}set(e,t,i=!1){this.db.set(e,t),this.emitChange({key:e,value:t,external:i})}keys(){return Array.from(this.db.keys())}remove(e){this.db.delete(e),this.emitChange({key:e,value:null,external:!1})}clear(){this.db=new Map}all(){return Array.from(this.db.entries()).reduce((e,[t,i])=>(e[t]=i,e),{})}}class Ai extends xi{env;parser;changeDetector;freeSpace$=new K;cookies=new Map;constructor(e,t,i,r){super(r),this.env=e,this.parser=t,this.changeDetector=i,this.pull(!1),this.changeDetector.changes().pipe(Z(e=>e||!r.storagePrefix)).subscribe(()=>this.pull())}get(e){return this.cookies.get(e)??null}set(e,t){const i={name:this.getStorageKey(e),value:t};this.cookies.set(e,t);const r=this.parser.serializeSetCookie(i);this.env.doc.cookie=r,this.emitChange({key:e,value:t,external:!1})}keys(){return Array.from(this.cookies.keys())}remove(e){const t={name:this.getStorageKey(e),value:"",expires:0};this.cookies.delete(e);const i=this.parser.serializeSetCookie(t);this.env.doc.cookie=i,this.emitChange({key:e,value:null,external:!1})}clear(){const e=this.keys();for(const t of e)this.remove(t)}all(){return Array.from(this.cookies).reduce((e,[t,i])=>("string"==typeof i&&(e[t]=i),e),{})}pull(e=!0){const t=this.cookies,i=this.fetchCookies(),r=new Set([...t.keys(),...i.keys()]);if(this.cookies=i,e)for(const e of r){const r=t.get(e),s=i.get(e)??null;if(r!==s){const t={key:e,value:s,external:!0};this.emitChange(t)}}}fetchCookies(){const e=this.env.doc,t=this.parser.parseCookies(e.cookie).filter(e=>this.isStorageKey(e.name));for(const e of t)e.name=this.revertStorageKey(e.name);const i=t.map(e=>[e.name,e.value]);return new Map(i)}}class Ni{env;static patchedDocuments=new Map;constructor(e,t){this.env=t;const i=this.patchChanges();i.pipe(Z(e=>!e)).subscribe(()=>{e.postMessage(!0)}),e.messages.pipe(pe(()=>!0)).subscribe(i)}changes(){return this.patchChanges()}patchChanges(){const e=this.env.doc;let t=Ni.patchedDocuments.get(e);if(t)return t;t=new K,Ni.patchedDocuments.set(e,t);const i=this.env.win.Document.prototype,r=Object.getOwnPropertyDescriptor(i,"cookie");let s=e.cookie;const n={enumerable:!0,configurable:!0,get:()=>e.__native_cookie,set:i=>{e.__native_cookie=i;const r=e.__native_cookie;if(r!==s)try{t.next(!1)}finally{s=r}}};return Object.defineProperty(i,"__native_cookie",r),Object.defineProperty(i,"cookie",n),t}}class Oi{cookieStorage;unprefixedStorage;KEY_W2M_META_INFO="w2m_meta_info";w2mMetaInfo;metaInfoInLocalStorage=!1;constructor(e,t){this.cookieStorage=e,this.unprefixedStorage=t;try{const e=this.cookieStorage.get(this.KEY_W2M_META_INFO),t=this.unprefixedStorage.get(this.KEY_W2M_META_INFO);this.metaInfoInLocalStorage=Boolean(t),e?this.w2mMetaInfo=JSON.parse(e):t&&(this.w2mMetaInfo=JSON.parse(t))}catch(e){console.error("Error getting web to mobile configuration",e)}}getWebToMobileMetaInfo(){return this.w2mMetaInfo?this.w2mMetaInfo:null}isMetaInfoInLocalStorage(){return this.metaInfoInLocalStorage}}var Ri=["addListener","removeListener"],Li=["addEventListener","removeEventListener"],Di=["on","off"];function Mi(e,t,i,r){if(f(i)&&(r=i,i=void 0),r)return Mi(e,t,i).pipe(xt(r));var s=h(function(e){return f(e.addEventListener)&&f(e.removeEventListener)}(e)?Li.map(function(r){return function(s){return e[r](t,s,i)}}):function(e){return f(e.addListener)&&f(e.removeListener)}(e)?Ri.map($i(e,t)):function(e){return f(e.on)&&f(e.off)}(e)?Di.map($i(e,t)):[],2),n=s[0],o=s[1];if(!n&&ee(e))return Lt(function(e){return Mi(e,t,i)})(he(e));if(!n)throw new TypeError("Invalid event target");return new H(function(e){var t=function(){for(var t=[],i=0;i<arguments.length;i++)t[i]=arguments[i];return e.next(1<t.length?t:t[0])};return n(t),function(){return o(t)}})}function $i(e,t){return function(i){return function(r){return e[i](t,r)}}}class Ui extends xi{storageArea;quote;freeSpace$=new K;availableSpace=void 0;constructor(e,t,i,r){super(r),this.storageArea=t,this.quote=i,this.calculateAvailableSpace(),Mi(e.win,"storage").pipe(Z(e=>Boolean(e)&&"key"in e&&"storageArea"in e),Z(e=>Boolean(e.key)&&e.storageArea===t&&this.isStorageKey(e.key)),pe(e=>({key:this.revertStorageKey(e.key),value:e.newValue,external:!0}))).subscribe(e=>this.emitChange(e))}get(e){return this.storageArea.getItem(this.getStorageKey(e))}set(e,t){try{const i=(new TextEncoder).encode(t).length;null!==this.availableSpace&&void 0!==this.availableSpace&&this.availableSpace-i>100||null===this.availableSpace||void 0===this.availableSpace?(this.storageArea.setItem(this.getStorageKey(e),t),this.emitChange({key:e,value:t,external:!1})):this.freeSpace()}catch(e){this.freeSpace(),console.warn(e)}finally{this.calculateAvailableSpace()}}keys(){return Object.keys(this.storageArea).filter(e=>this.isStorageKey(e)).map(e=>this.revertStorageKey(e))}remove(e){this.storageArea.removeItem(this.getStorageKey(e)),this.emitChange({key:e,value:null,external:!1})}clear(){const e=this.keys();for(const t of e)this.remove(t)}all(){return Object.keys(this.storageArea).filter(e=>this.isStorageKey(e)).reduce((e,t)=>{const i=this.revertStorageKey(t),r=this.storageArea.getItem(t);return"string"==typeof r&&(e[i]=r),e},{})}freeSpace(){this.freeSpace$.next()}async calculateAvailableSpace(){this.availableSpace=await this.quote.quoteSize()}}class Bi extends Ui{constructor(e,i,r,s){super(e,t(e.win)?e.win.localStorage:s,r,i)}}class ji extends Ui{constructor(e,i,r,s){super(e,t(e.win)?e.win.sessionStorage:s,r,i)}}class Fi{persistentStorage;env;messages=new K;nativeChannel;channelName;constructor(e,t,i){this.persistentStorage=t,this.env=i,this.channelName=`pulse_bc_${e}`,this.init()}postMessage(e){this.nativeChannel?this.nativeChannel.postMessage(e):this.persistentStorage.setJSON(this.channelName,e)}init(){if(this.env.win.BroadcastChannel)return this.nativeChannel=new this.env.win.BroadcastChannel(this.channelName),void this.nativeChannel.addEventListener("message",e=>{this.messages.next(e.data)});this.persistentStorage.change(this.channelName,Ue.Full,$e.External).subscribe(e=>{const t=JSON.parse(e.value||"null");this.messages.next(t)})}}function Hi(e,t,i=!0){return"boolean"==typeof e?e:e&&"boolean"==typeof e[t]?e[t]??i:i}class Vi{tabStorage;transientStorage;lockManager;uuid;quote;env;tabIdKey="tab_id";tabId;enabled=!0;config={storagePrefix:"paa_"};constructor(e,t,i,r,s,n,o){this.tabStorage=e,this.transientStorage=t,this.lockManager=i,this.uuid=r,this.quote=s,this.env=n,this.enabled=Hi(o.eventEnrichment,"tab_id")}async init(){this.enabled&&(this.tabId=await this.trackTabId())}getSiblingTabId(e){try{if(!t(this.env.win))return null;if(!this.isSameHost(e.win,this.env.win))return null;return new ji(e,this.config,this.quote,this.transientStorage).get(this.tabIdKey)}catch{return console.error("Sibling tab referance is invalid"),null}}getTabId(){if(!this.tabId)throw new Error("TabManager is not initialized!");return this.tabId}async trackTabId(){const e=this.tabStorage.get(this.tabIdKey);let t=await this.lockAndUseTabId(e);if(!t){const e=this.uuid.generate();return t=await this.lockAndUseTabId(e),t||console.warn("Failed to lock the tab identifier!"),e}return t}async lockAndUseTabId(e){if(!e)return null;const t=`${this.tabIdKey}_${e}`;return await this.lockManager.request(t)?(this.tabStorage.set(this.tabIdKey,e),e):(this.tabStorage.clear(),null)}isSameHost(e,t){try{return e.location.host===t.location.host}catch{return!1}}}function qi(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=Nt(e),r=function(e,t){return"number"==typeof At(e)?e.pop():t}(e,1/0),s=e;return s.length?1===s.length?he(s[0]):Dt(r)(It(s,i)):qt}const Ki={capture:!0,passive:!0};class zi{env;get visible(){return this.isPageVisible()}hiddenPropName="hidden";visibilityStatePropName="visibilityState";visibilityEventName="visibilitychange";constructor(e){this.env=e,this.configureVisibilityListener()}onVisibilityChange(){const e=this.env.win.document;let t=new K;return this.configureVisibilityListener()&&(t=Mi(e,this.visibilityEventName).pipe(pe(()=>this.isPageVisible()))),this.fullVisibilityAPISupport()||(t=qi(t,this.legacyVisibilityEvents())),t.pipe(Ht())}legacyOnUnload(){const e=this.env.win;return qi(this.legacyPageHide(),Mi(e,"beforeunload",Ki))}legacyPageHide(){return Mi(this.env.win,"pagehide",Ki)}legacyVisibilityEvents(){return qi(this.legacyOnUnload().pipe(pe(()=>!1)),Mi(this.env.win,"pageshow",Ki).pipe(pe(()=>!0)),Mi(this.env.win,"focus",Ki).pipe(pe(()=>!0))).pipe(Ht())}isPageVisible(){const e=this.env.doc;return"string"==typeof e[this.visibilityStatePropName]&&e[this.visibilityStatePropName]?"visible"===e[this.visibilityStatePropName]:"boolean"==typeof e[this.hiddenPropName]?!e[this.hiddenPropName]:!this.env.win.document.hasFocus||this.env.win.document.hasFocus()}configureVisibilityListener(){const e=["","ms","webkit","moz","o"],t=this.env.doc;for(const i of e){const e=i?`${i}Hidden`:"hidden",r=i?`${i}VisibilityState`:"visibilityState",s=(i||"")+"visibilitychange";if(e in t||r in t)return this.hiddenPropName=e,this.visibilityEventName=s,this.visibilityStatePropName=r,!0}return!1}fullVisibilityAPISupport(){const e=this.env.doc,t=this.env.win.navigator.userAgent;return"string"==typeof e.visibilityState&&"boolean"==typeof e.hidden&&void 0!==e.onvisibilitychange&&!/Safari/i.test(t)}}class Gi{getElementAttributes(e){const t=["class","value","id","name"];return Array.from(e.attributes).map(e=>({name:e.name,value:e.value})).filter(e=>-1===t.indexOf(e.name))}getElementText(e){return e instanceof HTMLAnchorElement||e instanceof HTMLButtonElement?e.innerText:e instanceof HTMLInputElement&&("button"===e.type||"submit"===e.type||"reset"===e.type)?e.value:e===document.body?"<body>":e===document.documentElement?"<document>":e===document.head?"<head>":e.labels?.length?Array.from(e.labels||[]).map(e=>e.innerText).join(" "):null}getFirstParentElement(e){let t=e;for(;t;){if(t instanceof HTMLElement)return t;t=t.parentElement}return null}getTargetType(e){let t="other";return"A"===e.nodeName?t="link":"BUTTON"===e.nodeName||e instanceof HTMLInputElement&&"button"===e.type?t="button":e instanceof HTMLInputElement&&("submit"===e.type?t="submit":"reset"===e.type?t="reset":"file"===e.type?t="file":"submit"!==e.type&&"reset"!==e.type&&"file"!==e.type&&(t="input")),t}hasAttribute(e,t){return t?.hasAttribute(e)||t?.hasAttribute(`data-${e}`)}clickableTarget(e){let t=e,i=!1;for(;t&&!i;){const e=this.getTargetType(t);i=Boolean("submit"===e||"button"===e||"link"===e||this.hasAttribute("pulse-clickable",t)),i||(t=t.parentElement)}return t}createInteractionElement(e){const t=this.getTargetType(e),i=Array.from(e.classList),r=this.getElementAttributes(e),s=e.getAttribute("pulse-name")||e.getAttribute("data-pulse-name")||e.getAttribute("pulse-clickable")||e.getAttribute("data-pulse-clickable")||e.name||e.getAttribute("name")||void 0;return{attributes:r,attributeValueByName:r.reduce((e,t)=>({...e,[t.name]:t.value}),{}),classList:i,nodeType:t,id:e.id,name:s,nodeName:e.nodeName,text:this.getElementText(e)||void 0}}createSection(e,t,i=void 0,r){const s=e?e.getAttribute("pulse-section")||e.getAttribute("data-pulse-section"):null,n=t?t.getAttribute("pulse-section-group")||t.getAttribute("data-pulse-section-group"):null,o=i?i.getAttribute("pulse-component")||i.getAttribute("data-pulse-component"):null,a=i?i.getAttribute("pulse-component-type")||i.getAttribute("data-pulse-component-type"):null;return{name:s||n||void 0,group:n||s||void 0,sectionElement:e&&this.createInteractionElement(e),sectionGroupElement:t&&this.createInteractionElement(t),popupComponent:o||void 0,popupComponentType:a||void 0,additionalProperties:r&&Object.keys(r).length>0?r:void 0}}collectDynamicAttributes(e){const t={};return Array.from(e.attributes).forEach(e=>{const i=e.name,r=e.value;if(i.startsWith("data-pulse-dynamic-")){const e=i.replace("data-pulse-dynamic-","");t[e]=r}else if(i.startsWith("pulse-dynamic-")){const e=i.replace("pulse-dynamic-","");t[e]=r}}),t}}const Ji=(new ke).provide(function(e){return e.useFactory(st,e=>e,[ye]).useClass(bi,bi,[be,Ti]).useFactory(ki,(e,t,i,r,s)=>new ki(e(i.sessionStorageType),t,i,r,s),[xe,De,st,Ti,zi]).useFactory(Oe,async(e,t)=>await e.supported()?e:t,[bi,ki]).useClass(ct,ct,[]).useClass(Ii,Ii,[]).useFactory(Ci,(e,t)=>new Ci(e(t.sessionStorageType),t),[xe,st]).useClass(Pi,Pi,[]).useValue(Ce,window).useClass(be,be,[Ce]).useClass(De,De,[be]).useClass(ze,ze,[zi,be,De,Ci,st,Fe]).useClass(tt,tt,[be]).useClass(et,et,[be,Ze]).useClass(Ti,Ti,[De,be]).useClass(Ze,Ze,[be]).useClass(Ai,Ai,[be,Ii,Ni,st]).useClass(Oi,Oi,[Ae,Ne]).useFactory(Ae,(e,t,i,r)=>new Ai(e,t,i,{...r,storagePrefix:""}),[be,Ii,Ni,st]).useFactory(Re,(e,t,i,r)=>new Ai(e,t,i,{...r,storagePrefix:r.storagePrefix}),[be,Ii,Ni,st]).useFactory(Fe,(e,t,i,r,s)=>new Fe(e,t(i.sessionStorageType),r,i,s,$e.External),[Ti,xe,st,Re,Oi]).useClass(Xe,Xe,[be]).useFactory(Je,(e,t,i,r)=>new Je(i(r.hashStoreStorageType),e,t),[ct,De,xe,st]).useClass(Me,Me,[be]).useClass(it,it,[Ze]).useFactory(qe,(e,t,i,r)=>new qe(e,t(i.trafficSourceDetectorStorageType),r),[it,xe,st,Ze]).useClass(Bi,Bi,[be,st,Qe,Pi]).useFactory(Ne,(e,t,i,r)=>new Bi(e,{...t,storagePrefix:""},i,r),[be,st,Qe,Pi]).useClass(ji,ji,[be,st,Qe,Pi]).useFactory(Pe,(e,t,i)=>new Fi("pulse-cookie-changes",e(i.sessionStorageType),t),[xe,be,st]).useClass(Ni,Ni,[Pe,be]).useClass(Ai,Ai,[be,Ii,Ni,st]).useClass(Qe,Qe,[be]).useClass(ve,ve,[be]).useFactory(xe,(e,i,r,s)=>n=>{if(!t(s.win))return e;switch(n){case"memory":return e;case"persistent":return r;case"tab":return i}},[Pi,ji,Bi,be]).useClass(zi,zi,[be]).useClass(Ye,Ye,[]).useFactory(Vi,async(e,t,i,r,s,n,o)=>{const a=new Vi(e(o.tabManagerStorageType),t,i,r,s,n,o);return await a.init(),a},[xe,Pi,Oe,Ti,Qe,be,st]).useFactory(We,(e,t,i,r,s)=>new We(e(t.sessionStorageType),t.stateStorageKey,i,r,s,$e.All),[xe,st,Oi,qe,Vi]).useClass(Gi,Gi,[])}).beforeInit(function(e){const t={...fe,...e,initialDocURL:window.paa?.idu};return"standard"!==t.mode&&(t.trafficSourceDetectorStorageType="memory"),t});class Wi{plugins=[];init(e){this.plugins.forEach(t=>t.init&&t.init(e))}enqueue(e,t){return this.plugins.every(i=>!i.enqueue||i.enqueue(e,t))}beforeBatchSend(e,t){return this.plugins.reduce((e,i)=>e&&i.beforeBatchSend?i.beforeBatchSend(e,t):e,e)}batchSent(e,t){this.plugins.forEach(i=>i.batchSent&&i.batchSent(e,t))}sessionChange(){throw new Error("Method not implemented.")}stateChange(){throw new Error("Method not implemented.")}register(e){this.plugins.push(e)}}class Yi{transformPipes=[];enrichmentPipes=[];process(e,t){return this.transform(e,t).map(e=>this.enrich(e,t))}transform(e,t){const i=this.selectPipeSet(e,this.transformPipes);let r=[e];for(const e of i){if(!e.transform)continue;const i=[];for(const s of r){const r=e.transform(s,t);i.push(...r)}r=i}return r}enrich(e,t){return this.selectPipeSet(e,this.enrichmentPipes).reverse().reduce((e,i)=>i.enrich(e,t),e)}registerTransformSet(e){this.transformPipes.push(e)}registerEnrichmentSet(e){this.enrichmentPipes.push(e)}selectPipeSet(e,t){for(const i of t){if(!("*"===i.selector||i.selector===e.type||"function"==typeof i.selector&&i.selector(e)||!1))continue;if(!("function"==typeof i.exclude&&i.exclude(e)))return[...i.use]}return[]}}class Qi{transform(e){const t=e.data;if("object"!=typeof t||!t||Array.isArray(t))return[];if(!("object"==typeof t&&"string"==typeof t?.name&&["$overwrite","$inc","$dec"].indexOf(t?.type)>-1)&&"object"==typeof t&&t){const i=[];for(const r in t){if(!Object.prototype.hasOwnProperty.call(t,r))continue;const s=t[r];if(!("string"==typeof s||"number"==typeof s||"boolean"==typeof s))continue;const n={...e,data:{type:"$overwrite",name:r,value:s}};i.push(n)}return i}return[e]}}class Xi{transform(e){const t={...e.data};return"string"==typeof t.event&&t.event||"string"!=typeof t.action||!t.action?(t.event_type=t.event||t.event_type,delete t.event):(t.event_type=t.action,delete t.action),"object"==typeof t.data&&t.data||("object"==typeof t.parameters&&t.parameters?(t.data=t.parameters,delete t.parameters):t.data={}),e.data=t,[e]}}var Zi,er,tr,ir;!function(e){e[e.Normal=1]="Normal",e[e.High=2]="High",e[e.Force=3]="Force"}(Zi||(Zi={})),function(e){e.NAVIGATION="navigation",e.CLICK="click",e.POPUP="popup",e.CONTEXTMENU="contextmenu",e.CONSENT_CHANGE="consent_change",e.SESSION_START="session_start"}(er||(er={}));class rr{pageInfo;previousPath="";constructor(e){this.pageInfo=e}transform(e){let t=!0;const i=e.data;return i.event_type&&i.event_type===er.NAVIGATION&&(this.pageInfo.href()===this.previousPath&&(t=!1),this.previousPath=this.pageInfo.href()),t?[e]:[]}}class sr{hashStore;config;constructor(e,t){this.hashStore=e,this.config=t}transform(e){const t=e.data;if("object"!=typeof t||!t||Array.isArray(t))return[];const i=`attribute_${t.name}`,r=`${t.type}_${t.value}`;return this.hashStore.changed(i,r,this.config.attributeTimeoutMS)?[e]:[]}}class nr{historyTracker;tabManager;pageInfo;config;openerDetector;uuidService;webToMobileService;constructor(e,t,i,r,s,n,o){this.historyTracker=e,this.tabManager=t,this.pageInfo=i,this.config=r,this.openerDetector=s,this.uuidService=n,this.webToMobileService=o}enrich(e){const t={...e.data};"object"==typeof t.data&&null!==t.data||(t.data={}),t.timestamp=e.timestamp,t.event_id=this.uuidService.generate(),t.data.metadata={event_id_source:"sdk"},this.config.customerID&&(t.data.customer_id=this.config.customerID);const i=this.webToMobileService.getWebToMobileMetaInfo();if(i?.device_id&&(t.data.is_w2m=!0,t.data.mobile_attributes=i.mobile_attributes),Hi(this.config.eventEnrichment,"url")&&(t.data.url=this.pageInfo.href()),Hi(this.config.eventEnrichment,"tab_id")&&(t.data.tab_id=this.tabManager.getTabId(),t.data.tab_id)){const e=this.openerDetector.getOpener();e?.id&&(t.data.opener_tab_id=e.id)}return this.historyTracker.previousUrl&&Hi(this.config.eventEnrichment,"previous_url")&&(t.data.previous_url=this.historyTracker.previousUrl),this.pageInfo.referrer()&&Hi(this.config.eventEnrichment,"referrer")&&(t.data.referrer=this.pageInfo.referrer()),e.data=t,e}}class or{sourceService;config;constructor(e,t){this.sourceService=e,this.config=t}enrich(e){if(!Hi(this.config.eventEnrichment,"legacy_source"))return e;const t={...e.data};"object"==typeof t.data&&null!==t.data||(t.data={});const i=t?.data?.source;if(!0===i||"string"==typeof i&&"true"===i.toLowerCase()){const e=this.sourceService.getSource();t.data.source=e}else void 0!==i&&"string"!=typeof i&&(t.data.source=JSON.stringify(i)||"");return e.data=t,e}}!function(e){e[e.Visible=0]="Visible",e[e.Hidden=1]="Hidden"}(tr||(tr={}));class ar{visibility;visibilityState=tr.Visible;constructor(e){this.visibility=e}init(){this.visibility.onVisibilityChange().subscribe(e=>{this.visibilityState=e?tr.Visible:tr.Hidden})}}class cr{historyTracker;navigationEventService;sessionService;consentService;constructor(e,t,i,r){this.historyTracker=e,this.navigationEventService=t,this.sessionService=i,this.consentService=r}init(){this.navigationEventService.send(!0),this.sessionService.session.subscribe(e=>{(e.isRenew||e?.renewedBy)&&this.consentService.trackingEnabled()&&this.navigationEventService.send(!1,e?.renewedBy)}),this.historyTracker.navigation.subscribe(()=>this.navigationEventService.send(!1))}}class ur{sessionService;experimentsService;debug;config;deviceInfo;stateService;clientAttributesService;constructor(e,t,i,r,s,n,o){this.sessionService=e,this.experimentsService=t,this.debug=i,this.config=r,this.deviceInfo=s,this.stateService=n,this.clientAttributesService=o}init(){const e=this.experimentsService.getInfected();e&&e.length?this.stateService.setState({infected:this.experimentsService.getInfected()}):e&&0===e.length&&this.stateService.removePropertyFromState("infected"),Ot([this.sessionService.session,this.debug.items]).subscribe(([e])=>{this.setState(e)})}setState(e){const{app:t}=e,i=this.deviceInfo.getNavigatorInfo(),r=this.deviceInfo.getScreenInfo().touch,s=this.deviceInfo.getHardwareInfo().cpus;let n=Object.fromEntries(Object.entries(this.clientAttributesService.getAttributes()).map(([e,t])=>[`attr_${e}`,t]));n&&!Object.keys(n).length&&(n=void 0);const o={app:Hi(this.config.stateEnrichment,"app")?t:void 0,market:Hi(this.config.stateEnrichment,"market")?"web":void 0,platform:Hi(this.config.stateEnrichment,"platform")?"web":void 0,version:Hi(this.config.stateEnrichment,"version")?this.config.app_version:void 0,data:{language_code:Hi(this.config.stateEnrichment,"language_code")?i.device_language_code:void 0,cpus:s,touch:r,browser_platform:i.browser_platform,...n},v:Hi(this.config.stateEnrichment,"pulse_version")?this.config.version:void 0,debug:this.debug.enabled("debugger")};this.stateService.setState(o)}}class hr{activityTracker;env;constructor(e,t){this.activityTracker=e,this.env=t}init(){this.activityTracker.mutations().pipe(Lt(e=>e.mutatedElements)).subscribe(e=>{e&&this.env.win.dataLayer?.push({pulse:"event",event_type:er.POPUP,data:{component:e.component,component_type:e.componentType,popup_source:{section:e.section.name,group:e.section.group},action:"addedNodes"===e.mutationType?"open":"close",click_source:{tab_id:this.activityTracker.lastClickSourceInformation?.tab_id,url:this.activityTracker.lastClickSourceInformation?.url,section:this.activityTracker.lastClickSourceInformation?.name,group:this.activityTracker.lastClickSourceInformation?.group,popup_component:this.activityTracker.lastClickSourceInformation?.popupComponent,popup_component_type:this.activityTracker.lastClickSourceInformation?.popupComponentType,element:{id:this.activityTracker.lastClickSourceInformation?.element?.id||this.activityTracker.lastClickSourceInformation?.element?.name,name:this.activityTracker.lastClickSourceInformation?.element?.name,type:this.activityTracker.lastClickSourceInformation?.element?.nodeName,class_list:this.activityTracker.lastClickSourceInformation?.element?.classList,value:this.activityTracker.lastClickSourceInformation?.element?.text},additional_properties:this.activityTracker.lastClickSourceInformation?.additionalProperties},additional_properties:e?.additionalProperties}})})}}class lr{attributeService;constructor(e){this.attributeService=e}init(){this.attributeService.send()}}class dr{consentService;sessionService;attributeService;env;constructor(e,t,i,r){this.consentService=e,this.sessionService=t,this.attributeService=i,this.env=r}init(){this.consentService.changes().pipe(Z(e=>!1!==e.consent.report)).subscribe(e=>{this.fireChangeEvent(e),"opt-in"===e.consent.mode&&(this.sessionService.startNewSession("consent_change"),this.attributeService.send())})}fireChangeEvent(e){const t=this.buildChangeEvent(e),i={event_type:er.CONSENT_CHANGE,data:t};this.env.win.dataLayer?.push({pulse:"event",...i,event_priority:Zi.Force})}buildChangeEvent({consent:e,result:t}){const i="string"==typeof e.consent?e.consent:e.consent.name;return{mode:e.mode,provider:i,state:t.state,necessary_cookies:t.necessary_cookies??void 0,performance_cookies:t.performance_cookies??void 0,functional_cookies:t.functional_cookies??void 0,targeting_cookies:t.targeting_cookies??void 0,social_media_cookies:t.social_media_cookies??void 0,provider_consent_id:t.provider_consent_id??void 0,response_time:t.response_time??void 0}}}class pr{cookieStorage;hashStore;attributeService;env;constructor(e,t,i,r){this.cookieStorage=e,this.hashStore=t,this.attributeService=i,this.env=r}init(){this.getPixelId()}getPixelId(){const e=this.cookieStorage.get("_fbp"),t=this.cookieStorage.change("_fbp",Ue.Full,$e.All).pipe(pe(e=>e.value));Mt(ri(e),t).pipe(Z(Boolean),Z(e=>this.hashStore.changed("pixel_id_attr",e))).subscribe(e=>{this.env.win.dataLayer?.push({pulse:"attribute",fb_pixel_id:e}),this.attributeService.send(!0)})}}class gr{hashStore;trafficSourceService;sessionService;env;webToMobileService;lockedLocal="";constructor(e,t,i,r,s){this.hashStore=e,this.trafficSourceService=t,this.sessionService=i,this.env=r,this.webToMobileService=s}init(){this.sessionService.session.subscribe(e=>{this.fireEvent(e)});const e=this.sessionService.getSession();this.fireEvent(e)}async fireEvent(e){const t=this.webToMobileService.getWebToMobileMetaInfo();if(this.lockedLocal===e.sessionId||t?.session_id)return;if(this.lockedLocal=e.sessionId,!this.isNewSession(e))return;const i=this.trafficSourceService.getTrafficSource(),r={event_type:er.SESSION_START,data:{}};i?.clickId?.value&&(r.data.mkt_click={id:i.clickId.value,source:i.clickId.source}),i?.landingPageURL&&(r.data.landing_page_url=i?.landingPageURL),i?.utmParams&&(r.data.utm_params=i.utmParams),e.renewedBy&&(r.data.source=e.renewedBy),this.env.win.dataLayer?.push({pulse:"event",...r,event_priority:Zi.High})}isNewSession(e){return this.hashStore.changed("session_start_event_session_id",e.sessionId)}}class fr{activity;env;constructor(e,t){this.activity=e,this.env=t}init(){this.activity.interactions().pipe(Z(e=>e.type===er.CLICK&&!e.doNotTrack&&e.clickable)).subscribe(e=>{this.env.win.dataLayer?.push({pulse:"event",event_type:er.CLICK,data:{click_source:{section:e.section.name,group:e.section.group,popup_component:e.section.popupComponent,popup_component_type:e.section.popupComponentType,element:{id:e.element?.id||e.element?.name,name:e.element?.name,type:e.element?.nodeName,class_list:e.element?.classList,value:e.element?.text}},additional_properties:e?.additionalProperties}})})}}class vr{activity;env;constructor(e,t){this.activity=e,this.env=t}init(){this.activity.interactions().pipe(Z(e=>e.type===er.CONTEXTMENU&&"link"===e.element?.nodeType&&!e.doNotTrack&&e.clickable)).subscribe(e=>{this.env.win.dataLayer?.push({pulse:"event",event_type:er.CONTEXTMENU,data:{click_source:{section:e.section.name,group:e.section.group,popup_component:e.section.popupComponent,popup_component_type:e.section.popupComponentType,element:{id:e.element?.id||e.element?.name,name:e.element?.name,type:e.element?.nodeName,class_list:e.element?.classList,value:e.element?.text}},additional_properties:e?.additionalProperties}})})}}class br{experimentsService;constructor(e){this.experimentsService=e}init(e){this.experimentsService.newExperimentTrigger$.subscribe(t=>{t&&e.tracker.flush()})}}class mr{debugService;env;liveEventDebug;config;routeHelper;webToMobileService;static DEBUGGER_KEY="debugger";constructor(e,t,i,r,s,n){this.debugService=e,this.env=t,this.liveEventDebug=i,this.config=r,this.routeHelper=s,this.webToMobileService=n}init(){try{const e=this.extractDebugLEUID();e&&this.enableDebugMode();this.isLiveDebugEnabled(e)&&this.handleLiveDebugMode(),e&&this.cleanupDebugParameter()}catch(e){console.error("Failed to initialize DebugEventPlugin:",e)}}extractDebugLEUID(){try{return new URL(this.env.landingUrl).searchParams.get(this.config.debugLiveEventKey)}catch(e){return console.error("Failed to parse landing URL:",e),null}}enableDebugMode(){this.debugService.enable(this.config.debugLiveEventKey)}isLiveDebugEnabled(e){return Boolean(e)||this.debugService.enabled(this.config.debugLiveEventKey)}handleLiveDebugMode(){this.debugService.enable(mr.DEBUGGER_KEY);const e=this.webToMobileService.getWebToMobileMetaInfo();Boolean(e?.session_id)||this.liveEventDebug.displayControl()}cleanupDebugParameter(){this.routeHelper.cleanupURL(this.config.debugLiveEventKey)}}class yr{activity;tabInfo;tabManager;config;constructor(e,t,i,r){this.activity=e,this.tabInfo=t,this.tabManager=i,this.config=r}init(){Hi(this.config.eventEnrichment,"tab_id")&&(this.activity.startService(this.tabManager.getTabId()),this.tabInfo.startService(this.tabManager.getTabId()))}}class Sr{unprefixedStorage;cookieName="OptanonConsent";boxCookieName="OptanonAlertBoxClosed";constructor(e){this.unprefixedStorage=e}changes(){const e=this.parseOneTrustCookie(),t=new G(e),i=new K;return i.pipe(ci(30),pe(()=>this.parseOneTrustCookie())).subscribe(e=>t.next(e)),this.unprefixedStorage.change(this.cookieName,Ue.Full,$e.All).subscribe(()=>i.next()),this.unprefixedStorage.change(this.boxCookieName,Ue.Full,$e.All).subscribe(()=>i.next()),t}parseOneTrustCookie(){const e=this.unprefixedStorage.get(this.cookieName)||"",t=new URLSearchParams(e||""),i=this.parseConsentGroups(t);if(!i)return{state:"pending"};const r=t.get("consentId")||void 0,s=this.getResponseTime(),n=!Number.isSafeInteger(s)||"true"===t.get("AwaitingReconsent"),o="boolean"==typeof i.C0001?i.C0001:void 0,a="boolean"==typeof i.C0002?i.C0002:void 0,c="boolean"==typeof i.C0003?i.C0003:void 0,u="boolean"==typeof i.C0004?i.C0004:void 0;return{state:n?"pending":"responded",response_time:s,provider_consent_id:r,necessary_cookies:o,functional_cookies:c,performance_cookies:a,social_media_cookies:"boolean"==typeof i.C0005?i.C0005:void 0,targeting_cookies:u}}parseConsentGroups(e){const t=(e.get("groups")||"").trim();if(t)return t.split(",").reduce((e,t)=>{const i=(t||"").split(":").map(e=>e.trim()),r=i[0],s="1"===i[1]||"true"===i[1];return r&&2===i.length&&(e[r]=s),e},{})}getResponseTime(){const e=this.unprefixedStorage.get(this.boxCookieName),t=e?new Date(e):void 0;return t?.getTime()||void 0}}class wr{oneTrust;logger;hashStore;config;trackerConsentStream;consentChanges;constructor(e,t,i,r){this.oneTrust=e,this.logger=t,this.hashStore=i,this.config=r;const s=this.buildConsentChecks(this.config.consentChecks||[]),n=s.map(e=>e.result.pipe(pe(t=>({consent:{consent:e.consent,mode:e.mode,report:e.report,type:e.type},result:t}))));this.consentChanges=qi(...n),this.trackerConsentStream=this.createTrackerCheckerStream(s)}trackingEnabled(){return this.trackerConsentStream}softChanges(){return this.consentChanges}changes(){return this.consentChanges.pipe(Z(({consent:e,result:t})=>{const i="string"==typeof e.consent?e.consent:e.consent.name,r=`tracking_consent_${e.type}${i}`;return this.hashStore.changed(r,t)}))}createTrackerCheckerStream(e){const t=e.every(e=>"opt-out"===e.mode),i=new G(t),r=e.map(e=>e.result.pipe(pe(t=>{if("tracking"===e.type){if("boolean"==typeof t.performance_cookies)return t.performance_cookies;if("pending"===t.state)return"opt-out"===e.mode}return!0})));return r.length&&Ot(r).pipe(pe(e=>e.every(e=>!0===e))).subscribe(e=>i.next(e)),i.asObservable().pipe(Ht())}buildConsentChecks(e){const t=[];for(const i of e)if("tracking"===i.type)if("OneTrust"===i.consent){const e=this.oneTrust.changes();t.push({...i,result:e})}else if("object"==typeof i.consent&&"function"==typeof i.consent?.handler){const e=this.buildFunctionConsentChecker(i);t.push(e)}else this.logger.warn("Consent","Unsupported ConsentChecker!");else this.logger.warn("Consent","Unsupported ConsentCheck type!");return t}buildFunctionConsentChecker(e){const t=new je;if("object"==typeof e.consent&&"function"==typeof e.consent?.handler){const r=e.consent.handler(t.next.bind(t));"object"==typeof r&&((i=r)&&(i instanceof H||f(i.lift)&&f(i.subscribe)))?r.subscribe(t):this.isPromise(r)?It(r).subscribe(t):this.isValidResult(r)&&t.next(r)}var i;return{...e,result:t.pipe(Z(e=>this.isValidResult(e)))}}isPromise(e){return e instanceof Promise||"object"==typeof e&&"function"==typeof e?.then}isValidResult(e){const t=e;return"object"==typeof t&&("pending"===t?.state||"responded"===t?.state)}}class _r{utmService;page;engineList=new RegExp(["google","bing","baidub","yahoo","yandex","ask","duckduckgo","naver","aol","seznam"].join("|"));constructor(e,t){this.utmService=e,this.page=t}getSource(){const e=(this.page.referrer()||"").replace(/^https?:\/\//,""),t=this.utmService.getUTMParams();return t?.utm_source?`utm_${t.utm_source}`:e?this.engineList.test(e)?`search_${e}`:`referral_${e}`:"direct"}}class Er{date;storage;trafficSourceService;hashStore;config;deviceIdService;debugService;webToMobileService;stateService;storageChange;session;newSessionGenerated$=new G(0);sessionId;lastActivity;KEY_LAST_ACTIVITY="la";webToMobileSessionId;constructor(e,t,i,r,s,n,o,a,c,u){this.date=e,this.storage=t,this.trafficSourceService=i,this.hashStore=r,this.config=s,this.deviceIdService=n,this.debugService=o,this.webToMobileService=a,this.stateService=c,this.storageChange=u;const h=this.webToMobileService.getWebToMobileMetaInfo();this.lastActivity=Number(this.storage.get(this.KEY_LAST_ACTIVITY)||0),this.webToMobileSessionId=h?.session_id,this.sessionId=this.storage.get(this.config.keySessionID)||void 0,this.webToMobileSessionId&&(this.storage.set(this.config.keySessionID,this.webToMobileSessionId),this.stateService.setState({session_id:this.webToMobileSessionId})),this.registerStorageChangeListeners(),this.session=new G(this.getSession())}getSession(e=!0,t=!1){const i=this.deviceIdService.getDeviceId(),r=this.storage.get(this.config.keySessionID),s=this.isSessionExpired(),n=!this.sessionId;let o;o=this.webToMobileSessionId?this.webToMobileSessionId:!this.sessionId||s?this.fetchSessionId(s):this.sessionId,(s||n||t||r!==o)&&this.stateService.setState({device_id:Hi(this.config.stateEnrichment,"device_id")||this.debugService.enabled("debugger")?i:void 0,session_id:Hi(this.config.stateEnrichment,"session_id")?o:void 0});const a=this.stateService.getStateInternal(),c=this.lastActivity||0,u={app:this.config.app,deviceId:i,sessionId:o,lastActivity:c,state:a};return e&&this.refreshLastActivity(),s&&r&&(u.renewedBy="session_reset",u.isRenew=!0),(s||n)&&this.session?.next(u),u}startNewSession(e){return this.webToMobileSessionId&&(this.sessionId=this.webToMobileSessionId),this.sessionId=this.generateSessionId(),this.storage.set(this.config.keySessionID,this.sessionId),this.refreshLastActivity(),e&&this.session?.next({...this.getSession(!0,!0),renewedBy:e}),this.newSessionGenerated$.next(this.date.now()),this.sessionId}refreshLastActivity(){const e=this.date.now();e-(this.lastActivity||0)>1e3&&(this.lastActivity=e,this.storage.set(this.KEY_LAST_ACTIVITY,this.lastActivity.toString()))}isSessionExpired(){if(this.webToMobileSessionId)return!1;const{sessionTimeoutMS:e}=this.config,t=this.date.now(),i=this.trafficSourceChanged();return!this.sessionId||t-this.lastActivity>e||i}trafficSourceChanged(){const e=this.trafficSourceService.getLastTrafficSource();return this.hashStore.changed("session_traffic_source",e)}fetchSessionId(e=!1){if(this.webToMobileSessionId)return this.webToMobileSessionId;if(this.sessionId&&!e)return this.sessionId;return this.startNewSession()}registerStorageChangeListeners(){this.storage.change(this.config.keySessionID).subscribe(e=>{e.value&&(this.sessionId=e.value)}),this.deviceIdService.getDeviceId$().subscribe(e=>{this.stateService.setState({device_id:Hi(this.config.stateEnrichment,"device_id")||this.debugService.enabled("debugger")?e:void 0})}),this.storage.change(this.KEY_LAST_ACTIVITY).subscribe(({value:e})=>{const t=Number(e||"0");(this.lastActivity||0)<t&&(this.lastActivity=t)})}generateSessionId(){return this.webToMobileSessionId?this.webToMobileSessionId:`${this.date.now()}_${this.deviceIdService.getDeviceId()}`}}class Tr{storage;items;debugItems;KEY_DEBUG="debug";constructor(e,t){this.storage=e,e.change(this.KEY_DEBUG).subscribe(e=>this.getDebugKeys(e.value));const i=this.getDebugKeys();this.items=new G(i),Array.isArray(t.debug)&&t.debug.length&&this.enable(...t.debug),t.debugClear&&this.disableAll()}enabled(e){const t=this.getDebugKeys();return t.has(e)||t.has("all")}enable(...e){const t=this.getDebugKeys();let i=!1;for(const r of e)i=i||!t.has(r),t.add(r);i&&this.set(Array.from(t))}disable(...e){const t=this.getDebugKeys();let i=!1;for(const r of e)i=i||t.has(r),t.delete(r);i&&this.set(Array.from(t))}disableAll(){this.getDebugKeys().clear(),this.set([])}set(e){this.storage.set(this.KEY_DEBUG,JSON.stringify(e)),this.debugItems=new Set(e),this.items.next(this.debugItems)}getDebugKeys(e){if(!this.debugItems||e){let t;try{if(t=JSON.parse(e||this.storage.get(this.KEY_DEBUG)||""),!Array.isArray(t))throw new Error("Failed to parse debug mode!")}catch{t=[]}this.debugItems=new Set(t)}return this.debugItems}}class kr{debug;config;httpService;constructor(e,t,i){this.debug=e,this.config=t,this.httpService=i}send(e,t=!1,i=void 0,r){const s=`${this.config.serverBaseURL}/${this.config.app}`,n=this.getHeaders();this.httpService.post(s,n,e.chunks,t).then(()=>{i?.({size:e.size||0,batchId:r})}).catch(e=>{console.error(`Batch didn't send ${e}`)})}getHeaders(){const e=this.debug.enabled("receiver");return{"Content-Type":"application/json","receiver-debug":String(e)}}}class Ir{env;tabStorage;dateService;previousUrl;navigation=new K;popStatePreviousUrl;lastLocationKey="last_location";internalLoadLimit=2e3;constructor(e,t,i){this.env=e,this.tabStorage=t,this.dateService=i;const r=this.getLastLocation();this.previousUrl=r?.locationURL||e.doc.referrer||"",this.popStatePreviousUrl=this.env.win.location.href,this.setLastLocation(this.env.win.location.href),addEventListener("beforeunload",()=>{this.setLastLocation()},{capture:!0}),this.init()}init(){"function"==typeof this.env.win.history?.pushState&&(this.patch("back"),this.patch("forward"),this.patch("go"),this.patch("pushState"),this.patch("replaceState"),this.env.win.addEventListener("popstate",()=>{const e=this.env.win.location.href;this.popStatePreviousUrl!==e&&(this.previousUrl=this.popStatePreviousUrl,this.popStatePreviousUrl=e,this.setLastLocation(e),this.navigation.next(e))},!1))}patch(e){const t=this.env.win.history,i=t[e].bind(t);t[e]=(...e)=>{const r=this.env.win.location.href;i.apply(t,e);const s=this.env.win.location.href;r!==s&&(this.setLastLocation(s),this.popStatePreviousUrl=s,this.previousUrl=r,this.navigation.next(s))}}setLastLocation(e=this.popStatePreviousUrl){this.tabStorage.setJSON(this.lastLocationKey,{locationURL:e,timestamp:this.dateService.now()})}getLastLocation(){let e=this.tabStorage.getJSON(this.lastLocationKey);return e=e?.timestamp&&this.dateService.hrtTimeOrigin-e?.timestamp<this.internalLoadLimit?this.env.win.location.href===e?.locationURL?null:e:null,e}}class Cr{tabOpenerDetector;env;constructor(e,t){this.tabOpenerDetector=e,this.env=t}send(e,t){const i=this.tabOpenerDetector.getOpener(!0),r={event_type:er.NAVIGATION,pulse:"event",data:{initial:e,source:t,click_source:{}},event_priority:Zi.High};i?.element&&this.tabOpenerDetector.isFirstNavigation()&&e&&(r.data.click_source={section:i?.name,group:i?.group,popup_component:i?.popupComponent,popup_component_type:i?.popupComponentType,tab_id:i?.id,url:i?.url,type:i?.type,element:{id:i?.element?.id,name:i?.element?.name,type:i?.element?.nodeName,class_list:i?.element?.classList,value:i?.element?.text},additional_properties:i?.additionalProperties});const s=this.tabOpenerDetector.getTriggerEvent(e);!this.tabOpenerDetector.isFirstNavigation()&&s?.element&&(r.data.click_source={section:s?.name,group:s?.group,popup_component:s?.popupComponent,popup_component_type:s?.popupComponentType,tab_id:s?.id,url:s?.url,element:{id:s?.element?.id,name:s?.element?.name,type:s?.element?.nodeName,class_list:s?.element?.classList,value:s?.element?.text},additional_properties:s?.additionalProperties}),this.env.win.dataLayer?.push(r)}}function xr(e,t,i){var r=f(e)||t||i?{next:e,error:t,complete:i}:e;return r?Y(function(e,t){var i;null===(i=r.subscribe)||void 0===i||i.call(r);var s=!0;e.subscribe(Q(t,function(e){var i;null===(i=r.next)||void 0===i||i.call(r,e),t.next(e)},function(){var e;s=!1,null===(e=r.complete)||void 0===e||e.call(r),t.complete()},function(e){var i;s=!1,null===(i=r.error)||void 0===i||i.call(r,e),t.error(e)},function(){var e,t;s&&(null===(e=r.unsubscribe)||void 0===e||e.call(r)),null===(t=r.finalize)||void 0===t||t.call(r)}))}):j}!function(e){e[e.LinkInteraction=1]="LinkInteraction",e[e.Link=2]="Link",e[e.Interaction=3]="Interaction",e[e.Focus=4]="Focus",e[e.Visibility=5]="Visibility",e[e.NoVisibility=6]="NoVisibility"}(ir||(ir={}));const Pr=["click","contextmenu"],Ar=[...Pr];class Nr{visibilityTracker;win;tabManagerService;config;activityTrackerUtils;interactionEventsSubject;mutationEventsSubject;lastClickSourceInformation;constructor(e,t,i,r,s){this.visibilityTracker=e,this.win=t,this.tabManagerService=i,this.config=r,this.activityTrackerUtils=s,this.registerListeners()}interactions(){return this.interactionEventsSubject}mutations(){return this.mutationEventsSubject}registerListeners(){if(!this.interactionEventsSubject){const e=this.interactionEvents(),t=this.mutationEvents(),i=new je,r=new je;e.subscribe(i),t.subscribe(r),this.interactionEventsSubject=i,this.mutationEventsSubject=r}}mutationEvents(){const e=new je;return new MutationObserver(t=>{const i=this.getMutatedElements(t,"addedNodes"),r=this.getMutatedElements(t,"removedNodes");(i.length||r.length)&&e.next({mutatedElements:[...i,...r]})}).observe(document,{childList:!0,subtree:!0}),e}shouldCollectDynamicAttributes(e){return Boolean(e.component&&e.componentType)}isHidden(e){const t=this.win.win.getComputedStyle(e);return"none"===t.display||"hidden"===t.visibility||void 0===t.display}interactionEvents(){const e=this.win.doc.body,t={capture:!0,passive:!0};return It(Ar).pipe(pe(i=>Mi(e,i,t)),Dt(),pe(e=>this.processWindowEvent(e)),Z(Boolean),xr(e=>{"click"!==e.type&&"contextmenu"!==e.type||e.doNotTrack||!e.clickable||(this.lastClickSourceInformation={name:e.section.name,group:e.section.group,element:e.element,popupComponent:e.section.popupComponent,popupComponentType:e.section.popupComponentType,url:e.docURL,tab_id:Hi(this.config.eventEnrichment,"tab_id")?this.tabManagerService.getTabId():"",additionalProperties:e.additionalProperties})}))}getMutatedElements(e,t){return e.flatMap(e=>{const i=e.target;return Array.from(e[t]).map(e=>({node:e,target:i}))}).filter(({node:e})=>e instanceof HTMLElement).flatMap(e=>{const i=this.getInteractionInfoFor(e.node,e.target);let r;if(!i)return[];if(i&&(this.activityTrackerUtils.hasAttribute("pulse-component",i.element)||this.activityTrackerUtils.hasAttribute("data-pulse-component",i.element)))r=this.activityTrackerUtils.createInteractionElement(i.element);else{const e=i.element.querySelectorAll("[pulse-component], [data-pulse-component]");if(!e||!e[0])return[];r=this.activityTrackerUtils.createInteractionElement(e[0])}const s=r.attributeValueByName["pulse-component"]||r.attributeValueByName["data-pulse-component"],n=r.attributeValueByName["pulse-component-type"]||r.attributeValueByName["data-pulse-component-type"];if("addedNodes"===t&&this.isHidden(i.element))return[];const o=this.shouldCollectDynamicAttributes({component:s,componentType:n})?this.activityTrackerUtils.collectDynamicAttributes(i.element):void 0;return{element:r,component:s,componentType:n||s,mutationType:t,section:this.activityTrackerUtils.createSection(i.section,i.sectionGroup),additionalProperties:o&&Object.keys(o).length>0?o:void 0}})}processWindowEvent(e){if(!e.target)return null;const t=this.getInteractionInfoFor(e.target);if(!t)return null;const i=this.activityTrackerUtils.collectDynamicAttributes(t.element),r=this.win.doc;return{type:e.type,trusted:e.isTrusted??!0,eventPhase:e.eventPhase,bubbles:e.bubbles,section:this.activityTrackerUtils.createSection(t.section,t.sectionGroup,t.popupComponent,Object.keys(i).length>0?i:void 0),element:this.activityTrackerUtils.createInteractionElement(t.element),docFocused:r.hasFocus(),docVisible:this.visibilityTracker.visible,docURL:r.location.href,doNotTrack:t.doNotTrack,clickable:t.clickable,ts:Date.now(),additionalProperties:Object.keys(i).length>0?i:void 0}}getInteractionInfoFor(e,t){const i=this.win.doc,r=e instanceof Node&&e!==i&&e!==i.head?e:i.documentElement;let s=this.activityTrackerUtils.getFirstParentElement(r);if(!s)return;const n=this.activityTrackerUtils.getTargetType(r),o=t instanceof Element?t.closest("[pulse-section]")||t.closest("[data-pulse-section]"):void 0,a=t instanceof Element?t.closest("[pulse-section-group]")||t.closest("[data-pulse-section-group]"):void 0,c=o||s.closest("[pulse-section]")||s.closest("[data-pulse-section]")||void 0,u=s.closest("[pulse-component]")||s.closest("[data-pulse-component]")||void 0,h=a||s.closest("[pulse-section-group]")||s.closest("[data-pulse-section-group]")||void 0,l=this.activityTrackerUtils.clickableTarget(s);s=l||s;const d=Boolean(s.closest("[pulse-dnt]"))||Boolean(s.closest("[data-pulse-dnt]"));return{clickable:Boolean(l),doNotTrack:Boolean(d),type:n,element:s,section:c,sectionGroup:h,popupComponent:u}}}class Or{tabInfoService;tabStorage;activitySyncService;tabManager;date;env;config;opener=null;firstNavigationKey="first_navigation";firstNavigation=!0;constructor(e,t,i,r,s,n,o){this.tabInfoService=e,this.tabStorage=t,this.activitySyncService=i,this.tabManager=r,this.date=s,this.env=n,this.config=o}getOpener(e=!1){const t=this.opener||this.fetchOpener(),i=this.tabStorage.getJSON(this.firstNavigationKey),r=void 0===i?.firstNavigation;this.firstNavigation=r,this.tabStorage.setJSON(this.firstNavigationKey,{firstNavigation:!1,lastNavigationCount:i?.lastNavigationCount||0,lastNavigationUrl:e&&r?this.env.win.location.href:i?.lastNavigationUrl||""});const s="number"!=typeof this.env.win.history?.length||1===this.env.win.history.length,n=this.env.win.history.length>1&&r,o=n?5e3:0,a=s?this.config.tabOpenerDetectionTimeWindow:Math.max(o,Math.min(1e3,this.config.tabOpenerDetectionTimeWindow/2)),c=s?ir.NoVisibility:ir.Focus;if(t?.id)return t;let u,h=null;this.env.win.opener&&(h=this.tabManager.getSiblingTabId({win:this.env.win.opener})),u=h?this.tabInfoService.fetchSiblingTabs(h):this.tabInfoService.fetchSiblingTabs();const l=u.map(e=>{const t=this.activitySyncService.getTabEvents(e.id)||[];return{tabId:e.id,events:t}}),d=this.detectOpener(this.env.win.document.referrer,l,a,c,n);this.setOpener({id:d?.tabId||h,type:d?.type,url:d?.eventUrl,name:d?.section.name,group:d?.section.group,element:d?.element,popupComponent:d?.section?.popupComponent,popupComponentType:d?.section?.popupComponentType,additionalProperties:d?.additionalProperties});return d?.tabId?{id:d?.tabId,type:d?.type,url:d?.eventUrl,name:d?.section.name,group:d?.section.group,element:d?.element,popupComponent:d?.section?.popupComponent,popupComponentType:d?.section?.popupComponentType,additionalProperties:d?.additionalProperties}:null}isFirstNavigation(){return this.firstNavigation}getTriggerEvent(e=!1){if(!Hi(this.config.eventEnrichment,"tab_id"))return null;const t=this.tabStorage.getJSON(this.firstNavigationKey),i=void 0===t?.firstNavigation,r=t?.lastNavigationCount||0;this.tabStorage.setJSON(this.firstNavigationKey,{firstNavigation:!1,lastNavigationCount:this.env.win.history.length,lastNavigationUrl:this.env.win.location.href}),this.firstNavigation=i;const s=this.env.win.history.length-r>1&&!i,n=s?5e3:e?3500:500,o=ir.NoVisibility,a=t?.lastNavigationUrl||this.env.win.document.referrer,c=this.tabInfoService.getCurrentTab(),u=this.activitySyncService.getTabEvents(c.id)||[],h=this.detectTriggerEvent(a,u,n,o,s,c.id);return h?{id:h?.tabId,type:h?.type,url:h?.eventUrl,name:h?.section.name,group:h?.section.group,popupComponent:h?.section?.popupComponent,popupComponentType:h?.section?.popupComponentType,element:h?.element,additionalProperties:h?.additionalProperties}:null}fetchOpener(){return this.opener=this.tabStorage.getJSON("tab_opener"),this.opener}detectOpener(e,t,i,r,s){const n=this.createDetectorEvents(e,t).filter(e=>e.timeDiff<=i);if(!n.length)return null;for(let t=1;t<=r;t++){const i=this.filterAccuracyMatches(n,e,t,s);if(i.length&&(t<ir.NoVisibility||1===this.countTabs(i)))return i[0]||null}return null}detectTriggerEvent(e,t,i,r,s,n){const o=this.ctreateTriggerEvents(e,t,n).filter(e=>e.timeDiff<=i);if(!o.length)return null;for(let t=1;t<=r;t++){const i=this.filterAccuracyMatches(o,e,t,s);if(i.length&&t<ir.NoVisibility)return i[0]||null}return null}setOpener(e){return this.opener=e,this.tabStorage.setJSON("tab_opener",this.opener)}filterAccuracyMatches(e,t,i,r){switch(i){case ir.LinkInteraction:return this.filterLinkInteractionEvents(e,t);case ir.Link:return this.filterLinkEvents(e,t);case ir.Interaction:return this.filterInteractionEvents(e,t);case ir.Focus:return this.filterFocusedEvents(e,t,r);case ir.Visibility:return this.filterVisibleEvents(e,t);case ir.NoVisibility:default:return this.filterNoVisibility(e,t)}}filterLinkInteractionEvents(e,t){return e.filter(e=>(!t||e.docURL.startsWith(t))&&this.isLinkMatch(e)&&this.isInteractionEvent(e)&&e.docFocused&&e.docVisible)}filterLinkEvents(e,t){return e.filter(e=>(!t||e.docURL.startsWith(t))&&this.isLinkMatch(e)&&e.docFocused&&e.docVisible)}filterInteractionEvents(e,t){return e.filter(e=>(!t||e.docURL.startsWith(t))&&this.isInteractionEvent(e)&&e.docFocused&&e.docVisible)}filterFocusedEvents(e,t,i){return e.filter(e=>i?e.docFocused&&e.docVisible:(!t||e.docURL.startsWith(t))&&e.docFocused&&e.docVisible)}filterVisibleEvents(e,t){return e.filter(e=>(!t||e.docURL.startsWith(t))&&e.docVisible)}filterNoVisibility(e,t){return e.filter(e=>!t||e.docURL.startsWith(t))}isLinkMatch(e){if(e.element&&"A"===e.element.nodeName){const t=e.element.attributes.find(e=>"href"===e.name)?.value;return t===this.config.initialDocURL}return!1}isInteractionEvent(e){return-1!==Pr.indexOf(e.type)}countTabs(e){return new Set(e.map(e=>e.tabId)).size}createDetectorEvents(e,t){const i=this.date.hrtTimeOrigin-2,r=[];for(const s of t){const t=s.events.map(t=>({...t,tabId:s.tabId,timeDiff:Math.abs(i-t.ts),referrerMatch:!e||t.docURL.startsWith(e),eventUrl:t.docURL}));r.push(...t)}return r.sort((e,t)=>e.timeDiff>t.timeDiff?1:e.timeDiff<t.timeDiff?-1:0)}ctreateTriggerEvents(e,t,i){const r=this.date.now()-2;let s=[];return s=t.map(t=>({...t,tabId:i,timeDiff:Math.abs(r-t.ts),referrerMatch:!e||t.docURL.startsWith(e),eventUrl:t.docURL})),s.sort((e,t)=>e.timeDiff>t.timeDiff?1:e.timeDiff<t.timeDiff?-1:0)}}class Rr{pulseStorage;config;stateService;infected=[];newExperimentTrigger$=new K;constructor(e,t,i){this.pulseStorage=e,this.config=t,this.stateService=i,this.infected=this.getInfectedFromStorage(),this.stateService.setState({infected:this.infected}),this.pulseStorage.change(this.config.experimentStorageKey,Ue.Full,$e.All).subscribe(e=>{e.value&&(this.newExperimentTrigger$.next(!0),this.infected=this.getInfectedFromStorage(),this.infected&&this.infected.length?this.stateService.setState({infected:this.infected}):this.stateService.removePropertyFromState("infected"))})}getInfected(){return this.infected}getInfectedFromStorage(){const e=this.pulseStorage.getJSON(this.config.experimentStorageKey);return e?e?.filter(e=>e.participation_date&&e.trackable).map(e=>({id:e.name,variant:e.variant,participation_timestamp:e.participation_date,participation_session:e.participation_session})):[]}}class Lr{indexedDBService;quote;deviceIdService;dateService;attributesStorageKey="attributesStore";constructor(e,t,i,r){this.indexedDBService=e,this.quote=t,this.deviceIdService=i,this.dateService=r,e.connectDB()}async getCachedAttributes(){const e=await this.indexedDBService.getValue(this.attributesStorageKey,"attributes");if(null!=e)return e}async getCachedHints(){const e=await this.indexedDBService.getValue(this.attributesStorageKey,"hints");if(null!=e)return e}async cacheAttributes(e,t=!1){const i=await this.quote.quoteSize(),r=(new TextEncoder).encode(JSON.stringify({id:"attributes",attributes:e,attributesSent:!1,did:this.deviceIdService.getDeviceId(),time:this.dateService.now()})).length;i&&i-r>1e6||null===i?await this.indexedDBService.putValue(this.attributesStorageKey,{id:"attributes",attributes:e,attributesSent:t,did:this.deviceIdService.getDeviceId(),time:this.dateService.now()}):console.error("There is no enough space to store attributes")}async cacheHints(e,t=!1){const i=await this.quote.quoteSize(),r=(new TextEncoder).encode(JSON.stringify({id:"hints",hints:e,hintsSent:!1,did:this.deviceIdService.getDeviceId(),time:this.dateService.now()})).length;i&&i-r>1e6||null===i?await this.indexedDBService.putValue(this.attributesStorageKey,{id:"hints",hints:e,hintsSent:t,did:this.deviceIdService.getDeviceId(),time:this.dateService.now()}):console.error("There is no enough space to store attributes")}async markSent(e){if("hints"===e){const e=await this.getCachedHints();e&&this.cacheHints(e.hints,!0)}if("attributes"===e){const e=await this.getCachedAttributes();e&&this.cacheAttributes(e.attributes,!0)}}}class Dr{env;constructor(e){this.env=e}getHardwareInfo(){const{navigator:e}=this.env.win,t=this.getGPU();return{device_memory:e.deviceMemory||void 0,cpus:e.hardwareConcurrency||void 0,gpu_vendor:t?.vendor,gpu_renderer:t?.renderer}}getScreenInfo(){const e=this.env.win,t=e.screen;return{touch:e.navigator.maxTouchPoints>0||e.navigator.msMaxTouchPoints>0||"ontouchstart"in navigator,resolution_x:t.width,resolution_y:t.height,available_resolution_x:t.availWidth,available_resolution_y:t.availHeight,pixel_ratio:e.devicePixelRatio,pixel_depth:t.pixelDepth}}getNavigatorInfo(){const e=this.env.win.navigator;let t=e.language||e.languages[0]||"unknown";return t=(t.split("-").shift()??"").trim()||"unknown",{device_language_code:t,browser_platform:e.userAgentData?.platform??e.platform??"unknown",browser_vendor:this.getBrowserBrand(e)}}getUserAgent(){return this.env.win.navigator.userAgent}getBrowserBrand(e){return e.userAgentData?.brands?.[0]?.brand||e.userAgent||"unknown"}getGPU(){const e=this.env.win.document.createElement("canvas");try{const t=e.getContext("webgl")||e.getContext("experimental-webgl"),i=t?.getExtension("WEBGL_debug_renderer_info");if(!i)return;const r=t.getParameter(i.UNMASKED_VENDOR_WEBGL),s=t.getParameter(i.UNMASKED_RENDERER_WEBGL);if(r||s)return{vendor:r,renderer:s}}catch(e){console.warn(e)}}}class Mr{deviceInfoService;utmService;storage;date;config;sessionService;batchQueue;env;KEY_LAST_ATTRIBUTE_SYNC="attr";queueState;constructor(e,t,i,r,s,n,o,a){this.deviceInfoService=e,this.utmService=t,this.storage=i,this.date=r,this.config=s,this.sessionService=n,this.batchQueue=o,this.env=a,this.sessionService.newSessionGenerated$.subscribe(e=>{this.date.now()-e<100&&this.send(!0)})}async send(e=!1){const t=this.getHints(),i=this.getDeviceAttributes(),r=this.utmService.getUTMParams();(this.shouldSendHintsOld()||e)&&(this.env.win.dataLayer?.push({pulse:"attribute_hints",user_agent:t}),r?this.env.win.dataLayer?.push({pulse:"attribute",...r,...i}):this.env.win.dataLayer?.push({pulse:"attribute",...i}),this.queueState=this.batchQueue.queueEmpty$.subscribe(()=>{this.sent()}))}getDeviceAttributes(){return{...this.deviceInfoService.getScreenInfo(),...this.deviceInfoService.getHardwareInfo(),...this.deviceInfoService.getNavigatorInfo(),pa_open_time:Math.round(this.getOpenTime()/1e3)}}getHints(){return this.deviceInfoService.getUserAgent()}shouldSendHintsOld(){const e=Number(this.storage.get(this.KEY_LAST_ATTRIBUTE_SYNC)||"0");return this.date.now()-e>this.config.attributeSyncIntervalMS}sent(){this.queueState?.unsubscribe(),this.storage.set(this.KEY_LAST_ATTRIBUTE_SYNC,this.date.now().toString())}getOpenTime(){const e=this.sessionService.getSession().sessionId.match(/^(\d+)_.*$/);let t=this.date.now();return e&&(t=Number(e[1])),t}}class $r{persistentStorage;activityTracker;date;config;pageEvents=[];constructor(e,t,i,r){this.persistentStorage=e,this.activityTracker=t,this.date=i,this.config=r,this.persistentStorage.freeSpace$.subscribe(()=>{this.clearClosedTabsActivity()})}startService(e){this.activityTracker.interactions().subscribe(t=>{const i=this.date.now();this.pageEvents.push(t),this.pageEvents=this.pageEvents.slice(this.pageEvents.length-100).filter(e=>i-e.ts<=this.config.tabOpenerDetectionTimeWindow),this.pageEvents.length?this.persistentStorage.setJSON(`tab_activity_${e}`,this.pageEvents):this.remove(e)}),this.clearClosedTabsActivity()}getTabEvents(e){return this.persistentStorage.getJSON(`tab_activity_${e}`)}remove(e){this.persistentStorage.remove(`tab_activity_${e}`)}clearClosedTabsActivity(){const e=this.fetchOpenTabIds();this.persistentStorage.keys().filter(e=>e.startsWith("tab_activity_")).filter(t=>{const i=this.getTabEvents(t.replace("tab_activity_",""))?.map(e=>e.ts).reduce((e,t)=>Math.max(e,t));return!i||(this.date.now()-i>this.config.tabOpenerDetectionTimeWindow+5e3||-1===e.indexOf(t.replace("tab_activity_","")))}).map(e=>this.persistentStorage.remove(e))}fetchOpenTabIds(){return this.persistentStorage.keys().filter(e=>e.startsWith("tab_info_")).map(e=>e.replace("tab_info_",""))}}class Ur{persistentStorage;visibilityService;activityTracker;activitySynchronizer;date;config;tabId;unloaded=!1;persisted=!1;lastActivity;constructor(e,t,i,r,s,n){this.persistentStorage=e,this.visibilityService=t,this.activityTracker=i,this.activitySynchronizer=r,this.date=s,this.config=n;const o=s.now();this.lastActivity=o,this.persistentStorage.freeSpace$.subscribe(()=>{this.cleanup()})}startService(e){this.tabId=e,this.setupActivityTracker(),this.updateTabInfo(),this.cleanup()}fetchSiblingTabs(e=""){if(!Hi(this.config.eventEnrichment,"tab_id"))return[];if(!this.tabId)throw new Error("Tab identifier is not available!");const t=this.tabId;return this.persistentStorage.keys().filter(i=>i.startsWith(`tab_info_${e}`)&&-1===i.indexOf(t)).map(e=>this.persistentStorage.getJSON(e)).filter(Boolean)}getCurrentTab(){if(!this.tabId)throw new Error("Tab identifier is not available!");return{id:this.tabId,lastActivity:this.lastActivity,persisted:this.persisted,unloaded:this.unloaded,visible:this.visibilityService.visible}}updateTabInfo(){const e=this.getCurrentTab();this.persistentStorage.setJSON(`tab_info_${e.id}`,e)}cleanup(){const e=this.date.now(),t=this.fetchSiblingTabs().filter(t=>e-t.lastActivity>this.config.tabOpenerDetectionTimeWindow);for(const e of t)this.persistentStorage.remove(`tab_info_${e.id}`),this.activitySynchronizer.remove(e.id)}setupActivityTracker(){this.visibilityService.legacyPageHide().subscribe(e=>{this.unloaded=!0,this.persisted=e.persisted,this.updateTabInfo()}),this.visibilityService.legacyOnUnload().subscribe(()=>{this.unloaded=!0,this.updateTabInfo()}),this.activityTracker.interactions().subscribe(()=>{this.lastActivity=this.date.now(),this.updateTabInfo()})}}class Br{debug;debugControl;config;deviceIdService;constructor(e,t,i,r){this.debug=e,this.debugControl=t,this.config=i,this.deviceIdService=r}displayControl(){this.debugControl.registerControl({control:"debug",content:"Debug mode is enabled",title:"",url:"https://picsart.tools/organization/picsart/app/picsart-website/debugger",deviceId:this.deviceIdService.getDeviceId(),callbackFn:this.disableDebugMode.bind(this)})}disableDebugMode(){this.debugControl.unregisterControl("debug"),this.debug.disable("debugger"),this.debug.disable(this.config.debugLiveEventKey)}}class jr{static commandMap=new Map([["event","event"],["send","event"],["set","set"],["state","set"]])}class Fr extends jr{plugins;pipes;logger;defaultPipes;queue;sessionService;tabManagerService;date;config;stateService;batchQueue;constructor(e,t,i,r,s,n,o,a,c,u,h){super(),this.plugins=e,this.pipes=t,this.logger=i,this.defaultPipes=r,this.queue=s,this.sessionService=n,this.tabManagerService=o,this.date=a,this.config=c,this.stateService=u,this.batchQueue=h;const l=this.getContext();e.init(l)}event(e,t=Zi.Normal){this.events([e],t)}events(e,t=Zi.Normal){this.processMessages("event",e,t)}attribute(e,t=Zi.Normal){this.attributes([e],t)}attributes(e,t=Zi.Normal){this.processMessages("attribute",e,t)}attributeHint(e,t=Zi.Normal){this.processMessages("attribute-hint",[e],t)}set(e){if("object"!=typeof e||!e||Array.isArray(e))return;const t={...e};delete t.language_code,this.stateService.setState(t)}state(e){this.set(e)}stateData(e){const t=this.stateService.getStateInternal().data;this.stateService.setState({data:{...t,...e}})}getState(){return this.stateService.getState()}cmd(e,...t){if(Array.isArray(e))return this.cmd(e[0],...e.slice(1));const i=e.split("."),r=this[Fr.commandMap.get(i[1]||i[0]||"")||i[0]||""];"function"==typeof r?r.apply(this,t):this.logger.warn("Tracker",`Pulse command '${e}' not found!`)}flush(){this.queue.flush()}getContext(){return{config:this.config,session:this.sessionService.getSession(),tracker:this}}getTabId(){return this.tabManagerService.getTabId()}queueEmpty(){return this.batchQueue.getQueueEmpty$()}processMessages(e,t,i){const r=this.getContext(),s=t.map(t=>{let s;try{s=hi(t)}catch(e){console.error("The event provided has an incorrect schema.",e)}return{type:e,data:s,priority:i,state:r.session.state,timestamp:this.date.now()}}),n=s.flatMap(e=>this.pipes.transform(e,r).map(e=>this.defaultPipes.transform(e,r)).flat().map(e=>this.defaultPipes.enrich(e,r)).map(e=>this.pipes.enrich(e,r)));this.queue.push(...n)}}function Hr(e,t){return Y(function(i,r){var s=null,n=0,o=!1,a=function(){return o&&!s&&r.complete()};i.subscribe(Q(r,function(i){null==s||s.unsubscribe();var o=0,c=n++;he(e(i,c)).subscribe(s=Q(r,function(e){return r.next(t?t(i,e,c,o++):e)},function(){s=null,a()}))},function(){o=!0,a()}))})}function Vr(e,t){return void 0===e&&(e=0),void 0===t&&(t=Yt),e<0&&(e=0),function(e,t,i){void 0===e&&(e=0),void 0===i&&(i=Qt);var r=-1;return null!=t&&(Pt(t)?i=t:r=t),new H(function(t){var s=Xt(e)?+e-i.now():e;s<0&&(s=0);var n=0;return i.schedule(function(){t.closed||(t.next(n++),0<=r?this.schedule(void 0,r):t.complete())},s)})}(e,e,t)}function qr(e){return function(e){let t=e.length;for(let i=e.length-1;i>=0;i--){const r=e.charCodeAt(i);r>127&&r<=2047?t++:r>2047&&r<=65535&&(t+=2),r>=56320&&r<=57343&&i--}return t}(JSON.stringify(e))}function Kr(e,t){const i=[...e],r=[];let s=0;for(let e=0;e<i.length;e++){const n=Gr([i[e]],t),o=qr({chunks:n});if(o>6e4){r.push({chunks:n,keepAlive:!1,size:o}),i.splice(e,1),e-=1;continue}const a=Gr(i.slice(s,e+1),t),c=qr(a),u={chunks:a,keepAlive:!0,size:c};c>6e4?(zr(i.slice(s,e),r,t),s=e,e===i.length-1&&zr(i.slice(s,e+1),r,t)):e===i.length-1&&r.push(u)}return r}function zr(e,t,i){const r=Gr(e,i),s={chunks:r,keepAlive:!0,size:qr(r)};t.push(s)}function Gr(e,t){const i=new Map;for(const t of e){let e=i.get(t.state);e||(e=[],i.set(t.state,e)),e.push(t)}return Array.from(i).map(e=>{const i=[],r=[];let s;return e[1].map(e=>{switch(e.type){case"event":i.push(e.data);break;case"attribute":r.push(e.data);break;case"attribute-hint":s=e.data}}),{config:t,header:e[0],events:i,attributes:r,attributeHints:s}})}function Jr(e,t=!0){const i=Hi(e.stateEnrichment,"device_id"),r=Hi(e.stateEnrichment,"session_id"),s=Hi(e.eventEnrichment,"tab_id"),n=!!t&&e.serverCookies;return{deviceId:i?e.sessionStorageType:"none",sessionId:r?e.sessionStorageType:"none",tabId:s?e.tabManagerStorageType:"none",serverCookies:n}}class Wr{consentService;config;batchQueue;visibility;queueEmpty$;trackingEnabled;batchConfig;messageReceived=new K;flushRequested=new K;constructor(e,t,i,r){this.consentService=e,this.config=t,this.batchQueue=i,this.visibility=r,this.queueEmpty$=i.queueEmpty$,this.batchConfig=Jr(this.config,this.trackingEnabled),this.consentService.trackingEnabled().subscribe(e=>{this.trackingEnabled=e,this.batchConfig=Jr(this.config,this.trackingEnabled)}),this.visibility.onVisibilityChange().subscribe(async e=>{!e&&this.trackingEnabled?(this.flush(),this.batchQueue.stopQueue()):e&&this.trackingEnabled&&this.batchQueue.startQueue()}),this.start()}push(...e){const t=e.some(e=>e.priority===Zi.Force),i=e.some(e=>e.priority===Zi.High)||t;(this.trackingEnabled||t)&&(e.forEach(e=>this.messageReceived.next(e)),(i&&this.trackingEnabled||t)&&this.flushRequested.next())}flush(){this.flushRequested.next()}start(){const e=new K,t=e.pipe($t({}),Hr(()=>Vr(this.config.batchTimeMS))),i=new G(0),r=new K;i.pipe(Z(e=>e===this.config.batchSize+1)).subscribe(()=>{r.next()});const s=Ot([t,r,this.flushRequested]);var n;It(this.messageReceived).pipe(xr(()=>i.next(i.value+1)),(n=s,Y(function(e,t){var i=[];return e.subscribe(Q(t,function(e){return i.push(e)},function(){t.next(i),t.complete()})),he(n).subscribe(Q(t,function(){var e=i;i=[],t.next(e)},I)),function(){i=null}}))).subscribe(t=>{i.next(0),e.next(),this.pushToBatchQueue(t)}),i.next(0),r.next(),this.flushRequested.next(),e.next()}pushToBatchQueue(e){const t=Kr(e,this.batchConfig);t.length&&t.map(e=>this.batchQueue.pushBatch(e))}}class Yr{storage;lockManager;uuid;visibility;consentService;transport;config;batchQueue=[];sendingBatches=[];trackingEnabled;currentRequestSize=0;beaconLimit=6e4;queueProcessor=null;STORED_BATECHES_KEY="pulse-unpublished-events";batchConfig;queueEmpty$=new K;constructor(e,t,i,r,s,n,o){this.storage=e,this.lockManager=t,this.uuid=i,this.visibility=r,this.consentService=s,this.transport=n,this.config=o,this.trackingEnabled&&this.queueStoredMessagesIfAny(),this.listenAndQueueOnStoreChanges(),this.consentService.trackingEnabled().subscribe(e=>{this.trackingEnabled=e,this.batchConfig=Jr(this.config,this.trackingEnabled)}),this.batchConfig=Jr(this.config,this.trackingEnabled)}pushBatch(e){const t=this.uuid.generate();this.visibility.visible?(this.batchQueue.push({batch:e,batchId:t}),this.queueProcessor||this.controlQueueProcessor()):(this.storeBatches([{batch:e,batchId:t}]),this.clearQueue(),this.sendStoredBatches())}startQueue(){this.queueStoredMessagesIfAny(),this.batchQueue.length&&!this.queueProcessor&&this.controlQueueProcessor()}getQueueEmpty$(){return this.queueEmpty$}async stopQueue(){if(this.stopQueueProcessor(),this.batchQueue.length){const e=this.batchQueue[0].batch.size||0;(!this.currentRequestSize||this.currentRequestSize+e<this.beaconLimit)&&(this.currentRequestSize=this.currentRequestSize+e,this.sendBatch(this.batchQueue[0].batch,this.batchQueue[0].batchId).then(e=>this.handleResponse(e)).catch(e=>{console.error(e)}),this.sendingBatches.push(this.batchQueue[0]),this.batchQueue.splice(0,1))}this.storeBatches([...this.batchQueue]),this.clearQueue(),await Ke(500),this.sendStoredBatches()}async queueStoredMessagesIfAny(){if(await this.lockManager.locked(this.STORED_BATECHES_KEY))return void this.postpone(this.queueStoredMessagesIfAny);const e=await this.lockManager.request(this.STORED_BATECHES_KEY,6e3);if(!e)return void this.postpone(this.queueStoredMessagesIfAny);const t=this.storage.getJSON(this.STORED_BATECHES_KEY)||[];if(this.storage.remove(this.STORED_BATECHES_KEY),this.lockManager.release(e),t.length){if("batchId"in t[0])t.forEach(e=>{this.batchQueue.some(t=>t.batchId===e.batchId)||this.batchQueue.push(e)});else{Kr(t,this.batchConfig).forEach(e=>this.pushBatch(e))}this.batchQueue.length&&!this.queueProcessor&&this.controlQueueProcessor()}}listenAndQueueOnStoreChanges(){this.storage.change(this.STORED_BATECHES_KEY).subscribe(async()=>{this.queueStoredMessagesIfAny()})}storeBatches(e){const t=this.storage.getJSON(this.STORED_BATECHES_KEY)||[],i=e||[];this.storage.set(this.STORED_BATECHES_KEY,JSON.stringify([...t,...this.batchQueue,...i,...this.sendingBatches]))}clearQueue(){this.batchQueue=[]}controlQueueProcessor(){this.queueProcessor||(this.queueProcessor=setInterval(()=>{if(this.batchQueue.length||this.sendingBatches.length||(this.queueEmpty$.next(!0),this.currentRequestSize=0),0===this.batchQueue.length&&this.queueProcessor)return void this.stopQueueProcessor();const e=this.batchQueue[0].batch.size||0;if(!this.currentRequestSize||this.currentRequestSize+e<this.beaconLimit){this.currentRequestSize+=e;const t=this.batchQueue.shift();t&&(this.sendingBatches.push(t),this.sendBatch(t.batch,t.batchId).then(e=>this.handleResponse(e)).catch(e=>console.error(e))),0===this.batchQueue.length&&this.queueProcessor&&(this.sendingBatches.length||this.queueEmpty$.next(!0),this.stopQueueProcessor(),this.queueProcessor=null)}},100))}stopQueueProcessor(){this.queueProcessor&&(clearInterval(this.queueProcessor),this.queueProcessor=null)}handleResponse({size:e,batchId:t}){this.currentRequestSize-=e;const i=this.sendingBatches.findIndex(e=>e.batchId===t);-1!==i&&this.sendingBatches.splice(i,1),this.sendingBatches.length||this.batchQueue.length||this.queueEmpty$.next(!0)}sendBatch(e,t){return new Promise(i=>{const r=Boolean(e.keepAlive);delete e.keepAlive,this.transport.send(e,r,i,t)})}async sendStoredBatches(){if(await Ke(1e3),this.visibility.visible)return;if(await this.lockManager.locked(this.STORED_BATECHES_KEY))return void this.postpone(this.sendStoredBatches);const e=await this.lockManager.request(this.STORED_BATECHES_KEY,6e3);if(!e)return void this.postpone(this.sendStoredBatches);const t=this.storage.getJSON(this.STORED_BATECHES_KEY)||[];if(!t.length)return void this.lockManager.release(e);const i=t.splice(0,1);this.storage.set(this.STORED_BATECHES_KEY,JSON.stringify([...t])),this.lockManager.release(e),this.sendBatch(i[0].batch,i[0].batchId).then(()=>{this.visibility.visible||this.sendStoredBatches()}).catch(e=>{console.error(e)})}postpone(e,t=1e3,i){setTimeout(()=>{e.call(this,i)},t)}}class Qr{attributeSpreadPipe;actionParamEventPipe;navigationEventPipe;changedAttributesPipe;eventGlobalsPipe;sourcePipe;pipesHost;defaultPipesHost;config;constructor(e,t,i,r,s,n,o,a,c){this.attributeSpreadPipe=e,this.actionParamEventPipe=t,this.navigationEventPipe=i,this.changedAttributesPipe=r,this.eventGlobalsPipe=s,this.sourcePipe=n,this.pipesHost=o,this.defaultPipesHost=a,this.config=c}registerPipes(){const e=this.config.transformPipes||[],t=this.config.enrichmentPipes||[],i=[{selector:"attribute",use:[this.attributeSpreadPipe,this.changedAttributesPipe]},{selector:"event",use:[this.actionParamEventPipe,this.navigationEventPipe]}],r=[{selector:"event",use:[this.eventGlobalsPipe,this.sourcePipe]}];i.forEach(e=>this.defaultPipesHost.registerTransformSet(e)),r.forEach(e=>this.defaultPipesHost.registerEnrichmentSet(e)),e.forEach(e=>this.pipesHost.registerTransformSet(e)),t.forEach(e=>this.pipesHost.registerEnrichmentSet(e))}}var Xr;!function(e){e[e.Visible=0]="Visible",e[e.Hidden=1]="Hidden"}(Xr||(Xr={}));class Zr{visibility;visibilityState=Xr.Visible;constructor(e){this.visibility=e}init(){this.visibility.onVisibilityChange().subscribe(e=>{this.visibilityState=e?Xr.Visible:Xr.Hidden})}}class es{dataLayer;commandPrefix;visibilityChangePlugin;defaultPush;tracker;constructor(e,t,i){this.dataLayer=e,this.commandPrefix=t,this.visibilityChangePlugin=i}init(e){if(this.tracker=e.tracker,!Array.isArray(this.dataLayer))throw new Error("DataLayer must be an array!");this.defaultPush=this.dataLayer.push.bind(this.dataLayer),this.dataLayer.push=this.onPush.bind(this),this.readFromBeginning()}onPush(...e){for(const t of e)this.processItem(t);return this.defaultPush?this.defaultPush(...e):0}readFromBeginning(){for(const e of this.dataLayer)this.processItem(e)}processItem(e){if(!this.tracker||"object"!=typeof e||!e)return;const t=e;if(this.isCommand(e)){const t=Array.from(e);this.tracker.cmd(t)}else if("event"===e.pulse){let i;e.event_priority&&(i=e.event_priority,delete t.event_priority);const r=this.normalize(e);this.tracker.event(r,i||(this.visibilityChangePlugin.visibilityState===Xr.Hidden?Zi.High:Zi.Normal))}else if("attribute"===e.pulse){const t=this.normalize(e);this.tracker.attribute(t)}else if("attribute_hints"===e.pulse){const t=this.normalize(e);this.tracker.attributeHint(t)}else if("state"===e.pulse){const t=this.normalize(e);this.tracker.set(t)}else if("custom_event"===t.event||"custom_event_non_interaction"===t.event){const e=t.event_priority;t.event_priority&&delete t.event_priority,this.tracker.event(t.data,2===e?Zi.High:Zi.Normal)}}isCommand(e){return(Array.isArray(e)||"[object Arguments]"===Object.prototype.toString.call(e))&&"string"==typeof e[0]&&e[0].startsWith(this.commandPrefix)}normalize(e){const t={...e};return delete t.paa,t.pulse&&delete t.pulse,t}}class ts{sessionStartPlugin;navigationEventPlugin;infectedPlugin;visibilityChangePlugin;clickEventPlugin;tabLinkingPlugin;statePlugin;deviceAttributesPlugin;consentEventPlugin;pluginHost;config;facebookPixelAttributePlugin;popupEventPlugin;contextMenuPlugin;internalDataLayer;debugEventPlugin;dataLayer;constructor(e,t,i,r,s,n,o,a,c,u,h,l,d,p,g,f,v){this.sessionStartPlugin=e,this.navigationEventPlugin=t,this.infectedPlugin=i,this.visibilityChangePlugin=r,this.clickEventPlugin=s,this.tabLinkingPlugin=n,this.statePlugin=o,this.deviceAttributesPlugin=a,this.consentEventPlugin=c,this.pluginHost=u,this.config=h,this.facebookPixelAttributePlugin=l,this.popupEventPlugin=d,this.contextMenuPlugin=p,this.internalDataLayer=g,this.debugEventPlugin=f,this.dataLayer=v}registerPlugins(){const e=[this.visibilityChangePlugin,this.debugEventPlugin,this.clickEventPlugin,this.tabLinkingPlugin,this.statePlugin,this.sessionStartPlugin,this.navigationEventPlugin,this.infectedPlugin,this.deviceAttributesPlugin,this.consentEventPlugin,this.facebookPixelAttributePlugin,this.popupEventPlugin,this.contextMenuPlugin,...this.config.plugins||[]];this.dataLayer&&e.push(new es(this.dataLayer,"paa.",this.visibilityChangePlugin)),this.internalDataLayer&&Array.isArray(this.internalDataLayer)&&e.push(new es(this.internalDataLayer,"",this.visibilityChangePlugin)),e.forEach(e=>this.pluginHost.register(e))}}const is=new me("INTERNAL_DATA_LAYER"),rs=new me("DATA_LAYER"),ss=new me("DEFAULT_PIPES_HOST_TOKEN"),ns=new me("PIPES_HOST_TOKEN");const os={...fe,sessionTimeoutMS:18e5,attributeTimeoutMS:6048e5,attributeSyncIntervalMS:864e5,plugins:[],transformPipes:[],enrichmentPipes:[],consentChecks:[],serverCookies:!0,sessionStorageType:"persistent",attributesStorageType:"persistent",tabManagerStorageType:"tab",debug:[],debugClear:!1,debugLiveEventKey:"debug-leuid",customerID:"",batchTimeMS:500,batchSize:100,serverBaseURL:"https://t.picsart.com/events/v2/web",stateEnrichment:!0,attributeHints:!0,storagePrefix:"paa_",tabOpenerDetectionTimeWindow:6e3,rumUnsafeRequestBodyMeasure:!0,rumReportOnce:[],rumReport:[],dataLayerKey:"dataLayer"};const as=(new ke).provide(function(e){return e.useFactory(at,e=>e,[ye]).useFactory(rs,(e,t)=>e.win[t.dataLayerKey],[be,at]).useFactory(is,e=>e.win.pulse?.q,[be]).useFactory(Sr,(e,t,i)=>{const r=t.isMetaInfoInLocalStorage()?i:e;return new Sr(r)},[Ae,Oi,Ne]).useClass(wr,wr,[Sr,Ci,Je,at]).useClass(_r,_r,[it,Ze]).useFactory(Er,(e,t,i,r,s,n,o,a,c)=>new Er(e,t(s.sessionStorageType),i,r,s,n,o,a,c,$e.All),[De,xe,qe,Je,at,Fe,Tr,Oi,We]).useClass(kr,kr,[Tr,at,ze]).useFactory(Ir,async(e,t,i,r)=>new Ir(e,t(i.tabManagerStorageType),r),[be,xe,at,De]).useClass(Br,Br,[Tr,tt,at,Fe]).useFactory(Tr,(e,t)=>new Tr(e(t.sessionStorageType),t),[xe,at]).useFactory(Cr,(e,t)=>new Cr(e,t),[Or,be]).useClass(Wr,Wr,[wr,at,Yr,zi]).useFactory(Rr,(e,t,i)=>new Rr(e("persistent"),t,i),[xe,at,We]).useClass(Lr,Lr,[ve,Qe,Fe,De]).useClass(Dr,Dr,[be]).useFactory(Yr,(e,t,i,r,s,n,o)=>new Yr(e("persistent"),t,i,r,s,n,o),[xe,Oe,Ti,zi,wr,kr,at]).useFactory(Mr,(e,t,i,r,s,n,o,a)=>new Mr(e,t,i("persistent"),r,s,n,o,a),[Dr,it,xe,De,at,Er,Yr,be]).useClass(Wi,Wi,[]).useClass(ns,Yi,[]).useClass(ss,Yi,[]).useClass(Qi,Qi,[]).useClass(Xi,Xi,[]).useClass(rr,rr,[Ze]).useClass(sr,sr,[Je,at]).useClass(nr,nr,[Ir,Vi,Ze,at,Or,Ti,Oi]).useClass(or,or,[_r,at]).useClass(ar,ar,[zi]).useClass(fr,fr,[Nr,be]).useClass(yr,yr,[$r,Ur,Vi,at]).useClass(cr,cr,[Ir,Cr,Er,wr]).useClass(br,br,[Rr]).useClass(ur,ur,[Er,Rr,Tr,at,Dr,We,Ye]).useClass(ar,ar,[zi]).useClass(hr,hr,[Nr,be]).useClass(lr,lr,[Mr]).useClass(dr,dr,[wr,Er,Mr,be]).useClass(pr,pr,[Ae,Je,Mr,be]).useClass(gr,gr,[Je,qe,Er,be,Oi]).useClass(vr,vr,[Nr,be]).useClass(mr,mr,[Tr,be,Br,at,et,Oi]).useClass(ts,ts,[gr,cr,br,ar,fr,yr,ur,lr,dr,Wi,at,pr,hr,vr,is,mr,rs]).useClass(Qr,Qr,[Qi,Xi,rr,sr,nr,or,ns,ss,at]).useFactory(Ur,(e,t,i,r,s,n)=>new Ur(e(n.sessionStorageType),t,i,r,s,n),[xe,zi,Nr,$r,De,at]).useFactory(Or,(e,t,i,r,s,n,o)=>new Or(e,t(o.tabManagerStorageType),i,r,s,n,o),[Ur,xe,$r,Vi,De,be,at]).useFactory($r,(e,t,i,r)=>new $r(e("persistent"),t,i,r),[xe,Nr,De,at]).useClass(Nr,Nr,[zi,be,Vi,at,Gi]).useFactory(Fr,(e,t,i,r,s,n,o,a,c,u,h,l,d)=>{c.registerPipes(),u.registerPlugins();return new Fr(e,t,r,i,s,n,h,o,a,l,d)},[Wi,ns,ss,Ci,Wr,Er,De,at,Qr,ts,Vi,We,Yr])}).beforeInit(function(e){const t={...os,...e};return"standard"!==t.mode&&(t.sessionStorageType="memory",t.attributesStorageType="memory",t.tabManagerStorageType="memory",t.trafficSourceDetectorStorageType="memory",t.eventEnrichment={tab_id:!1,legacy_source:!1,referrer:!1},t.stateEnrichment={device_id:!1,session_id:"page-session"===t.mode,market:!0,platform:!0},t.attributeHints=!1,t.serverCookies=!1),t}).onInit(async(e,t,i)=>{await s(i.win,!0)&&await t.connectDB()},[ve,be]);function cs(e){if("string"!=typeof e)throw new Error("Invalid input. Input must be a string");const t=e.match(/(\/?)(.+)\1([a-z]*)/i);return t?t[3]&&!/^(?!.*?(.).*?\1)[gmixXsuUAJ]+$/.test(t[3])?RegExp(e):new RegExp(t[2],t[3]):null}class us{value;optimized;constructor(e,t){this.value=e,this.optimized=t}toString(){return this.value}}class hs{cssPath(e,t=!1){try{if(e.nodeType!==Node.ELEMENT_NODE)return"";const i=[];let r=e;for(;r;){const s=this.createStep(r,Boolean(t),r===e);if(!s)break;if(i.push(s),s?.optimized)break;r=r.parentNode}return i.reverse(),i.join(" > ")}catch(e){return console.error(e),""}}createStep(e,t,i){if(e.nodeType!==Node.ELEMENT_NODE)return null;const r=e.getAttribute("id");if(t){if(r)return new us(this.idSelector(r),!0);const t=e.nodeName.toLowerCase();if("body"===t||"head"===t||"html"===t)return new us(e.nodeName.toLowerCase(),!0)}const s=e.nodeName.toLowerCase();if(r)return new us(s.toLowerCase()+this.idSelector(r),!0);const n=e.parentNode;if(!n||n.nodeType===Node.DOCUMENT_NODE)return new us(s.toLowerCase(),!0);const o=this.prefixedElementClassNames(e),a=n.children;let c=!1,u=!1,h=-1;for(let t=0;(-1===h||!u)&&t<a.length;++t){const i=a[t];if(i===e){h=t;continue}if(u)continue;if(i?.nodeName.toLowerCase()!==s.toLowerCase())continue;c=!0;const r=o;let n=0;for(const e in r)++n;if(0===n){u=!0;continue}const l=this.prefixedElementClassNames(i);for(const e of l)if(!r.indexOf(e)&&(delete r[e],! --n)){u=!0;break}}let l=s.toLowerCase();if(i&&"input"===s.toLowerCase()&&e.getAttribute("type")&&!e.getAttribute("id")&&!e.getAttribute("class")&&(l+='[type="'+e.getAttribute("type")+'"]'),u)l+=":nth-child("+(h+1)+")";else if(c)for(const e in o)l+="."+this.escapeIdentifierIfNeeded(o[e]?.substr(1)||"");return new us(l,!1)}prefixedElementClassNames(e){const t=e.getAttribute("class");return t?t.split(/\s+/g).filter(Boolean).map(e=>"$"+e):[]}idSelector(e){return"#"+this.escapeIdentifierIfNeeded(e)}escapeIdentifierIfNeeded(e){if(this.isCSSIdentifier(e))return e;const t=/^(?:[0-9]|-[0-9-]?)/.test(e),i=e.length-1;return e.replace(/./g,(e,r)=>t&&0===r||!this.isCSSIdentChar(e)?this.escapeAsciiChar(e,r===i):e)}escapeAsciiChar(e,t){return"\\"+this.toHexByte(e)+(t?"":" ")}toHexByte(e){let t=e.charCodeAt(0).toString(16);return 1===t.length&&(t="0"+t),t}isCSSIdentChar(e){return!!/[a-zA-Z0-9_-]/.test(e)||e.charCodeAt(0)>=160}isCSSIdentifier(e){return/^-?[a-zA-Z_][a-zA-Z0-9_-]*$/.test(e)}}class ls{}class ds extends ls{transformPipes=[];enrichmentPipes=[];process(e,t){return this.transform(e,t).map(e=>this.enrich(e,t))}transform(e,t){const i=this.selectPipeSet(e,this.transformPipes);let r=[e];for(const e of i){if(!e.transform)continue;const i=[];for(const s of r){const r=e.transform(s,t);i.push(...r)}r=i}return r}enrich(e,t){return this.selectPipeSet(e,this.enrichmentPipes).reverse().reduce((e,i)=>i.enrich(e,t),e)}registerTransformSet(e){this.transformPipes.push(e)}registerEnrichmentSet(e){this.enrichmentPipes.push(e)}selectPipeSet(e,t){for(const i of t){if(!("*"===i.selector||i.selector===e.type||"function"==typeof i.selector&&i.selector(e)||!1))continue;if(!("function"==typeof i.exclude&&i.exclude(e)))return[...i.use]}return[]}}class ps{rum;env;constructor(e,t){this.rum=e,this.env=t}init(e){this.rum.subscribe(e.config.rumReport,e.config.rumReportOnce).subscribe(e=>{this.env.win.dataLayer?.push({pulse:"event",event:"rum",data:e})})}}function gs(){return new J}function fs(e,t){var i=arguments.length>=2;return function(r){return r.pipe(e?Z(function(t,i){return e(t,i,r)}):j,Kt(1),i?function(e){return Y(function(t,i){var r=!1;t.subscribe(Q(i,function(e){r=!0,i.next(e)},function(){r||i.next(e),i.complete()}))})}(t):(void 0===(s=function(){return new J})&&(s=gs),Y(function(e,t){var i=!1;e.subscribe(Q(t,function(e){i=!0,t.next(e)},function(){return i?t.complete():t.error(s())}))})));var s}}function vs(e,t){const i="string"==typeof t?t:t?.entryType,r=e.entry_type===i,s=function(e,t){if("string"==typeof t)return!0;if(void 0===t.name)return!0;if(Array.isArray(t.name))return t.name.some(t=>t instanceof RegExp?t.test(e):t===e);return!1}(e.name,t),n="object"!=typeof t||"function"!=typeof t.filter||t.filter(e);return r&&s&&n}class bs{timeline;resource;constructor(e,t){this.timeline=e,this.resource=t}subscribe(e,t){const i=[...e,...t||[]],r=i.some(e=>"resource"===e||"object"==typeof e&&"resource"===e.entryType),s=qi(r?this.resource.subscribe(i):It([]),this.timeline.subscribe(i).pipe(Z(e=>"resource"!==e.entry_type))),n=s.pipe(Z(e=>!t||t.every(t=>!vs(e,t))));return qi(It(t||[]).pipe(Hr(e=>s.pipe(Z(t=>vs(t,e)),fs()))),n).pipe(pe(e=>this.enrichWithServerAttributes(e)))}enrichWithServerAttributes(e){if(Array.isArray(e.server_timing)){const t=[...e.server_timing],i={};for(const r of e.server_timing){const e=/^pulse\$([^$]+)\$([^$]+)$/.exec(r.name);if(!e?.length)continue;const s=(e[1]||"").toLowerCase(),n=(e[2]||"").toLowerCase();i[s]=n,t.splice(t.indexOf(r),1)}e.server_timing=t,e.server_attributes=i}return e}}class ms{env;cssPathService;date;firstPageHide;constructor(e,t,i,r){this.env=e,this.cssPathService=t,this.date=i,r.visible||(this.firstPageHide=i.hrtTimeOrigin),r.onVisibilityChange().pipe(Z(e=>!e),fs()).subscribe(()=>{this.firstPageHide=i.hrt()})}subscribe(e,t=!0){return qi(...e.filter(e=>this.entrySupported(e)).map(e=>this.getFilterStream(e,t)))}getEntries(e){return qi(...e.filter(e=>this.entrySupported(e)).map(e=>this.getFilterStream(e,!1,!0)))}getFilterStream(e,t,i){const r=this.env.win;return r.performance.getEntries&&r.performance.getEntriesByType&&r.performance.timeOrigin?i?this.readEntries(e):"function"==typeof r.PerformanceObserver&&r.WeakSet?this.getFilterStreamNative(e,t):this.getFilterStreamLegacy(e,t):It([])}readEntries(e){const t="string"==typeof e?e:e.entryType,i=new WeakSet;return It(this.env.win.performance.getEntriesByType(t)).pipe(Z(e=>!i.has(e)),xr(e=>i.add(e)),pe(e=>this.mapEntry(e)),Z(t=>vs(t,e)))}getFilterStreamNative(e,t){return new H(i=>{const r=new WeakSet,s=new this.env.win.PerformanceObserver(t=>{const s=t.getEntries();for(const t of s){if(r.has(t))continue;r.add(t);const s=this.mapEntry(t);vs(s,e)&&i.next(s)}}),n="string"==typeof e?e:e?.entryType;return s.observe({type:n,buffered:t}),()=>s.disconnect()})}getFilterStreamLegacy(e,t){return new H(i=>{const r=this.env.win.performance,s="string"==typeof e?e:e?.entryType;let n=t?0:r.now();const o=setInterval(()=>{const t=this.env.win.performance.getEntriesByType(s);let r=n;for(const s of t){const t=this.mapEntry(s);r<s.startTime&&(r=s.startTime),s.startTime<n||vs(t,e)&&i.next(t)}n=r},1e3);return()=>clearInterval(o)})}mapEntry(e){const t=this.env.win.navigator.connection,i="xmlhttprequest"===(String(e.initiatorType)+"").toLowerCase()?"xhr":String(e.initiatorType);let r={time_origin:this.date.hrtTimeOrigin,details:e.detail,name:e.name,entry_type:e.entryType,type:e.type,protocol:e.nextHopProtocol||void 0,task_duration:e.duration,start_time:e.startTime,end_time:e.responseEnd??(e.duration?e.startTime+e.duration:void 0),initiator_type:i,worker_start:e.workerStart,redirect_start:e.redirectStart,redirect_end:e.redirectEnd,fetch_start:e.fetchStart,domain_lookup_start:e.domainLookupStart,domain_lookup_end:e.domainLookupEnd,connect_start:e.connectStart,connect_end:e.connectEnd,secure_connection_start:e.secureConnectionStart,request_start:e.requestStart,response_start:e.responseStart,response_end:e.responseEnd,transfer_size:e.transferSize,encoded_body_size:e.encodedBodySize,decoded_body_size:e.decodedBodySize,unload_event_start:e.unloadEventStart,unload_event_end:e.unloadEventEnd,dom_interactive:e.domInteractive,dom_content_loaded_event_start:e.domContentLoadedEventStart,dom_content_loaded_event_end:e.domContentLoadedEventEnd,dom_complete:e.domComplete,load_event_start:e.loadEventStart,load_event_end:e.loadEventEnd,redirect_count:e.redirectCount,processing_start:e.processingStart,processing_end:e.processingEnd,cancelable:e.cancelable,render_blocking:e.renderBlockingStatus?"blocking"===e.renderBlockingStatus:void 0,had_recent_input:e.hadRecentInput,last_input_time:e.lastInputTime,cls_value:e.value,before_page_hide:this.beforePageHide(e.startTime)};return Array.isArray(e.serverTiming)&&e.serverTiming.length&&(r.server_timing=e.serverTiming),Array.isArray(e.workerTiming)&&e.workerTiming.length&&(r.worker_timing=e.workerTiming),!t||"resource"!==r.entry_type&&"navigation"!==r.entry_type||(r={...r,connection_downlink:t.downlink,connection_rtt:t.rtt,connection_type:t.effectiveType,data_saving_mode:t.saveData}),Array.isArray(e.attribution)&&(r.attribution=e.attribution.map(e=>({name:e?.name,entry_type:e?.entryType,start_time:e?.startTime,duration:e?.duration,container_type:e?.containerType,container_src:e?.containerSrc,container_id:e?.containerId,container_name:e?.containerName}))),"layout-shift"===r.entry_type&&Array.isArray(e.sources)&&(r.cls_sources=e.sources.map(e=>this.createCLSAttribution(e)).filter(Boolean)),r}beforePageHide(e){return!this.firstPageHide||(e?e<this.firstPageHide:void 0)}entrySupported(e){const t=this.env.win.PerformanceObserver?.supportedEntryTypes||[],i="string"==typeof e?e:e.entryType;return t.indexOf(i)>-1}createCLSAttribution(e){if("object"!=typeof e||"object"!=typeof e.node)return null;const t=e.node,i={current_rect:e.currentRect,previous_rect:e.previousRect};if(t){const e=this.cssPathService.cssPath(t);i.node={path:e}}return i}}class ys{fetchCollector;xhrCollector;timeline;date;env;performanceTimeline;constructor(e,t,i,r,s){this.fetchCollector=e,this.xhrCollector=t,this.timeline=i,this.date=r,this.env=s;const n=new je(1e3);this.performanceTimeline=n,this.timeline.subscribe(["resource"]).subscribe(n)}subscribe(e){const t=this.date.hrt(),i=qi(this.fetchCollector.requests(),this.xhrCollector.requests()).pipe(Hr(e=>this.findEntry(e)));return qi(this.performanceTimeline.pipe(Z(e=>"fetch"!==e.initiator_type&&"xhr"!==e.initiator_type||e.start_time<=t),pe(e=>({entry:e}))),i).pipe(pe(e=>this.mergeRequestEntry(e)),Z(Boolean),Z(t=>!e||e.some(e=>vs(t,e))))}mergeRequestEntry(e){const t=e.request,i=Boolean(t)&&void 0!==t&&("basic"===t.responseMode||"cors"===t.responseMode||"default"===t.responseMode);let r=e.entry;if(r)r.response_entry_matched=Boolean(t);else{if(!t)return null;const e=this.env.win.navigator.connection;r={name:t.url,entry_type:"resource",initiator_type:t.initiator,start_time:t.start,end_time:t.end,task_duration:(t.fetchEnd||t.end)-t.start,time_origin:this.date.hrtTimeOrigin,response_entry_matched:!1},i&&(r.decoded_body_size=t.responseBodySize,r.transfer_size=t.responseBodySize),e&&(r={...r,connection_downlink:e.downlink,connection_rtt:e.rtt,connection_type:e.effectiveType,data_saving_mode:e.saveData})}return t&&this.enrichWithRequest(r,t,i),r}enrichWithRequest(e,t,i){e.request_method=t.method,e.response_status=t.responseStatus,e.response_mode=t.responseMode,e.request_body_size=t.requestBodySize,e.response_end=e.response_end||t.fetchEnd||t.end,e.end_time=t.end,e.user_duration=t.end-t.start,e.response_content_type=t.responseContentType,e.request_content_type=t.requestContentType,e.redirected=t.redirected,e.aborted=t.aborted,i&&(e.transfer_size=e.transfer_size||t.responseBodySize,e.response_body_size=t.responseBodySize,e.decoded_body_size=t.responseBodySize,e.transfer_size=t.responseBodySize)}findEntry(e){return this.performanceTimeline.pipe(Z(e=>"fetch"===e.initiator_type||"xhr"===e.initiator_type),Z(t=>this.matchLax(e,t)),fs(),pe(t=>({entry:t,request:e})))}matchLax(e,t){const i=t.start_time,r=t.task_duration?t.start_time+t.task_duration:t.response_end||0;return i>=e.start-1&&r<=e.end+1&&e.url===t.name}}const Ss=new Set(["plain/text","text/html","text/css","text/xml","text/csv","text/javascript","application/json","application/ld+json","application/xml","application/xhtml+xml","application/atom+xml","application/javascript","application/x-javascript","image/svg+xml"]),ws=new Set(["font/woff2","font/ttf","image/gif","image/png","image/jpg","image/jpeg","image/webp","image/bmp"]),_s=new Set([...Ss.values(),...ws.values()]);function Es(e,t){try{return new URL("string"==typeof e?e:e.href,t.win.location.href).href}catch(t){return"string"==typeof e?e:"object"==typeof e&&e.href?e.href:void console.warn(t)}}function Ts(e){if(e)return e.toLowerCase().split(";").map(e=>e.trim())[0]}function ks(e,t){try{if(null==e||""===e)return 0;if("string"==typeof e)return new t.Blob([e]).size;if(e instanceof t.Blob)return e.size;if((e instanceof t.ArrayBuffer||t.ArrayBuffer.isView(e))&&"number"==typeof e.byteLength)return e.byteLength;if(e instanceof t.URLSearchParams)return ks(e.toString(),t);if("object"==typeof e)return ks(JSON.stringify(e),t)}catch{}}function Is(e,t,i,r){if(t?.body&&!function(e,t){return"ReadableStream"in t&&e instanceof t.ReadableStream}(t.body,r.win)){const i=new _e;try{const e=ks(t.body,r.win);i.resolve({size:e,start:-1,end:-1,cancelled:!1})}catch(e){i.reject(e)}return{wrappedRequest:new Request(e,t),bodyStats:i.waitUntilResolved()}}if("object"==typeof e&&e.body instanceof ReadableStream){const{wrappedStream:s,complete:n}=function(e,t,i){const r=new _e,s=new _e;let n=-1;const o=new i.ReadableStream({start(r){n=t.hrt();const o=e.getReader();let a=0;o.read().then(({done:e,value:o})=>{if(e){const e=t.hrt();return s.resolve({start:n,end:e,size:a,cancelled:!1}),void r.close()}try{a+=ks(o,i)??0}catch(e){console.error(e)}r.enqueue(o)}).catch(e=>{s.reject(e),r.error(e)})},cancel(i){e.cancel(i);const r=t.hrt();s.resolve({start:n,end:r,cancelled:!0})}});return{started:r.waitUntilResolved(),complete:s.waitUntilResolved(),wrappedStream:o}}(e.body,i,r.win),o={cache:e?.cache,credentials:e?.credentials,headers:e?.headers,integrity:e?.integrity,keepalive:e?.keepalive,method:e?.method,mode:e?.mode,redirect:e?.redirect,referrer:e?.referrer,referrerPolicy:e?.referrerPolicy,signal:e?.signal,...t||{},body:s};return{wrappedRequest:new Request(e,o),bodyStats:n}}return{wrappedRequest:new Request(e,t),bodyStats:Promise.resolve(void 0)}}class Cs{date;env;reportStream=new K;patched=!1;constructor(e,t){this.date=e,this.env=t}requests(){return this.patchFetch(),this.reportStream.asObservable()}supported(){return"ReadableStream"in this.env.win&&"ArrayBuffer"in this.env.win&&"Request"in this.env.win&&"Response"in this.env.win&&"function"==typeof this.env.win.fetch}patchFetch(){if(this.patched||!this.supported())return;const e=this.env.win,t=e.fetch.bind(e);this.env.win.fetch=async(e,i)=>this.monitoredFetch(e,i,t),this.patched=!0}async monitoredFetch(e,t,i){const r={url:"",method:"",start:0,fetchEnd:0,end:0,responseStatus:0,initiator:"fetch"};let s,n,o;try{s=Is(e,t,this.date,this.env),r.url=Es(s.wrappedRequest.url,this.env)||"",r.method=s.wrappedRequest.method.toUpperCase(),s.bodyStats.then(e=>{r.requestBodySize=e?.size}).catch(e=>{console.error(e)}),s.wrappedRequest.signal?.addEventListener("abort",()=>{r.aborted=!0}),r.start=this.date.hrt(),n=await i(s.wrappedRequest),r.fetchEnd=this.date.hrt();try{r.responseBodySize=n.headers.has("content-length")?Number(n.headers.get("content-length")):void 0;("basic"===n.type||"cors"===n.type||"default"===n.type)&&r.responseContentType&&!Number.isSafeInteger(r.responseBodySize)&&_s.has(r.responseContentType)&&(o=n.clone())}catch{}return n}finally{r.fetchEnd=n?r.fetchEnd:this.date.hrt(),Ke(0).then(()=>this.reportResponse(n,o,r)).catch(e=>console.error(e))}}async reportResponse(e,t,i){if(i){if(e)try{const r=e.headers?.get("content-type");if(i.responseContentType=Ts(r),i.redirected=e.redirected,i.responseMode=e.type,i.responseStatus=e.status,!Number.isSafeInteger(i.responseBodySize)&&t)try{const e=await t.blob();i.responseBodySize=e.size}catch{}}catch{}i.end=this.date.hrt(),this.reportStream.next(i)}}}function xs(e,t){if(!t||!e)return!1;if(Ss.has(t))return!0;if(ws.has(t))try{return e instanceof Blob||e instanceof ArrayBuffer}catch(e){console.error(e)}return!1}function Ps(e,t){const i=new K;function r(r){if(r.___pulse)return r.___pulse;const s={requestHeaders:new Headers,hasError:!1};return r.___pulse=s,r.addEventListener("error",()=>{s.hasError=!0}),r.addEventListener("timeout",()=>{s.hasError=!0,s.aborted=!0}),r.addEventListener("loadend",n=>{s.end=e.hrt(),Ke(0).then(()=>function(r,s,n){const o=Ts(s.requestHeaders.get("content-type"));let a,c,u;xs(s.requestBody,o)&&(a=ks(s.requestBody,t.win));let h={url:s.url,method:s.method,start:s.start,fetchEnd:s.end,end:s.end,aborted:Boolean(s.aborted),requestBodySize:a,requestContentType:o,responseStatus:r.status,initiator:"xhr"};if(s.hasError)i.next(h);else{try{u=Ts(r.getResponseHeader("content-type"))}catch(e){console.error(e)}if(n.lengthComputable&&"number"==typeof n.total)c=n.total;else try{const e=Number(r.getResponseHeader("content-length"));Number.isSafeInteger(e)&&(h.responseBodySize=e)}catch(e){console.error(e)}"number"!=typeof h.responseBodySize&&xs(r.response,u)&&(c=ks(r.response,t.win)),h={...h,responseBodySize:c,responseContentType:u,end:e.hrt()},i.next(h)}}(r,s,n)).catch(e=>console.error(e))}),s}function s(e,t){const i=XMLHttpRequest.prototype[e];"function"==typeof i&&(XMLHttpRequest.prototype[e]=function(...e){const s=this,n=r(s);return t(s,n,i.bind(s),...e)})}return s("setRequestHeader",(e,t,i,...r)=>{const[s,n]=r;try{t.requestHeaders.set(s,n)}catch(e){console.error(e)}i.apply(e,r)}),s("open",(e,i,r,...s)=>{const[n,o]=s;r.apply(e,s),i.method=n,i.url=Es(o,t)||""}),s("send",(t,i,r,...s)=>{i.start=e.hrt(),r.apply(t,s)}),s("abort",(e,t,i)=>{t.aborted=!0,i.apply(e)}),i.asObservable()}class As{date;env;stream;constructor(e,t){this.date=e,this.env=t}requests(){return this.stream||(this.stream=Ps(this.date,this.env)),this.stream}}class Ns{value;optimized;constructor(e,t=!1){this.value=e,this.optimized=t}toString(){return this.value}}class Os{xPath(e,t){if(e.nodeType===Node.DOCUMENT_NODE)return"/";const i=[];let r=e;for(;r;){const e=this.xPathValue(r,t);if(!e)break;if(i.push(e),e.optimized)break;r=r.parentNode}return i.reverse(),(i.length&&i[0]?.optimized?"":"/")+i.join("/")}xPathValue(e,t){const i=this.xPathIndex(e);let r;if(-1===i)return null;switch(e.nodeType){case Node.ELEMENT_NODE:{const i=e;if(t&&i.getAttribute("id"))return new Ns('//*[@id="'+i.getAttribute("id")+'"]',!0);r=i.localName;break}case Node.ATTRIBUTE_NODE:r="@"+e.nodeName;break;case Node.TEXT_NODE:case Node.CDATA_SECTION_NODE:r="text()";break;case Node.PROCESSING_INSTRUCTION_NODE:r="processing-instruction()";break;case Node.COMMENT_NODE:r="comment()";break;case Node.DOCUMENT_NODE:default:r=""}return i>0&&(r+="["+i+"]"),new Ns(r,e.nodeType===Node.DOCUMENT_NODE)}xPathIndex(e){const t=e.parentNode?e.parentNode.children:null;if(!t)return 0;let i=!1;for(const r of t)if(this.areNodesSimilar(e,r)&&r!==e){i=!0;break}if(!i)return 0;let r=1;for(const i of t)if(this.areNodesSimilar(e,i)){if(i===e)return r;++r}return-1}areNodesSimilar(e,t){if(e===t)return!0;if(e.nodeType===Node.ELEMENT_NODE&&t.nodeType===Node.ELEMENT_NODE)return e.localName===t.localName;if(e.nodeType===t.nodeType)return!0;return(e.nodeType===Node.CDATA_SECTION_NODE?Node.TEXT_NODE:e.nodeType)===(t.nodeType===Node.CDATA_SECTION_NODE?Node.TEXT_NODE:t.nodeType)}}class Rs{pipesHost;config;constructor(e,t){this.pipesHost=e,this.config=t}registerPipes(){const e=this.config.transformPipes||[],t=this.config.enrichmentPipes||[];e.forEach(e=>this.pipesHost.registerTransformSet(e)),t.forEach(e=>this.pipesHost.registerEnrichmentSet(e))}}class Ls{visibilityChangePlugin;config;rumPlugin;pluginHost;constructor(e,t,i,r){this.visibilityChangePlugin=e,this.config=t,this.rumPlugin=i,this.pluginHost=r}registerPlugins(){[this.visibilityChangePlugin,this.rumPlugin,...this.config.plugins||[]].forEach(e=>this.pluginHost.register(e))}}const Ds=new me("INTERNAL_DATA_LAYER"),Ms=new me("DATA_LAYER"),$s=new me("DEFAULT_PIPES_HOST_TOKEN"),Us=new me("PIPES_HOST_TOKEN");const Bs={...fe,plugins:[],transformPipes:[],enrichmentPipes:[],sessionStorageType:"persistent",tabManagerStorageType:"tab",debug:[],storagePrefix:"paa_",tabOpenerDetectionTimeWindow:6e3,rumUnsafeRequestBodyMeasure:!0,rumReportOnce:[],rumReport:[],dataLayerKey:"dataLayer"};function js(e){for(const t of e)if("object"==typeof t&&Array.isArray(t.name))for(let e=0;e<t.name.length;e++){const i=t.name[e];if("string"==typeof i&&i.startsWith("/")){const r=cs(i);r instanceof RegExp&&(t.name[e]=r)}}}const Fs=(new ke).provide(function(e){return e.useFactory(ot,e=>e,[ye]).useFactory(Ms,(e,t)=>e.win[t.dataLayerKey],[be,ot]).useFactory(Ds,e=>e.win.pulse?.q,[be]).useClass(Wi,Wi,[]).useClass(Us,ds,[]).useClass($s,ds,[]).useClass(Zr,Zr,[zi]).useClass(bs,bs,[ms,ys]).useClass(ys,ys,[Cs,As,ms,De,be]).useClass(hs,hs,[]).useClass(ms,ms,[be,hs,De,zi]).useClass(Cs,Cs,[De,be]).useClass(As,As,[De,be]).useClass(Ls,Ls,[Zr,ot,ps,Wi]).useClass(Os,Os,[]).useClass(Rs,Rs,[Us,ot])}).beforeInit(function(e){const t={...Bs,...e};return function(e){e.rumReport=e.rumReport||[],e.rumReportOnce=e.rumReportOnce||[],js(e.rumReport),js(e.rumReportOnce)}(t),t});function Hs(){return function(){const e=("object"==typeof globalThis?globalThis:{}).__pulseAsyncContextStore;return e?.getStore()}()??globalThis.pulse?.?.i}async function Vs(){const e=Hs();if(e)return e;if(!globalThis.pulse.)throw new Error("Pulse sdk is not initialized!");return new Promise(e=>{globalThis.pulse..ready.push(t=>e(t))})}function qs(e){return async function(...t){const i=await Vs();return i[e].apply(i,t)}}function Ks(e={},t={}){const i=function(){if(we()){const e=globalThis?.navigator,t=e?.connection||e?.mozConnection||e?.webkitConnection;let i=1e4;switch(t?.effectiveType){case"slow 2g":case"slow-2g":i=6e4;break;case"2g":i=3e4;break;case"3g":i=15e3;break;case"4g":i=5e3}return(e?.userAgentData?.mobile??(e?.maxTouchPoints>0||globalThis?.document&&"ontouchstart"in globalThis.document.documentElement))&&(i=Math.min(2*i,6e4)),i}return 6e3}(),r=qs("get"),s=qs("segments"),n=qs("experiments"),o=qs("stateData"),a=(c="observe",function(...e){const t=new K;return Vs().then(function(i){i[c].apply(i,e).subscribe(t)}),t.asObservable()});var c;return Object.keys(t).length>0&&o({...Object.fromEntries(Object.entries(t).map(([e,t])=>[`attr_${e}`,t]))}),{get(s,n,o){const a=new AbortController;return Promise.race([r(s,n,o??e[s],t).then(e=>(a.abort(),e)),Ke(i,a.signal).then(()=>o)])},observe(e,r,s){const n=a(e,r,s,t);return new H(e=>{const t=n.pipe(Kt(1),ti(i),de(()=>ri(s))),r=n.pipe(si(1)),o=t.pipe(ni(e=>r.pipe($t(e)))).subscribe(e);return()=>o.unsubscribe()})},segments(){const e=new AbortController;return Promise.race([s(t).then(t=>(e.abort(),t)),Ke(i,e.signal).then(()=>[])])},experiments(){const e=new AbortController;return Promise.race([n(t).then(t=>(e.abort(),t)),Ke(i,e.signal).then(()=>[])])}}}function zs(e){return{pulseInit:[],ready:[],idu:globalThis.location?.href,c:e}}function Gs(e){const t=globalThis.pulse?.,i=t||zs(e);return Object.assign(async function(){const e=arguments,t=await Vs();"function"!=typeof e[0]?t.cmd.apply(t,e):e[0](t)},Ks(e?.defaults,e?.attributes),{event:qs("event"),events:qs("events"),attribute:qs("attribute"),attributes:qs("attributes"),set:qs("set"),state:qs("state"),stateData:qs("stateData"),getState:qs("getState"),flush:qs("flush"),cmd:qs("cmd"),queueEmpty:(r="queueEmpty",function(...e){const t=new K;return Vs().then(function(i){i[r].apply(i,e).subscribe(t)}),t})},{getStateString:qs("getStateString")},{:i});var r}const Js=(new ke).provide(function(e){return e.useFactory(rt,e=>e,[ye]).useClass(ct,ct,[])}).beforeInit(function(e){const t={...ge,...e};return"standard"!==t.mode&&(t.hashStoreStorageType="memory"),t});function Ws(e){return e?Object.getOwnPropertyNames(e).filter(t=>"function"==typeof e[t]&&"constructor"!==t):[]}function Ys(e,t){const{settingsMethods:i,trackerMethods:r}=function(e,t){return{settingsMethods:Ws(Object.getPrototypeOf(e)),trackerMethods:Ws(Object.getPrototypeOf(t))}}(e,t);const s=function(){t.cmd(arguments)};for(const t of i)s[t]=e[t].bind(e);for(const e of r)s[e]=t[e].bind(t);return s.settings=e,s.tracker=t,s}const Qs=window,Xs=Qs.pulseInit||[],Zs=Qs.pulseReady||[];Qs.pulseInit=Xs,Qs.pulseReady=Zs;const en=Xs.push.bind(Xs),tn=Zs.push.bind(Zs);function rn(...e){for(const t of e)Qs.pulse?.tracker||Qs.pulse?.settingsFactory?t.onReady():(en(t),tn(t));return Xs.length}function sn(e,t){if(t)return void console.warn(t,e);const i=Xs,r=Zs;for(const e of i)Xs.splice(Xs.indexOf(e),1),e.onReady();for(const e of r)Zs.splice(Zs.indexOf(e),1),e.onReady()}Xs.push=rn,Zs.push=rn;const nn=function(){const e=globalThis?.location?.host;if(/(localhost|127\.0\.0\.1):9000/.test(e))return"https://ap-worker-dev.picsart-8821.workers.dev";if(/pulse-react-demo\.stage\.picsart\.tools/.test(e)||/dev-portal\.picsart\.tools/.test(e)||/localhost:3000/.test(e))return"https://ap-worker-stage.picsart-8821.workers.dev";if(/([^.]+\.)*picsartstage2\.com/.test(e)||/([^.]+\.)+sdk\.picsart\.io/.test(e)||/([^.]+\.)+admaker\.pages\.dev(:\d+)?/.test(e)||/^https?:\/\/tools-preprod\.picsart\.com(:\d+)?/i.test(e)||/localhost/.test(e)||/127\.0\.0\.1/.test(e))return"https://ap-worker-stage.picsart-8821.workers.dev";return"https://ap-worker.optifyr.com"}();let on=null;function an(e,t){window.autopilot=window.autopilot||{},window.autopilotOptions=window.autopilotOptions||{},e.get("autopilot","autopilot_config").then(e=>{!0!==e?.tracking_enabled||function(){const e=document.querySelectorAll("script[src]");return Array.from(e).some(e=>{const t=e.src;return t.includes("ap-worker")&&t.includes("ap/web")})}()||function(e,t){if(!e?.app)return void console.error("Autopilot: missing app property in config");const i=function(){if(on)return on;try{const e=new ArrayBuffer(8,{maxByteLength:16});e.resize(16);const t=document.createElement("script"),i="function"==typeof URL.canParse&&window.ArrayBuffer&&Boolean(e.resizable)&&16===e.byteLength&&"boolean"==typeof t.noModule;on=i?"modern":"compat"}catch{on="compat"}return on}(),r=`${nn}/ap/web/v1/sdk/${e.app}`,s=window.autopilot=window.autopilot||{},n=window.autopilotOptions||{},o="c="+encodeURIComponent(JSON.stringify(n)),a=document.createElement("script");if(a.async=!0,a.crossOrigin="anonymous",a.type="modern"===i?"module":"text/javascript",a.onerror=e=>{console.error("Autopilot: failed to load script",e)},a.src=`${r}/ap.${i}.js?${o}`,s.__)return void console.warn("Autopilot already loaded!");const c={q:[],c:{...e,...t},idu:window.location.href,t:Date.now(),v:"0.0.1",b:r,m:i};if(s.__=c,document.head.prepend(a),"modern"===i){const e=document.createElement("link");e.rel="modulepreload",e.href=`${r}/apw.${i}.js`,document.head.prepend(e)}}(t,e)}).catch(e=>{console.warn("Autopilot: error loading SDK",e)})}!async function(){if(globalThis._pulse?._initializStarted)return;globalThis._pulse=globalThis._pulse||{},globalThis._pulse._initializStarted=!0;const e={"app_version":"0","app":"picsart.com","storagePrefix":"paa_","batchTimeMS":500,"batchSize":50,"debug":[],"consentChecks":[{"type":"tracking","consent":"OneTrust","report":true,"mode":"opt-out","forceReport":true}]},t=function(e){if("object"!=typeof globalThis)throw new Error("Unsupported execution environment!");if(globalThis.pulse){if(globalThis.pulse.?.c?.app&&e?.app&&globalThis.pulse.?.c?.app!==e.app)throw new Error("Pulse is already initialized with a different app id!")}else{const t={:zs(e)};globalThis.pulse=t;const i=Gs(e);globalThis.pulse=i}return globalThis.pulse}(),i=t.,r={...e||{},...i?.c||{}||{}};globalThis.dataLayer=globalThis.dataLayer||[];const s=await(new ke).import(Js).import(Ji).import(Fs).import(as).import(vi).bootstrap(r),[n,o,a]=await Promise.all([s.get(oi),s.get(Fr),s.get(ai)]),c=Ys(n,o);var u,h;an(n,e),function(e,t,i){const r=window;r.dataLayer=r.dataLayer||[],r.pulse?(r.pulse.tracker=t,r.pulse.settings=e,r.pulse.settingsFactory=i,r.pulse._initialized=!0,sn("tracker"),sn("settings")):console.warn("Pulse is not initialized")}(n,o,a),u=i,h=c,u.ready?.forEach(e=>e(h)),u.ready?.splice(0,u.ready.length),u.ready.push=function(e){return e(h),0}}()})()})();
//# sourceMappingURL=pulse.bundle.all.esnext.e42515f1d01f941c6e2b.js.map